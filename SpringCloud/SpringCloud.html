<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>SpringCloud | winden96</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="winden96 的学习记录">
    
    <link rel="preload" href="/assets/css/0.styles.4fd6cf0c.css" as="style"><link rel="preload" href="/assets/js/app.e7c2969b.js" as="script"><link rel="preload" href="/assets/js/2.94d3dfac.js" as="script"><link rel="preload" href="/assets/js/20.2c5f040e.js" as="script"><link rel="prefetch" href="/assets/js/10.27cdeca9.js"><link rel="prefetch" href="/assets/js/11.07a9d483.js"><link rel="prefetch" href="/assets/js/12.2505f188.js"><link rel="prefetch" href="/assets/js/13.0d8bcb67.js"><link rel="prefetch" href="/assets/js/14.a1698ea2.js"><link rel="prefetch" href="/assets/js/15.dce506f4.js"><link rel="prefetch" href="/assets/js/16.82ab8250.js"><link rel="prefetch" href="/assets/js/17.1fa3722a.js"><link rel="prefetch" href="/assets/js/18.129b810d.js"><link rel="prefetch" href="/assets/js/19.7531d5a3.js"><link rel="prefetch" href="/assets/js/21.635435c4.js"><link rel="prefetch" href="/assets/js/22.a44576c7.js"><link rel="prefetch" href="/assets/js/23.32ee5f65.js"><link rel="prefetch" href="/assets/js/24.109d908c.js"><link rel="prefetch" href="/assets/js/25.9ebc3e07.js"><link rel="prefetch" href="/assets/js/26.643e2283.js"><link rel="prefetch" href="/assets/js/27.44aebb00.js"><link rel="prefetch" href="/assets/js/28.269bc50f.js"><link rel="prefetch" href="/assets/js/29.5ba9d11a.js"><link rel="prefetch" href="/assets/js/3.dc23a8fe.js"><link rel="prefetch" href="/assets/js/30.be0b3d6d.js"><link rel="prefetch" href="/assets/js/31.5c853594.js"><link rel="prefetch" href="/assets/js/32.06dd5c8a.js"><link rel="prefetch" href="/assets/js/33.66017b72.js"><link rel="prefetch" href="/assets/js/4.76c25a36.js"><link rel="prefetch" href="/assets/js/5.313f4ba0.js"><link rel="prefetch" href="/assets/js/6.3db81792.js"><link rel="prefetch" href="/assets/js/7.2b7d8442.js"><link rel="prefetch" href="/assets/js/8.19d8ddaf.js"><link rel="prefetch" href="/assets/js/9.4cbab228.js">
    <link rel="stylesheet" href="/assets/css/0.styles.4fd6cf0c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">winden96</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JUC</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JVM</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>My SQL</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Mybatis Plus</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Redis</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Spring Boot</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Spring Cloud</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/SpringCloud/SpringCloud.html" aria-current="page" class="active sidebar-link">SpringCloud</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_1-1-谈谈你对微服务的理解" class="sidebar-link">1.1 谈谈你对微服务的理解</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_1-2-spring-cloud技术栈" class="sidebar-link">1.2 Spring Cloud技术栈</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_1-3-springcloud技术选型" class="sidebar-link">1.3 springcloud技术选型</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_1-4-明细条目" class="sidebar-link">1.4 明细条目</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_2-1-工作原理" class="sidebar-link">2.1 工作原理</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_2-1-单机使用" class="sidebar-link">2.1 单机使用</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_2-2-eureka集群" class="sidebar-link">2.2 Eureka集群</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_2-3-eureka自我保护机制" class="sidebar-link">2.3 Eureka自我保护机制</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_2-4-关于eureka停更" class="sidebar-link">2.4 关于Eureka停更</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_3-1-搭建zookeeper注册中心" class="sidebar-link">3.1 搭建zookeeper注册中心</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_4-1-简介" class="sidebar-link">4.1 简介</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_4-2-功能" class="sidebar-link">4.2 功能</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_4-3-使用" class="sidebar-link">4.3 使用</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_4-4-总结" class="sidebar-link">4.4 总结</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_5-1-概念" class="sidebar-link">5.1 概念</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_5-2-lb负载均衡是什么" class="sidebar-link">5.2 LB负载均衡是什么</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_5-3-ribbon本地负载均衡客户端-vs-nginx服务端负载均衡" class="sidebar-link">5.3 Ribbon本地负载均衡客户端 VS Nginx服务端负载均衡</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_5-4-ribbon工作原理" class="sidebar-link">5.4 Ribbon工作原理</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_5-5-引入ribbon" class="sidebar-link">5.5 引入Ribbon</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_5-6-resttemplate" class="sidebar-link">5.6 RestTemplate</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_5-7-ribbon核心组件irule" class="sidebar-link">5.7 Ribbon核心组件IRule</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_5-8-手写ribbon负载均衡算法" class="sidebar-link">5.8 手写Ribbon负载均衡算法</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_6-1-概述" class="sidebar-link">6.1 概述</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_6-2-feign的作用" class="sidebar-link">6.2 Feign的作用</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_6-3-feign集成ribbon" class="sidebar-link">6.3 Feign集成Ribbon</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_6-4-feign和openfeign的区别" class="sidebar-link">6.4 Feign和OpenFeign的区别</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_6-5-openfeign使用步骤" class="sidebar-link">6.5 OpenFeign使用步骤</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_6-6-openfeign的超时控制" class="sidebar-link">6.6 OpenFeign的超时控制</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_6-7-openfeign日志打印功能" class="sidebar-link">6.7 OpenFeign日志打印功能</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_7-1-概述" class="sidebar-link">7.1 概述</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_7-2-hystrix重要概念" class="sidebar-link">7.2 Hystrix重要概念</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_7-3-hystrix案例" class="sidebar-link">7.3 Hystrix案例</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_7-4-解决方案" class="sidebar-link">7.4 解决方案</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_7-5-hystrix工作流程" class="sidebar-link">7.5 Hystrix工作流程</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_7-6-服务监控hystrixdashboard" class="sidebar-link">7.6 服务监控HystrixDashboard</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_8-1-gateway" class="sidebar-link">8.1 Gateway</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_8-2-三大核心概念" class="sidebar-link">8.2 三大核心概念</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_8-3-gateway工作流程" class="sidebar-link">8.3 Gateway工作流程</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_8-4-入门配置" class="sidebar-link">8.4 入门配置</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_8-5-通过微服务名实现动态路由" class="sidebar-link">8.5 通过微服务名实现动态路由</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_8-6-predicate的使用" class="sidebar-link">8.6 Predicate的使用</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_8-7-filter的使用" class="sidebar-link">8.7 Filter的使用</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_9-1-概述" class="sidebar-link">9.1 概述</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_9-2-config服务端配置与测试" class="sidebar-link">9.2 Config服务端配置与测试</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_9-3-config客户端配置与测试" class="sidebar-link">9.3 Config客户端配置与测试</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_9-4-存在的问题" class="sidebar-link">9.4 存在的问题</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_9-5-config客户端之动态刷新" class="sidebar-link">9.5 Config客户端之动态刷新</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_10-1-概述" class="sidebar-link">10.1 概述</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_10-2-springcloudbus动态刷新全局广播" class="sidebar-link">10.2 SpringCloudBus动态刷新全局广播</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_10-3-服务端添加消息总线" class="sidebar-link">10.3 服务端添加消息总线</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_10-4-客户端引入消息总线支持" class="sidebar-link">10.4 客户端引入消息总线支持</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_10-5-测试" class="sidebar-link">10.5 测试</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_10-6-springcloudbus动态刷新定点通知" class="sidebar-link">10.6 SpringCloudBus动态刷新定点通知</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_11-1-为什么引入消息驱动" class="sidebar-link">11.1 为什么引入消息驱动？</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_11-2-消息驱动概述" class="sidebar-link">11.2 消息驱动概述</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_11-3-案例说明" class="sidebar-link">11.3 案例说明</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_11-4-消息驱动之生产者" class="sidebar-link">11.4 消息驱动之生产者</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_11-5-消息驱动之消费者" class="sidebar-link">11.5 消息驱动之消费者</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_11-6-分组消费" class="sidebar-link">11.6 分组消费</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_11-7-消息持久化" class="sidebar-link">11.7 消息持久化</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_12-1-概述" class="sidebar-link">12.1 概述</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_12-2-搭建" class="sidebar-link">12.2 搭建</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_13-1-springcloud-alibaba简介" class="sidebar-link">13.1 SpringCloud Alibaba简介</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_13-2-nacos简介" class="sidebar-link">13.2 Nacos简介</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_13-3-nacos作为服务注册中心" class="sidebar-link">13.3 Nacos作为服务注册中心</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_13-4-nacos作为服务配置中心演示" class="sidebar-link">13.4 Nacos作为服务配置中心演示</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_13-5-nacos集群和持久化配置" class="sidebar-link">13.5 Nacos集群和持久化配置</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_14-1-sentinel" class="sidebar-link">14.1 Sentinel</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_14-2-安装sentinel控制台" class="sidebar-link">14.2 安装Sentinel控制台</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_14-3-初始化演示工程" class="sidebar-link">14.3 初始化演示工程</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_14-4-流控规则" class="sidebar-link">14.4 流控规则</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_14-5-降级规则" class="sidebar-link">14.5 降级规则</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_14-6-sentinel热点规则" class="sidebar-link">14.6 Sentinel热点规则</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_14-7-sentinel系统配置" class="sidebar-link">14.7 Sentinel系统配置</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_14-8-sentinelresource注解" class="sidebar-link">14.8 @SentinelResource注解</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_14-9-服务熔断" class="sidebar-link">14.9 服务熔断</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_14-10-feign系列" class="sidebar-link">14.10 Feign系列</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_14-11-熔断框架对比" class="sidebar-link">14.11 熔断框架对比</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_14-12-sentinel规则持久化" class="sidebar-link">14.12 Sentinel规则持久化</a></li><li class="sidebar-sub-header"><a href="/SpringCloud/SpringCloud.html#_15-1-分布式事务的业务说明" class="sidebar-link">15.1 分布式事务的业务说明</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>分布式</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>操作系统</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>杂记</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>消息中间件</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>计算机网络</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>设计模式</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_1-微服务"><a href="#_1-微服务" class="header-anchor">#</a> 1. 微服务</h1> <p>file type过滤</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/151.png" alt=""></p> <h2 id="_1-1-谈谈你对微服务的理解"><a href="#_1-1-谈谈你对微服务的理解" class="header-anchor">#</a> 1.1 谈谈你对微服务的理解</h2> <ul><li>服务注册与发现</li> <li>服务调用</li> <li>服务熔断</li> <li>负载均衡</li> <li>服务降级</li> <li>服务消息队列</li> <li>配置中心</li> <li>服务网关</li> <li>服务监控</li> <li>全链路追踪</li> <li>自动化构建部署</li> <li>服务定时任务调度操作</li></ul> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/1.png" alt=""></p> <p>分布式微服务架构的一站式解决方案，是多种微服务架构落地技术的集合体，俗称微服务全家桶</p> <p>下面一张图是京东的促销架构</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/2.png" alt=""></p> <p>阿里的架构图：</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/3.png" alt=""></p> <p>京东物流的架构图：</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/4.png" alt=""></p> <p>基础服务：</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/5.png" alt=""></p> <h2 id="_1-2-spring-cloud技术栈"><a href="#_1-2-spring-cloud技术栈" class="header-anchor">#</a> 1.2 Spring Cloud技术栈</h2> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/6.png" alt=""></p> <p>这是原来2020年以前的微服务方案</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/7.png" alt=""></p> <p>但是随着Eureka等组件的闭源，后续的一些解决方案也有了新的替换产品</p> <h2 id="_1-3-springcloud技术选型"><a href="#_1-3-springcloud技术选型" class="header-anchor">#</a> 1.3 springcloud技术选型</h2> <p>springboot 采用 A-Z一次类推的形式发布迭代版本</p> <p>SpringCloud是由许多子项目组成的综合项目，各子项目有不同的发布节奏，为了管理SpringCloud与各子项目的版本依赖关系，发布了一个清单，其中包括了某个SpringCloud版对应的子项目版本，为了避免SpringCloud版本号与子项目版本号混淆，SpringCloud版采用了名称而非版本号命名。例如Angel，Brixton。当SpringCloud的发布内容积累到临界点或者一个重大BUG被解决后，会发布一个Service releases版本，俗称SRX版本，比如 Greenwich.SR2就是SpringCloud发布的Greenwich版本的第二个SRX版本</p> <p>https://spring.io/projects/spring-cloud#overview</p> <p>对应版本地址</p> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/8.png" style="zoom:67%;"> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>spring.cloud-version</span><span class="token punctuation">&gt;</span></span>Hoxton.SR8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>spring.cloud-version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${spring.cloud-version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h2 id="_1-4-明细条目"><a href="#_1-4-明细条目" class="header-anchor">#</a> 1.4 明细条目</h2> <ul><li>服务调用
<ul><li>Eureka</li> <li>Zookeeper</li> <li>Consul</li> <li>Nacos （推荐）</li></ul></li> <li>服务调用
<ul><li>Feign</li> <li>OpenFeign （推荐）</li> <li>Ribbon</li> <li>LoadBalancer</li></ul></li> <li>服务降级
<ul><li>Hystrix</li> <li>resilience4j</li> <li>sentienl （推荐）</li></ul></li> <li>服务网关
<ul><li>Zuul</li> <li>Zuul2</li> <li>Gateway（推荐）</li></ul></li> <li>服务配置
<ul><li>Config</li> <li>Nacos（推荐）</li></ul></li> <li>服务总线
<ul><li>Bus</li> <li>Nacos（推荐）</li></ul></li></ul> <h1 id="_2-eureka"><a href="#_2-eureka" class="header-anchor">#</a> 2. Eureka</h1> <h2 id="_2-1-工作原理"><a href="#_2-1-工作原理" class="header-anchor">#</a> 2.1 工作原理</h2> <p>没有集群带来的高可用，会带来单点故障</p> <ul><li>服务注册：将服务信息注册进注册中心</li> <li>服务发现：从注册中心上获取服务信息</li> <li>实质：存key服务命名，取value调用地址</li></ul> <ol><li>先启动eureka注册中心</li> <li>启动服务提供者payment支付服务</li> <li>支付服务启动后，会把自身信息（比如 服务地址以别名方式注册进eureka）</li> <li>消费者order服务在调用接口时候使用服务别名去注册中心获取实际的RPC远程调用地址</li> <li>消费者获得调用地址后，底层实际是利用HttpClient技术实现远程调用</li> <li>消费者获取服务地址后会缓存在本地JVM内存中，默认每隔30秒更新一次服务调用地址</li></ol> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/9.png" alt=""></p> <p>微服务RPC远程调用最核心的就是：高可用</p> <p>因为假设注册中心只有一个，如果出现了故障，那么将会导致整个微服务不可用，所以需要搭建Eureka注册中心集群，实现负载均衡 + 故障容错</p> <p>Eureka包含两个组件：Eureka Server 和 Eureka Client</p> <ul><li>Eureka Server 提供服务注册服务
<ul><li>各个微服务节点通过配置启动后，会在 EurekaServer进行注册，这样 EurekaServer中的服务注册表中将会存储所有可用服务节点的信息，服务节点的信息可以在界面中直观看待</li></ul></li> <li>EurekaClient通过注册中心进行访问
<ul><li>是一个java客户端，用于简化EurekaServer的交互，客户端同时也具备一个<strong>内置的、使用轮询负载算法的负载均衡器</strong>。在应用启动后，将会向EurekaServer发送心跳（默认30s），如果EurekaServer在多个心跳周期内没有接收到某个节点的心跳，EurekaServer将会在服务注册表中把这个服务节点移除（默认90s）</li></ul></li></ul> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/10.png" alt=""></p> <h2 id="_2-1-单机使用"><a href="#_2-1-单机使用" class="header-anchor">#</a> 2.1 单机使用</h2> <h3 id="_2-1-1-eureka配置"><a href="#_2-1-1-eureka配置" class="header-anchor">#</a> 2.1.1 Eureka配置</h3> <h4 id="_2-1-1-1-eurekaserver端"><a href="#_2-1-1-1-eurekaserver端" class="header-anchor">#</a> 2.1.1.1 EurekaServer端</h4> <p>对于 EurekaServer端</p> <p>声明为 server端</p> <div class="language-xml extra-class"><pre class="language-xml"><code>  <span class="token comment">&lt;!--eureka-server--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>表示为 yml</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">7001</span>

<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
  <span class="token key atrule">hostname</span><span class="token punctuation">:</span> localhost <span class="token comment"># eureka服务端的实例名称 单机</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token comment"># false 表示不向注册中心注册自己</span>
    <span class="token key atrule">register-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token comment"># false 表示自己端就是注册中心，我的职责就是维护服务实例，并不需要去检索服务</span>
    <span class="token key atrule">fetch-registry</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token comment"># 设置与 Eureka server 交互的地址查询服务和注册服务都需要依赖这个地址</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//$<span class="token punctuation">{</span>eureka.instance.hostname<span class="token punctuation">}</span><span class="token punctuation">:</span>$<span class="token punctuation">{</span>server.port<span class="token punctuation">}</span>/eureka/  <span class="token comment"># 单机</span>

</code></pre></div><p>在启动类上添加注解 <code>EnableEurekaServer</code>,声明server端</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableEurekaServer</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EurekaMain7001</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">EurekaMain7001</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_2-1-1-2-客户端-提供方"><a href="#_2-1-1-2-客户端-提供方" class="header-anchor">#</a> 2.1.1.2 客户端（提供方）</h4> <p>在客户端（支付端Payment）声明</p> <div class="language-xml extra-class"><pre class="language-xml"><code>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>yaml文件配置</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">register-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">fetch-registry</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>7001/eureka <span class="token comment"># 单机</span>
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token key atrule">instance-id</span><span class="token punctuation">:</span> payment8001
    <span class="token key atrule">prefer-ip-address</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 访问路径可以显示 ip 地址</span>
</code></pre></div><p>启动类不需要进行配置</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PaymentMain8001</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">PaymentMain8001</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_2-1-1-3-客户端-调用端"><a href="#_2-1-1-3-客户端-调用端" class="header-anchor">#</a> 2.1.1.3 客户端（调用端）</h4> <p>添加依赖</p> <div class="language-xml extra-class"><pre class="language-xml"><code>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>配置文件</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> cloud<span class="token punctuation">-</span>order<span class="token punctuation">-</span>service

<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token comment">#表示是否将自己注册进EurekaServer默认为true。</span>
    <span class="token key atrule">register-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment">#是否从EurekaServer抓取已有的注册信息，默认为true。单节点无所谓，集群必须设置为true才能配合ribbon使用负载均衡</span>
    <span class="token key atrule">fetchRegistry</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token comment">#单机</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>7001/eureka

</code></pre></div><h2 id="_2-2-eureka集群"><a href="#_2-2-eureka集群" class="header-anchor">#</a> 2.2 Eureka集群</h2> <h3 id="_2-2-1-原理"><a href="#_2-2-1-原理" class="header-anchor">#</a> 2.2.1 原理</h3> <p>互相注册，相互守望</p> <p><img src="http://moxi159753.gitee.io/learningnotes/SpringCloud/SpringCloud2020/3_%E6%90%AD%E5%BB%BAEureka%E9%9B%86%E7%BE%A4/images/image-20200407214903319.png" alt="image-20200407214903319"></p> <h3 id="_2-2-2-搭建集群"><a href="#_2-2-2-搭建集群" class="header-anchor">#</a> 2.2.2 搭建集群</h3> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/12.png" style="zoom:67%;"> <p>原来单机版本时，我们的注册中心的配置文件为</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">7001</span>
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> localhost <span class="token comment">#eureka服务端实例名称</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">register-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment">#表示不向注册中心注册自己</span>
    <span class="token key atrule">fetch-registry</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment">#false表示自己就是注册中心，我的职责就是维护服务实例,并不区检索服务</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//$<span class="token punctuation">{</span>eureka.instance.hostname<span class="token punctuation">}</span><span class="token punctuation">:</span>$<span class="token punctuation">{</span>server.port<span class="token punctuation">}</span>/eureka/
</code></pre></div><p>但是如果使用了集群后，我们的eureka就需要相互注册了，也就是 7001的需要注册到7002, 而7002注册7001</p> <p>同时 hostname也不能重复，需要有两个主机的ip，假如说有三个，则需要defaultZone写两个</p> <p>eureka 7001</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">7001</span>
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> eureka7001.com <span class="token comment">#eureka服务端实例名称</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">register-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment">#表示不向注册中心注册自己</span>
    <span class="token key atrule">fetch-registry</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment">#false表示自己就是注册中心，我的职责就是维护服务实例,并不区检索服务</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token comment"># 向另外一个eureka服务注册</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka7002.com<span class="token punctuation">:</span>7002/eureka/
</code></pre></div><p>eureka 7002:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">7002</span>
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> eureka7002.com <span class="token comment">#eureka服务端实例名称</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">register-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment">#表示不向注册中心注册自己</span>
    <span class="token key atrule">fetch-registry</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment">#false表示自己就是注册中心，我的职责就是维护服务实例,并不区检索服务</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token comment"># 向另外一个eureka服务注册</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka7001.com<span class="token punctuation">:</span>7001/eureka/
</code></pre></div><p>启动后，我们能发现，在eureka7001上，能看到7002注册上去了</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/11.png" alt=""></p> <p>同时在eureka7002上，能看到7001，这个时候说明我们的eureka集群已经搭建完毕</p> <h3 id="_2-2-3-服务注册eureka集群"><a href="#_2-2-3-服务注册eureka集群" class="header-anchor">#</a> 2.2.3 服务注册Eureka集群</h3> <p>我们修改服务提供者payment的yml配置，同时将两个eureka地址配置在defaultZone中</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token comment">#表示向注册中心注册自己 默认为true</span>
    <span class="token key atrule">register-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment">#是否从EurekaServer抓取已有的注册信息，默认为true,单节点无所谓,集群必须设置为true才能配合ribbon使用负载均衡</span>
    <span class="token key atrule">fetch-registry</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token comment"># 入驻地址</span>
      <span class="token comment"># defaultZone: http://localhost:7001/eureka/</span>
      <span class="token comment">#集群版</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka7001.com<span class="token punctuation">:</span>7001/eureka/<span class="token punctuation">,</span>http<span class="token punctuation">:</span>//eureka7002.com<span class="token punctuation">:</span>7002/eureka/
  <span class="token comment">#服务名称</span>
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token key atrule">instance-id</span><span class="token punctuation">:</span> payment8001
    <span class="token comment">#访问路径显示IP地址</span>
    <span class="token key atrule">prefer-ip-address</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre></div><p>在上面的图中，我们能发现，payment服务已经成功注册到两台eureka集群中了</p> <h3 id="_2-2-4-服务提供者集群"><a href="#_2-2-4-服务提供者集群" class="header-anchor">#</a> 2.2.4 服务提供者集群</h3> <p>我们需要搭建多个服务提供者</p> <p>例如：payment8001：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8001</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> cloud<span class="token punctuation">-</span>payment<span class="token punctuation">-</span>service <span class="token comment">#服务名称</span>
  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> com.alibaba.druid.pool.DruidDataSource  <span class="token comment">#当前数据源操作类型</span>
    <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.jdbc.Driver
    <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>3306/cloud2020<span class="token punctuation">?</span>characterEncoding=utf8<span class="token important">&amp;useSSL=false&amp;useUnicode=true</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> root
    <span class="token key atrule">password</span><span class="token punctuation">:</span> root
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token comment">#表示向注册中心注册自己 默认为true</span>
    <span class="token key atrule">register-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment">#是否从EurekaServer抓取已有的注册信息，默认为true,单节点无所谓,集群必须设置为true才能配合ribbon使用负载均衡</span>
    <span class="token key atrule">fetch-registry</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token comment"># 入驻地址</span>
      <span class="token comment"># defaultZone: http://localhost:7001/eureka/</span>
      <span class="token comment">#集群版</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka7001.com<span class="token punctuation">:</span>7001/eureka/<span class="token punctuation">,</span>http<span class="token punctuation">:</span>//eureka7002.com<span class="token punctuation">:</span>7002/eureka/
</code></pre></div><p>和payment8002：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8002</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> cloud<span class="token punctuation">-</span>payment<span class="token punctuation">-</span>service <span class="token comment">#服务名称</span>
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token comment">#表示向注册中心注册自己 默认为true</span>
    <span class="token key atrule">register-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment">#是否从EurekaServer抓取已有的注册信息，默认为true,单节点无所谓,集群必须设置为true才能配合ribbon使用负载均衡</span>
    <span class="token key atrule">fetch-registry</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token comment"># 入驻地址</span>
<span class="token comment">#       defaultZone: http://localhost:7001/eureka/</span>
      <span class="token comment">#集群版</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka7001.com<span class="token punctuation">:</span>7001/eureka/<span class="token punctuation">,</span>http<span class="token punctuation">:</span>//eureka7002.com<span class="token punctuation">:</span>7002/eureka/
  <span class="token comment">#服务名称</span>
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token key atrule">instance-id</span><span class="token punctuation">:</span> payment8001
    <span class="token comment">#访问路径显示IP地址</span>
    <span class="token key atrule">prefer-ip-address</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">mybatis</span><span class="token punctuation">:</span>
  <span class="token key atrule">mapper-locations</span><span class="token punctuation">:</span> classpath<span class="token punctuation">:</span>mapper/<span class="token important">*.xml</span>
  <span class="token key atrule">type-aliases-package</span><span class="token punctuation">:</span> com.atguigu.springcloud.entity  <span class="token comment">#所有entity别名所在包</span>
</code></pre></div><p>这里需要注意的就是，为了保证这两个服务，对外暴露的都是同一个服务提供者，我们的服务名需要保持一致</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> cloud<span class="token punctuation">-</span>payment<span class="token punctuation">-</span>service <span class="token comment">#服务名称</span>
</code></pre></div><p>启动后，我们发现CLOUD-PAYMENT_SERVICE上有两个服务提供者了，分别为：8001和8002</p> <p><img src="http://moxi159753.gitee.io/learningnotes/SpringCloud/SpringCloud2020/3_%E6%90%AD%E5%BB%BAEureka%E9%9B%86%E7%BE%A4/images/image-20200407223634503.png" alt="image-20200407223634503"></p> <p>注： <code>#服务名称instance: instance-id: payment8001</code>由于服务名称其他都一样，如果不写instance的话就不知道是哪个了，就会报错，在对消费者进行调用的时候就会报错</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/14.png" alt=""></p> <h3 id="_2-2-5-服务消费者集群"><a href="#_2-2-5-服务消费者集群" class="header-anchor">#</a> 2.2.5 服务消费者集群</h3> <p>同时我们需要服务名进行调用</p> <p>这个时候由于有两个服务者 Payment8001和 Payment8002,订单服务地址不能写死</p> <div class="language- extra-class"><pre class="language-text"><code>http://CLOUD-PAYMENT_SERVICE
</code></pre></div><p>通知在RestTemplate需要设置负载均衡策略，即 @LoadBalanced注解，不然它不知道调用哪个微服务地址</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationContextConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@LoadBalanced</span> <span class="token comment">//赋予RestTemplate负载均衡的能力,轮询</span>
    <span class="token keyword">public</span> <span class="token class-name">RestTemplate</span> <span class="token function">getRestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这个就是Rabbon的负载均衡功能，默认是轮询</p> <blockquote><p>Ribbon和Eureka整合后，Consumer可以直接调用服务而不再关心地址和端口号，且该服务还有负载均衡的功能</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/consumer/payment&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderController</span> <span class="token punctuation">{</span>

<span class="token comment">//    public static final String PAYMENT_URL = &quot;http//localhost:8001&quot;;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> PAYMENT_URL <span class="token operator">=</span> <span class="token string">&quot;http://CLOUD-PAYMENT-SERVICE&quot;</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RestTemplate</span> restTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/create&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">CommonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Payment</span><span class="token punctuation">&gt;</span></span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Payment</span> payment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> restTemplate<span class="token punctuation">.</span><span class="token function">postForObject</span><span class="token punctuation">(</span>PAYMENT_URL <span class="token operator">+</span> <span class="token string">&quot;/payment/create&quot;</span><span class="token punctuation">,</span> payment<span class="token punctuation">,</span> <span class="token class-name">CommonResult</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/get/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">CommonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Payment</span><span class="token punctuation">&gt;</span></span> <span class="token function">getPayment</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span>PAYMENT_URL <span class="token operator">+</span> <span class="token string">&quot;/payment/get/&quot;</span> <span class="token operator">+</span> id<span class="token punctuation">,</span> <span class="token class-name">CommonResult</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>两个服务提供者进行轮询，每次刷新 PAYMENT_URL 都不一样，因为进行轮询</p> <h3 id="_2-2-5-actuator微服务信息完善"><a href="#_2-2-5-actuator微服务信息完善" class="header-anchor">#</a> 2.2.5 actuator微服务信息完善</h3> <p>要做图形化的监视展示这块，这两个依赖都需要导入</p> <div class="language-xml extra-class"><pre class="language-xml"><code>        <span class="token comment">&lt;!--web启动器--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--监控--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-actuator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>actuator：主要用于IP信息完善</p> <p>actuator查看健康状态</p> <div class="language- extra-class"><pre class="language-text"><code>http://192.168.80.1:8002/actuator/health
</code></pre></div><h4 id="_2-2-5-1-服务名称修改"><a href="#_2-2-5-1-服务名称修改" class="header-anchor">#</a> 2.2.5.1  服务名称修改</h4> <p>修改后，对外暴露的就是服务名称</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code>Erueka
  <span class="token comment">#服务名称</span>
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
     <span class="token key atrule">instance-id</span><span class="token punctuation">:</span> payment8001
</code></pre></div><h4 id="_2-2-5-2-设置服务的ip显示"><a href="#_2-2-5-2-设置服务的ip显示" class="header-anchor">#</a> 2.2.5.2 设置服务的IP显示</h4> <div class="language-yaml extra-class"><pre class="language-yaml"><code>Erueka
  <span class="token comment">#服务名称</span>
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token comment">#访问路径显示IP地址</span>
    <span class="token key atrule">prefer-ip-address</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre></div><p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/15.png" alt=""></p> <h3 id="_2-2-6-服务发现discovery"><a href="#_2-2-6-服务发现discovery" class="header-anchor">#</a> 2.2.6 服务发现Discovery</h3> <p>Eureka的新的注解标签 <code>@EurekaDiscovery</code></p> <p>对于注册进Eureka里面的微服务，可以通过服务发现来获得该服务的信息</p> <div class="language- extra-class"><pre class="language-text"><code>@Resource
private DiscoveryClient discoveryClient;
</code></pre></div><p>获得服务列表</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;discovery&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">discovery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> services <span class="token operator">=</span> discoveryClient<span class="token punctuation">.</span><span class="token function">getServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> element <span class="token operator">:</span> services<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;************element: &quot;</span> <span class="token operator">+</span> element<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">&gt;</span></span> instances <span class="token operator">=</span> discoveryClient<span class="token punctuation">.</span><span class="token function">getInstances</span><span class="token punctuation">(</span><span class="token string">&quot;CLOUD-PAYMENT-SERVICE&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ServiceInstance</span> instance <span class="token operator">:</span> instances<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token function">getServiceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\t&quot;</span> <span class="token operator">+</span> instance<span class="token punctuation">.</span><span class="token function">getHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\t&quot;</span> <span class="token operator">+</span> instance<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\t&quot;</span> <span class="token operator">+</span> instance<span class="token punctuation">.</span><span class="token function">getUri</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>discoveryClient<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code># 获取列表
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> services <span class="token operator">=</span> discoveryClient<span class="token punctuation">.</span><span class="token function">getServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
# 获取实例
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">&gt;</span></span> instances <span class="token operator">=</span> discoveryClient<span class="token punctuation">.</span><span class="token function">getInstances</span><span class="token punctuation">(</span><span class="token string">&quot;CLOUD-PAYMENT-SERVICE&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
# 获取<span class="token class-name">ServiceId</span>
instances<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getServiceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

# 获取主机名
instances<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

# 获取端口号
instances<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

# 获取URL
instances<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/16.png" alt=""></p> <h2 id="_2-3-eureka自我保护机制"><a href="#_2-3-eureka自我保护机制" class="header-anchor">#</a> 2.3 Eureka自我保护机制</h2> <h3 id="_2-3-1-概念"><a href="#_2-3-1-概念" class="header-anchor">#</a> 2.3.1 概念</h3> <p>保护模式主要用于一组客户端和Eureka Server之间存在网络分区场景下的保护，一旦进入保护模式，Eureka Server将会尝试保护其服务注册表的信息，不再删除服务注册表中的数据，也就是不会注销任何微服务。</p> <p>如果在Eureka Server的首页看到以下这段提示，说明Eureka进入了保护模式</p> <p><img src="http://moxi159753.gitee.io/learningnotes/SpringCloud/SpringCloud2020/3_%E6%90%AD%E5%BB%BAEureka%E9%9B%86%E7%BE%A4/images/image-20200407230432953.png" alt="image-20200407230432953"></p> <p>通俗的话来说：某时刻某一个微服务不可用了，Eureka不会立刻清理，依旧会对该微服务的信息进行保存，属于CAP里面的AP分支。</p> <h3 id="_2-3-2-导致原因"><a href="#_2-3-2-导致原因" class="header-anchor">#</a> 2.3.2 导致原因</h3> <p>默认情况下，如果EurekaServer在一定时间内没有接收到某个微服务实例的心跳，EurekaServer将会注销该实例，默认90秒。但是当网络分区故障发生（延时，卡顿，拥挤）时，微服务与EurekaServer之间无法正常通信，以上行为可能变得非常危险了- 因为微服务本身其实是健康的，此时不应该注销这个微服务，Eureka通过 自我保护模式 来解决这个问题，当EurekaServer节点在短时间丢失过多客户端，那么这个节点就会进入自我保护模式</p> <p><img src="http://moxi159753.gitee.io/learningnotes/SpringCloud/SpringCloud2020/3_%E6%90%AD%E5%BB%BAEureka%E9%9B%86%E7%BE%A4/images/image-20200407230731783.png" alt="image-20200407230731783"></p> <p>这是一种高可用的机制</p> <p><img src="http://moxi159753.gitee.io/learningnotes/SpringCloud/SpringCloud2020/3_%E6%90%AD%E5%BB%BAEureka%E9%9B%86%E7%BE%A4/images/image-20200407231058929.png" alt="image-20200407231058929"></p> <p>在自我保护模式下，Eureka Server会保护服务注册表中的信息，不在注销任何服务实例</p> <p>它的设计哲学就是宁可保留错误的服务注册信息，也不盲目注销任何可能健康的服务实例</p> <p>综上，自我保护模式是一种应对网络异常的安全保护措施，它的架构哲学是宁可保留所有微服务（健康的微服务和不健康的微服务都会保留）也不盲目注销任何健康的微服务。使用自我保护模式，可以让Eureka集群更加健壮，稳定。</p> <h3 id="_2-3-3-禁止自我保护"><a href="#_2-3-3-禁止自我保护" class="header-anchor">#</a> 2.3.3 禁止自我保护</h3> <p>在Eureka端， Eureka默认开启自我保护</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">server</span><span class="token punctuation">:</span>
    <span class="token key atrule">enable-self-preservation</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">peer-node-read-timeout-ms</span><span class="token punctuation">:</span> <span class="token number">3000</span>
    <span class="token key atrule">peer-node-connect-timeout-ms</span><span class="token punctuation">:</span> <span class="token number">3000</span>
</code></pre></div><p>同时在客户端进行设置</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token comment"># Eureka客户端向服务端发送心跳的时间间隔，单位为秒，默认30</span>
    <span class="token key atrule">lease-renewal-interval-in-seconds</span><span class="token punctuation">:</span> <span class="token number">1</span>
    <span class="token comment"># Eureka服务端在收到最后一次心跳后等待时间上限，单位为秒，默认为90秒，超时将剔除服务</span>
    <span class="token key atrule">lease-expiration-duration-in-seconds</span><span class="token punctuation">:</span> <span class="token number">2</span>
</code></pre></div><p>设置完成后，只要服务宕机，会马上从服务注册列表中清除</p> <h2 id="_2-4-关于eureka停更"><a href="#_2-4-关于eureka停更" class="header-anchor">#</a> 2.4 关于Eureka停更</h2> <p>Eureka停更后，出现了其它的替代者</p> <ul><li>Zookeeper</li> <li>Consul</li> <li>Nacos</li></ul> <h1 id="_3-zookeeper-替换-eureka"><a href="#_3-zookeeper-替换-eureka" class="header-anchor">#</a> 3. zookeeper 替换 Eureka</h1> <p>Eureka停更之后，使用 zookeeper，当然后续使用 nacos，还是nacos香</p> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/17.png" style="zoom:67%;"> <p>zookeeper是一个分布式协调工具，可以实现注册中心的功能</p> <h2 id="_3-1-搭建zookeeper注册中心"><a href="#_3-1-搭建zookeeper注册中心" class="header-anchor">#</a> 3.1 搭建zookeeper注册中心</h2> <h3 id="_3-1-1-引入依赖"><a href="#_3-1-1-引入依赖" class="header-anchor">#</a> 3.1.1 引入依赖</h3> <div class="language-xml extra-class"><pre class="language-xml"><code>        <span class="token comment">&lt;!-- SpringBoot整合zookeeper客户端 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-zookeeper-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!--先排除自带的zookeeper3.5.3--&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.zookeeper<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>zookeeper<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.zookeeper<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>zookeeper<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.5.3-beta<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="_3-1-2-修改配置文件"><a href="#_3-1-2-修改配置文件" class="header-anchor">#</a> 3.1.2 修改配置文件</h3> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token comment">#8004表示注册到zookeeper服务器的支付服务提供者端口号</span>
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8004</span>


<span class="token comment">#服务别名----注册zookeeper到注册中心名称</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> cloud<span class="token punctuation">-</span>provider<span class="token punctuation">-</span>payment
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">zookeeper</span><span class="token punctuation">:</span>
      <span class="token key atrule">connect-string</span><span class="token punctuation">:</span> 182.92.227.85<span class="token punctuation">:</span><span class="token number">2181</span>
</code></pre></div><h3 id="_3-1-3-修改主启动类"><a href="#_3-1-3-修改主启动类" class="header-anchor">#</a> 3.1.3 修改主启动类</h3> <p>为了发现服务使用 <code>EnableDiscoveryClient</code></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PaymentMain8004</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">PaymentMain8004</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_3-1-4-启动得到的结果"><a href="#_3-1-4-启动得到的结果" class="header-anchor">#</a> 3.1.4 启动得到的结果</h3> <p>启动成功后，将服务注册金zookeeper客户端,连接zookeeper客户端后 <code>cloud-provider-payment</code>这个服务已经被注入</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/18.png" alt=""></p> <p>也可将order注入 配置文件、启动类同理</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// config</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationContextConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@LoadBalanced</span>
    <span class="token keyword">public</span> <span class="token class-name">RestTemplate</span> <span class="token function">getRestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>controller</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderZKController</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> INVOKE_URL <span class="token operator">=</span> <span class="token string">&quot;http://cloud-provider-payment&quot;</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RestTemplate</span> restTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/consumer/payment/zk&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">paymentInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> result <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span>INVOKE_URL<span class="token operator">+</span><span class="token string">&quot;/payment/zk&quot;</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>启动之后，发现被注入，正常访问</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/19.png" alt=""></p> <h3 id="_3-1-5-思考"><a href="#_3-1-5-思考" class="header-anchor">#</a> 3.1.5 思考</h3> <p>服务已经成功注册到Zookeeper客户端，那么注册上去的节点被称为临时节点，还是持久节点？</p> <p>首先Eureka有自我保护机制，也就是某个服务下线后，不会立刻清除该服务，而是将服务保留一段时间</p> <p>Zookeeper也一样在服务下线后，会等待一段时间后，也会把该节点删除，这就说明Zookeeper上的节点是临时节点。</p> <h1 id="_4-consul-替换-eureka"><a href="#_4-consul-替换-eureka" class="header-anchor">#</a> 4. Consul 替换 Eureka</h1> <h2 id="_4-1-简介"><a href="#_4-1-简介" class="header-anchor">#</a> 4.1 简介</h2> <p>官网：<code>https://www.consul.io/</code></p> <p>Consul是一套开源的分布式服务发现和配置管理系统，由HashiCorp公司用Go语言开发</p> <p>提供了微服务系统中的服务治理、配置中心、控制总线等功能，这些功能中的每一个都可以根据需要单独使用，也可以一起使用构建全方位的服务网路，总之Consul提供了一种完整的服务网络解决方案。</p> <p>它具有很多优点，包括：基于raft协议，比较简洁；支持健康检查，同时支持HTTP和DNS协议，支持跨数据中心的WAN集群，提供图形化界面，跨平台，支持Linux，MAC，Windows</p> <h2 id="_4-2-功能"><a href="#_4-2-功能" class="header-anchor">#</a> 4.2 功能</h2> <ul><li>服务发现：提供HTTP和DNS两种发现方式</li> <li>健康监测：支持多种方法，HTTP，TCP，Docker，Shell脚本定制化</li> <li>KV存储：Key，Value的存储方式</li> <li>多数据中心：Consul支持多数据中心</li> <li>可视化Web界面</li></ul> <p>使用了docker进行安装</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/20.png" alt=""></p> <h2 id="_4-3-使用"><a href="#_4-3-使用" class="header-anchor">#</a> 4.3 使用</h2> <h3 id="_4-3-1-引入依赖"><a href="#_4-3-1-引入依赖" class="header-anchor">#</a> 4.3.1 引入依赖</h3> <div class="language-xml extra-class"><pre class="language-xml"><code>        <span class="token comment">&lt;!--SpringCloud consul-server --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-consul-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="_4-3-2-配置文件"><a href="#_4-3-2-配置文件" class="header-anchor">#</a> 4.3.2 配置文件</h3> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8006</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> consul<span class="token punctuation">-</span>provider<span class="token punctuation">-</span>payment

<span class="token comment"># consul 注册中心地址</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">consul</span><span class="token punctuation">:</span>
      <span class="token key atrule">host</span><span class="token punctuation">:</span> 182.92.227.85
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8500</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">service-name</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.application.name<span class="token punctuation">}</span>
        <span class="token key atrule">prefer-ip-address</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">heartbeat</span><span class="token punctuation">:</span>
          <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 解决红叉</span>
</code></pre></div><h3 id="_4-3-3-controller"><a href="#_4-3-3-controller" class="header-anchor">#</a> 4.3.3 controller</h3> <p>启动文件不变</p> <p>controller，其实也没啥</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PaymentController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${server.port}&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 得到配置文件中的端口</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> serverPort<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/payment/consul&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">paymentzk</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;springcloud with consul: &quot;</span> <span class="token operator">+</span> serverPort <span class="token operator">+</span> <span class="token string">&quot;\t&quot;</span> <span class="token operator">+</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/21.png" alt=""></p> <h2 id="_4-4-总结"><a href="#_4-4-总结" class="header-anchor">#</a> 4.4 总结</h2> <table><thead><tr><th>组件名</th> <th>语言</th> <th>健康检查</th> <th>对外暴露接口</th> <th>CAP</th> <th>Spring Clou集成</th></tr></thead> <tbody><tr><td>Eureka</td> <td>Java</td> <td>可配支持</td> <td>HTTP</td> <td>AP</td> <td>已集成</td></tr> <tr><td>Consul</td> <td>Go</td> <td>支持</td> <td>HTTP/DNS</td> <td>CP</td> <td>已集成</td></tr> <tr><td>Zookeeper</td> <td>Java</td> <td>支持</td> <td>客户端</td> <td>CP</td> <td>已集成</td></tr></tbody></table> <h3 id="_4-4-1-cap理论"><a href="#_4-4-1-cap理论" class="header-anchor">#</a> 4.4.1 CAP理论</h3> <ul><li><p>Availability：高可用</p></li> <li><p>Consistency：强一致性</p></li> <li><p>Partition Tolerance：分区容错性</p></li></ul> <p>CAP理论关注粒度是数据，而不是整体系统设计的策略</p> <p>因此现在的微服务架构要么是 CP 要么是 AP，也就是P一定需要保证，最多只能较好的同时满足两个</p> <p>CAP理论的核心：一个分布式系统不可能同时很好的满足：一致性，可用性和分区容错性这个三个需求</p> <p>因此，根据CAP原理将NoSQL数据库分成了满足CA原则，满足CP原则，满足AP的三大类</p> <ul><li>CA：单点集群，满足一致性，可用性的系统，通常在可扩展性上不太满足</li> <li>CP：满足一致性，分区容忍性，通常性能不是特别高</li> <li>AP：满足可用性，分区容忍性，通常对一致性要求低一些</li></ul> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/22.png" style="zoom:50%;"> <p>部分情况下，我们对数据一致性的要求没有这么高，比如蘑菇博客的点赞和浏览记录，都是每隔一段时间才写入数据库的。</p> <h3 id="_4-4-2-ap架构"><a href="#_4-4-2-ap架构" class="header-anchor">#</a> 4.4.2 AP架构</h3> <p>Eureka是AP架构</p> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/23.png" style="zoom:50%;"> <p>因为同步原因出现问题，而造成数据没有一致性</p> <p>当出现网络分区后，为了保证高可用，系统B可以返回旧值，保证系统的可用性</p> <p>结论：违背了一致性C的要求，只满足可用性和分区容错性，即AP</p> <h3 id="_4-4-3-cp架构"><a href="#_4-4-3-cp架构" class="header-anchor">#</a> 4.4.3 CP架构</h3> <p>Zookeeper和Consul是CP架构</p> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/24.png" style="zoom:50%;"> <p>当出现网络分区后，为了保证一致性，就必须拒绝请求，否者无法保证一致性</p> <p>结论：违背了可用性A的要求，只满足一致性和分区容错性，即CP</p> <h1 id="_5-ribbon实现负载均衡"><a href="#_5-ribbon实现负载均衡" class="header-anchor">#</a> 5. Ribbon实现负载均衡</h1> <p>Ribbon目前已经进入了维护模式，但是目前主流还是使用Ribbon</p> <p>Spring Cloud想通过LoadBalancer用于替换Ribbon</p> <h2 id="_5-1-概念"><a href="#_5-1-概念" class="header-anchor">#</a> 5.1 概念</h2> <p>Spring Cloud Ribbon是基于Netflix Ribbon实现的一套客户端，负载均衡的工具</p> <p>简单的说，Ribbon是NetFlix发布的开源项目，主要功能是<strong>提供客户端的软件负载均衡算法和服务调用</strong>。Ribbon客户端组件提供了一系列完善的配置项如连接超时，重试等。简单的说，就是在配置文件中列出Load Balancer（简称LB）后面所有的机器，Ribbon会自动的帮助你基于某种规则（如简单轮询，随机连接等）去连接这些机器。我们很容易使用Ribbon实现自定义的负载均衡算法。</p> <h2 id="_5-2-lb负载均衡是什么"><a href="#_5-2-lb负载均衡是什么" class="header-anchor">#</a> 5.2 LB负载均衡是什么</h2> <p>Load Balance，简单来说就是将用户的请求平摊的分配到多个服务上，从而达到系统的HA（高可用）。常见的负载均衡有软件Nginx，LVS，硬件F5等。</p> <ul><li>集中式LB：即在服务的消费方和提供方之间使用独立的LB设施（可以是硬件，如F5，也可以是软件，如Nginx），由该设施负责把访问请求通过某种策略转发至服务的提供方</li> <li>进程内LB：将LB逻辑集成到消费方，消费方从服务注册中心获知有哪些地址可用，然后自己再从这些地址中选择出一个合适的服务器。Ribbon就属于进程内LB，它只是一个类库，集成于消费方进程，消费方通过它来获取到服务提供方的地址。</li></ul> <h2 id="_5-3-ribbon本地负载均衡客户端-vs-nginx服务端负载均衡"><a href="#_5-3-ribbon本地负载均衡客户端-vs-nginx服务端负载均衡" class="header-anchor">#</a> 5.3 Ribbon本地负载均衡客户端 VS Nginx服务端负载均衡</h2> <p>Nginx是服务器负载均衡，客户端所有的请求都会交给nginx，然后由nginx实现转发请求，即负载均衡是由服务端实现的。</p> <p>Ribbon本地负载均衡，在调用微服务接口的时候，会在注册中心上获取注册信息服务列表之后，缓存到JVM本地，从而在本地实现RPC远程调用的技术。</p> <p>一句话就是：RIbbon = 负载均衡 + RestTemplate调用</p> <h2 id="_5-4-ribbon工作原理"><a href="#_5-4-ribbon工作原理" class="header-anchor">#</a> 5.4 Ribbon工作原理</h2> <p>Ribbon其实就是一个软负载均衡的客户端组件，它可以和其它所需请求的客户端结合使用，和Eureka结合只是其中的一个实例。</p> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/25.png" style="zoom:50%;"> <p>Ribbon在工作时分成两步</p> <ul><li>首先先选择EurekaServer，它优先选择在同一个区域内负载较少的Server</li> <li>再根据用户的指定的策略，从Server取到服务注册列表中选择一个地址</li> <li>其中Ribbon提供了多种策略：比如轮询，随机和根据响应时间加权</li></ul> <h2 id="_5-5-引入ribbon"><a href="#_5-5-引入ribbon" class="header-anchor">#</a> 5.5 引入Ribbon</h2> <p>新版的Eureka已经默认引入Ribbon了，不需要额外引入</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token comment">&lt;!--Eureka客户端--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/26.png" alt=""></p> <h2 id="_5-6-resttemplate"><a href="#_5-6-resttemplate" class="header-anchor">#</a> 5.6 RestTemplate</h2> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/27.png" alt=""></p> <p>主要方法为：</p> <ul><li>reseTemplate.getForObject：返回对象为响应体中数据转化成的对象，基本上可以理解为 json</li> <li>reseTemplate.postForObject</li></ul> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/consumer/payment/create&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">CommonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Payment</span><span class="token punctuation">&gt;</span></span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Payment</span> payment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> restTemplate<span class="token punctuation">.</span><span class="token function">postForObject</span><span class="token punctuation">(</span>PAYMENT_URL <span class="token operator">+</span> <span class="token string">&quot;/payment/create&quot;</span><span class="token punctuation">,</span> payment<span class="token punctuation">,</span> <span class="token class-name">CommonResult</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/consumer/payment/get/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">CommonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Payment</span><span class="token punctuation">&gt;</span></span> <span class="token function">getPayment</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span>PAYMENT_URL <span class="token operator">+</span> <span class="token string">&quot;/payment/get/&quot;</span> <span class="token operator">+</span> id<span class="token punctuation">,</span> <span class="token class-name">CommonResult</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/consumer/payment/getForEntity/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">CommonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Payment</span><span class="token punctuation">&gt;</span></span> <span class="token function">getForEntity</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CommonResult</span><span class="token punctuation">&gt;</span></span> entity <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForEntity</span><span class="token punctuation">(</span>PAYMENT_URL <span class="token operator">+</span> <span class="token string">&quot;/payment/get/&quot;</span> <span class="token operator">+</span> id<span class="token punctuation">,</span> <span class="token class-name">CommonResult</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>entity<span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is2xxSuccessful</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> entity<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CommonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">444</span><span class="token punctuation">,</span><span class="token string">&quot;操作失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><h2 id="_5-7-ribbon核心组件irule"><a href="#_5-7-ribbon核心组件irule" class="header-anchor">#</a> 5.7 Ribbon核心组件IRule</h2> <p>Ribbon默认是使用轮询作为负载均衡算法</p> <p>IRule根据特定算法从服务列表中选取一个要访问的服务，IRule是一个接口</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IRule</span> <span class="token punctuation">{</span>
    <span class="token class-name">Server</span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token class-name">Object</span> var1<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">setLoadBalancer</span><span class="token punctuation">(</span><span class="token class-name">ILoadBalancer</span> var1<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">ILoadBalancer</span> <span class="token function">getLoadBalancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后对该接口，进行特定的实现</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/28.png" alt=""></p> <h3 id="_5-7-1-负载均衡算法"><a href="#_5-7-1-负载均衡算法" class="header-anchor">#</a> 5.7.1 负载均衡算法</h3> <p>IRule的实现主要有以下七种</p> <ul><li>RoundRobinRule：轮询</li> <li>RandomRule：随机</li> <li>RetryRUle：先按照RoundRobinRule的策略获取服务，如果获取服务失败则在指定时间内会进行重试，获取可用服务</li> <li>WeightedResponseTimeRule：对RoundRobinRule的扩展，响应速度越快的实例选择的权重越大，越容易被选择</li> <li>BestAvailableRule：会先过滤掉由于多次访问故障而处于短路跳闸状态的服务，然后选择一个并发量最小的服务</li> <li>AvailabilityFilteringRule：先过滤掉故障实例，在选择并发较小的实例</li> <li>ZoneAvoidanceRule：默认规则，符合判断server所在区域的性能和server的可用性选择服务器</li></ul> <h3 id="_5-7-2-默认负载均衡算法替换"><a href="#_5-7-2-默认负载均衡算法替换" class="header-anchor">#</a> 5.7.2 默认负载均衡算法替换</h3> <p>官网警告：自定义的配置类不能放在@ComponentScanner所扫描的当前包下以及子包下，否者我们自定义的这个配置类就会被所有的Ribbon客户端所共享，达不到特殊化定制的目的了</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/29.png" alt=""></p> <p>然后我们创建自定义Rule接口</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MySelfRule</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">IRule</span> <span class="token function">myRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RandomRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//自定义为随机</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在主启动类中，添加<code>@RibbonClient</code></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token annotation punctuation">@RibbonClient</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;CLOUD-PAYMENT-SERVICE&quot;</span><span class="token punctuation">,</span>configuration <span class="token operator">=</span> <span class="token class-name">MySelfRule</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderMain80</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">OrderMain80</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_5-8-手写ribbon负载均衡算法"><a href="#_5-8-手写ribbon负载均衡算法" class="header-anchor">#</a> 5.8 手写Ribbon负载均衡算法</h2> <h3 id="_5-8-1-原理"><a href="#_5-8-1-原理" class="header-anchor">#</a> 5.8.1 原理</h3> <p>负载均衡算法：rest接口第几次请求数 % 服务器集群总数量 = 实际调用服务器位置下标，每次服务重启后rest接口计数从1开始。</p> <div class="language- extra-class"><pre class="language-text"><code>假设现在有2台机器，同时 List = 2 instance（也就是服务注册列表中，有两台）
1 % 2 = 1 -&gt; index = list.get(1)

2 % 2 = 0 -&gt; index = list.get(0)

3 % 2 = 1 -&gt; index = list.get(1)

....Copy to clipboardErrorCopied
</code></pre></div><p>这就是轮询的原理，即</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/30.png" alt=""></p> <h3 id="_5-8-2-源码"><a href="#_5-8-2-源码" class="header-anchor">#</a> 5.8.2 源码</h3> <p>我们查看RandomRule的源码发现，其实内部就是利用的取余的技术，同时为了保证同步机制，还是使用了AtomicInteger原子整型类</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RandomRule</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractLoadBalancerRule</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">RandomRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&quot;RCN_REDUNDANT_NULLCHECK_OF_NULL_VALUE&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Server</span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token class-name">ILoadBalancer</span> lb<span class="token punctuation">,</span> <span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lb <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">Server</span> server <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

            <span class="token keyword">while</span><span class="token punctuation">(</span>server <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> upList <span class="token operator">=</span> lb<span class="token punctuation">.</span><span class="token function">getReachableServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> allList <span class="token operator">=</span> lb<span class="token punctuation">.</span><span class="token function">getAllServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> serverCount <span class="token operator">=</span> allList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>serverCount <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">chooseRandomInt</span><span class="token punctuation">(</span>serverCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
                server <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Server</span><span class="token punctuation">)</span>upList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>server <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> server<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    server <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">return</span> server<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">int</span> <span class="token function">chooseRandomInt</span><span class="token punctuation">(</span><span class="token keyword">int</span> serverCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>serverCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Server</span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">choose</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getLoadBalancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initWithNiwsConfig</span><span class="token punctuation">(</span><span class="token class-name">IClientConfig</span> clientConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_5-8-3-手写负载均衡算法"><a href="#_5-8-3-手写负载均衡算法" class="header-anchor">#</a> 5.8.3 手写负载均衡算法</h3> <p>原理 + JUC（CAS+自旋锁）</p> <p>首先需要在RestTemplate的配置上将 @LoadBalanced注解删除</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token annotation punctuation">@Bean</span>
    <span class="token comment">//@LoadBalanced 赋予RestTemplate负载均衡的能力</span>
    <span class="token keyword">public</span> <span class="token class-name">RestTemplate</span> <span class="token function">getRestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>然后创建一个LoadBalanced接口</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 自定义负载均衡算法
 * @Author: TianTian
 * @Date: 2020/3/7 19:53
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">LoadBalancer</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取注册的一个实例</span>
    <span class="token class-name">ServiceInstance</span> <span class="token function">instances</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">&gt;</span></span> serviceInstances<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>创建一个实现类，首先LoadBalanced接口</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyLB</span> <span class="token keyword">implements</span> <span class="token class-name">LoadBalancer</span> <span class="token punctuation">{</span>

    <span class="token comment">// 创建原子整型类</span>
    <span class="token keyword">private</span> <span class="token class-name">AtomicInteger</span> atomicInteger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 获取Rest调用的次数
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">int</span> current<span class="token punctuation">;</span>
        <span class="token keyword">int</span> next<span class="token punctuation">;</span>
        <span class="token comment">// 自旋锁</span>
        <span class="token keyword">do</span><span class="token punctuation">{</span>
            <span class="token comment">// 获取当前值</span>
            current<span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">.</span>atomicInteger<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">/*2147483647:整型最大值*/</span>
            <span class="token comment">// 发生越界，从0开始计数</span>
            next<span class="token operator">=</span> current <span class="token operator">&gt;=</span><span class="token number">2147483647</span> <span class="token operator">?</span> <span class="token number">0</span><span class="token operator">:</span>current<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>

            <span class="token comment">// 比较并交换</span>
        <span class="token punctuation">}</span><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>atomicInteger<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span>next<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;******第几次访问next&quot;</span><span class="token operator">+</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> next<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//负载均衡算法：第几次请求%服务器总数量=实际访问。服务每次启动从1开始</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ServiceInstance</span> <span class="token function">instances</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">&gt;</span></span> serviceInstances<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// 获取当前计数 模  实例总数</span>
        <span class="token keyword">int</span> index<span class="token operator">=</span> <span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> serviceInstances<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 返回选择的实例</span>
        <span class="token keyword">return</span> serviceInstances<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>具体使用</p> <p>步骤就是，首先我们通过discoveryClient获取所有的注册实例，然后调用该实现类，获取到调用的地址</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token comment">/**
     * 在这边我为了以上程序的正常执行：把自定义接口注释掉，不用自定义负载均衡算法，若想再次启动
     * 请操作一下步骤：
     *          1.注释掉@LoadBalanced（在config下面），放开下方注释，同时会导致上方不可用，因为找不到具体服务
     */</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/consumer/payment/lb&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getPaymentLB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">&gt;</span></span> instances <span class="token operator">=</span> discoveryClient<span class="token punctuation">.</span><span class="token function">getInstances</span><span class="token punctuation">(</span><span class="token string">&quot;CLOUD-PAYMENT-SERVICE&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>instances <span class="token operator">==</span><span class="token keyword">null</span> <span class="token operator">||</span> instances<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//传入自己的</span>
        <span class="token class-name">ServiceInstance</span> serviceInstance <span class="token operator">=</span> loadBalancer<span class="token punctuation">.</span><span class="token function">instances</span><span class="token punctuation">(</span>instances<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">URI</span> uri <span class="token operator">=</span> serviceInstance<span class="token punctuation">.</span><span class="token function">getUri</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span>uri<span class="token operator">+</span><span class="token string">&quot;/payment/lb&quot;</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><h1 id="_6-openfeign实现服务调用"><a href="#_6-openfeign实现服务调用" class="header-anchor">#</a> 6. OpenFeign实现服务调用</h1> <p>关于Feign的停更，目前已经使用OpenFeign进行替换</p> <h2 id="_6-1-概述"><a href="#_6-1-概述" class="header-anchor">#</a> 6.1 概述</h2> <p>Feign是一个声明式WebService客户端。使用Feign能让编写WebService客户端更加简单。</p> <p>它的使用方法是定义一个服务接口然后在上面添加注解。Feign也支持可插拔式的编码和解码器。Spring Cloud对feign进行了封装，使其支持了Spring MVC标准注解和HttpMessageConverters。Feign可以与Eureka和Ribbon组合使用以支持负载均衡。</p> <h2 id="_6-2-feign的作用"><a href="#_6-2-feign的作用" class="header-anchor">#</a> 6.2 Feign的作用</h2> <p>Feign旨在使编写Java Http客户端变得更容易。</p> <p>前面在使用Ribbon + RestTemplate时，利用RestTemplate对http请求的封装处理，形成了一套模板化的调用方法。但是在实际开发中，由于对服务依赖的调用可能不止一处，往往一个接口会被多处调用，所以通常都会针对每个微服务自行封装一些客户端来包装这些依赖，所以Feign在这个基础上做了进一步封装，由他来帮助我们定义和实现依赖服务的接口定义。在Feign的实现下，我们只需要创建一个接口，并使用注解的方式来配置它（以前是Dao接口上面标注Mapper注解，现在是微服务接口上标注一个Feign注解），即可完成服务提供方的接口绑定，简化了使用Spring Cloud Ribbon时，自动封装服务调用客户端的开发量。</p> <h2 id="_6-3-feign集成ribbon"><a href="#_6-3-feign集成ribbon" class="header-anchor">#</a> 6.3 Feign集成Ribbon</h2> <p>利用Ribbon维护了Payment的服务列表信息，并且通过轮询实现了客户端的负载均衡。而与Ribbon不同的是，通过Feign只需要定义服务绑定接口且声明式的方法，优雅而简单的实现了服务调用。</p> <h2 id="_6-4-feign和openfeign的区别"><a href="#_6-4-feign和openfeign的区别" class="header-anchor">#</a> 6.4 Feign和OpenFeign的区别</h2> <table><thead><tr><th>Feign</th> <th>OpenFeign</th></tr></thead> <tbody><tr><td>Feign是Spring Cloud组件中的一种轻量级RestFul的HTTP服务客户端，Feign内置了Ribbon，用来做客户端的负载均衡，去调用服务注册中心的服务，Feign的使用方式是：使用Feign的注解定义接口，调用这个接口，就可以调用服务注册中心的服务</td> <td>OpenFeign是Spring Cloud 在Feign的基础上支持了SpringMVC的注解，如@RequestMapping等等，OpenFeign的@FeignClient可以解析SpringMVC的@RequestMapping注解下的接口，并通过动态代理的方法生产实现类，实现类中做均衡并调用其它服务</td></tr> <tr><td>spring-cloud-starter-feign</td> <td>spring-cloud-starter-openfeign</td></tr></tbody></table> <h2 id="_6-5-openfeign使用步骤"><a href="#_6-5-openfeign使用步骤" class="header-anchor">#</a> 6.5 OpenFeign使用步骤</h2> <h3 id="_6-5-1-引入依赖"><a href="#_6-5-1-引入依赖" class="header-anchor">#</a> 6.5.1 引入依赖</h3> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token comment">&lt;!--openfeign--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="_6-5-2-修改启动类"><a href="#_6-5-2-修改启动类" class="header-anchor">#</a> 6.5.2 修改启动类</h3> <p>激活Feign组件</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableFeignClients</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderFeignMain80</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">OrderFeignMain80</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_6-5-3-添加业务逻辑接口"><a href="#_6-5-3-添加业务逻辑接口" class="header-anchor">#</a> 6.5.3 添加业务逻辑接口</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;cloud-payment-service&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">PaymentFeignService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/payment/get/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">CommonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Payment</span><span class="token punctuation">&gt;</span></span> <span class="token function">getPaymentById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/payment/feign/timeout&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">paymentFeignTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_6-5-4-具体使用"><a href="#_6-5-4-具体使用" class="header-anchor">#</a> 6.5.4 具体使用</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderFeignController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">PaymentFeignService</span> paymentFeignService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/consumer/payment/get/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">CommonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Payment</span><span class="token punctuation">&gt;</span></span> <span class="token function">getPaymentById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">CommonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Payment</span><span class="token punctuation">&gt;</span></span> paymentById <span class="token operator">=</span> paymentFeignService<span class="token punctuation">.</span><span class="token function">getPaymentById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> paymentById<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/consumer/payment/feign/timeout&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">paymentFeignTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//open-feign-ribbon,客户端默认等待一秒钟</span>
        <span class="token keyword">return</span> paymentFeignService<span class="token punctuation">.</span><span class="token function">paymentFeignTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_6-6-openfeign的超时控制"><a href="#_6-6-openfeign的超时控制" class="header-anchor">#</a> 6.6 OpenFeign的超时控制</h2> <p>服务提供者需要超过3秒才能返回数据，但是服务调用者默认只等待1秒，这就会出现超时问题。</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/32.png" alt=""></p> <p>这是因为默认Feign客户端只等待一秒钟，但是服务端处理需要超过3秒钟，导致Feign客户端不想等待了，直接返回报错，这个时候，消费方的OpenFeign就需要增大超时时间</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token comment"># 设置feign客户端超时时间(OpenFeign默认支持ribbon)</span>
<span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
  <span class="token comment"># 指的是建立连接所用的时间,适用于网络状态正常的情况下,两端连接所用的时间</span>
  <span class="token key atrule">ReadTimeout</span><span class="token punctuation">:</span> <span class="token number">5000</span>
  <span class="token comment"># 指的是建立连接后从服务器读取到可用资源所用的时间</span>
  <span class="token key atrule">ConnectTimeout</span><span class="token punctuation">:</span> <span class="token number">5000</span>
</code></pre></div><h2 id="_6-7-openfeign日志打印功能"><a href="#_6-7-openfeign日志打印功能" class="header-anchor">#</a> 6.7 OpenFeign日志打印功能</h2> <h3 id="_6-7-1-概念"><a href="#_6-7-1-概念" class="header-anchor">#</a> 6.7.1 概念</h3> <p>Feign提供了日志打印功能，我们可以通过配置来调整日志级别，从而了解Feign中Http请求的细节，说白了就是对Feign接口的调用情况进行监控和输出。</p> <h3 id="_6-7-2-日志级别"><a href="#_6-7-2-日志级别" class="header-anchor">#</a> 6.7.2 日志级别</h3> <ul><li>NONE：默认的，不显示任何日志</li> <li>BASIC：仅记录请求方法、URL、相应状态码以及执行时间</li> <li>HEADERS：除了BASIC中定义的信息之外，还有请求和响应头的信息</li> <li>FULL：除了HEADERS中定义的信息之外，还有请求和相应的正文及元数据</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FeignConfig</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * feignClient配置日志级别
     *
     * @return
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Logger<span class="token punctuation">.</span>Level</span> <span class="token function">feignLoggerLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 请求和响应的头信息,请求和响应的正文及元数据</span>
        <span class="token keyword">return</span> <span class="token class-name">Logger<span class="token punctuation">.</span>Level</span><span class="token punctuation">.</span>FULL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_6-7-3-修改yml文件"><a href="#_6-7-3-修改yml文件" class="header-anchor">#</a> 6.7.3 修改YML文件</h3> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">logging</span><span class="token punctuation">:</span>
  <span class="token key atrule">level</span><span class="token punctuation">:</span>
    <span class="token comment"># feign日志以什么级别监控哪个接口</span>
    <span class="token key atrule">com.atguigu.springcloud.service.PaymentFeignService</span><span class="token punctuation">:</span> debug
</code></pre></div><h1 id="_7-hystrix断路器"><a href="#_7-hystrix断路器" class="header-anchor">#</a> 7. Hystrix断路器</h1> <p>Hystrix官宣停更，官方推荐使用：resilence4j替换，同时国内Spring Cloud Alibaba 提出了Sentinel实现熔断和限流。但是吧resilence4j不推荐</p> <h2 id="_7-1-概述"><a href="#_7-1-概述" class="header-anchor">#</a> 7.1 概述</h2> <h3 id="_7-1-1-分布式面临的问题"><a href="#_7-1-1-分布式面临的问题" class="header-anchor">#</a> 7.1.1 分布式面临的问题</h3> <p>复杂分布式体系结构中的应用程序有数十个依赖关系，每个依赖关系在某些时候将不可避免地失败（网络卡顿，网络超时）</p> <h3 id="_7-1-2-服务雪崩"><a href="#_7-1-2-服务雪崩" class="header-anchor">#</a> 7.1.2 服务雪崩</h3> <p>多个微服务之间调用的时候，假设微服务A调用微服务B和微服务C，微服务B和微服务C又调用其它的微服务，这就是所谓的“扇出”。如果扇出的链路上某个微服务的调用响应时间过长或者不可用，对微服务A的调用就会占用越来越多的系统资源，进而引起系统崩溃，所谓的 雪崩效应</p> <p>对于高流量的应用来说，单一的后端依赖可能会导致所有服务器上的所有资源都在几秒钟内饱和。比失败更糟糕的是，这些应用程序还可能导致服务之间的延迟增加，备份队列，线程和其它系统资源紧张，导致整个系统发生更多的级联故障，这些都表示需要对故障和延迟进行隔离和管理，以便单个依赖关系的失败，不能取消整个应用程序或系统。</p> <p>通常当你发现一个模块下的某个实例失败后，这时候这个模块依然还会接收流量，然后这个有问题的模块还调用了其他的模块，这样就会发生级联故障，或者叫雪崩</p> <h3 id="_7-1-3-hystrix的诞生"><a href="#_7-1-3-hystrix的诞生" class="header-anchor">#</a> 7.1.3 HyStrix的诞生</h3> <p>Hystrix是一个用于处理分布式系统的延迟和容错的开源库，在分布式系统里，许多依赖不可避免的会调用失败，比如超时，异常等，Hystrix能够保证在一个依赖出问题的情况下，<strong>不会导致整体服务失败，避免级联故障，以提高分布式系统的弹性。</strong></p> <p>断路器 本身是一种开关装置，当某个服务单元发生故障之后，通过断路器的故障监控（类似于熔断保险丝），<strong>向调用方返回一个符合预期的，可处理的备选响应（FallBack），而不是长时间的等待或者抛出调用方无法处理的异常</strong>，这样就保证了服务调用方的线程不会被长时间、不必要地占用，从而避免了故障在分布式系统中蔓延，乃至雪崩。</p> <h3 id="_7-1-4-hystrix作用"><a href="#_7-1-4-hystrix作用" class="header-anchor">#</a> 7.1.4 Hystrix作用</h3> <ul><li>服务降级</li> <li>服务熔断</li> <li>接近实时的监控（Hystrix Dashboard）</li> <li>。。。。</li></ul> <h2 id="_7-2-hystrix重要概念"><a href="#_7-2-hystrix重要概念" class="header-anchor">#</a> 7.2 Hystrix重要概念</h2> <h3 id="_7-2-1-服务降级"><a href="#_7-2-1-服务降级" class="header-anchor">#</a> 7.2.1 服务降级</h3> <p>fallback，假设对方服务不可用了，那么至少需要返回一个兜底的解决方法，即向服务调用方返回一个符合预期的，可处理的备选响应。</p> <p>例如：服务繁忙，请稍后再试，不让客户端等待并立刻返回一个友好的提示，fallback</p> <p><strong>哪些情况会触发降级</strong></p> <ul><li>程序运行异常</li> <li>超时</li> <li>服务熔断触发服务降级</li> <li>线程池/信号量打满也会导致服务降级</li></ul> <h3 id="_7-2-2-服务熔断"><a href="#_7-2-2-服务熔断" class="header-anchor">#</a> 7.2.2 服务熔断</h3> <p>break，类比保险丝达到了最大服务访问后，直接拒绝访问，拉闸断电，然后调用服务降级的方法并返回友好提示</p> <p>一般过程：服务降级 -&gt; 服务熔断 -&gt; 恢复调用链路</p> <h3 id="_7-2-3-服务限流"><a href="#_7-2-3-服务限流" class="header-anchor">#</a> 7.2.3 服务限流</h3> <p>flowlimit，秒杀高并发等操作，严禁一窝蜂的过来拥挤，大家排队，一秒钟N个，有序进行</p> <h2 id="_7-3-hystrix案例"><a href="#_7-3-hystrix案例" class="header-anchor">#</a> 7.3 Hystrix案例</h2> <h3 id="_7-3-1-构建"><a href="#_7-3-1-构建" class="header-anchor">#</a> 7.3.1 构建</h3> <h4 id="_7-3-1-1-引入依赖"><a href="#_7-3-1-1-引入依赖" class="header-anchor">#</a> 7.3.1.1 引入依赖</h4> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token comment">&lt;!--hystrix--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-hystrix<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>配置文件</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8001</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> cloud<span class="token punctuation">-</span>provider<span class="token punctuation">-</span>hystrix<span class="token punctuation">-</span>payment

<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">register-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">fetch-registry</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token comment">#defaultZone: http://eureka7001.com:7001/eureka,http://eureka7002.com:7002/eureka</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka7001.com<span class="token punctuation">:</span>7001/eureka


<span class="token comment">#hystrix:</span>
<span class="token comment">#  command:</span>
<span class="token comment">#    default:</span>
<span class="token comment">#      execution:</span>
<span class="token comment">#        isolation:</span>
<span class="token comment">#          thread:</span>
<span class="token comment">#            timeoutInMilliseconds: 3000</span>
<span class="token comment">#</span>
<span class="token comment">#ribbon:</span>
<span class="token comment">#  ReadTimeout: 5000</span>
<span class="token comment">#  ConnectTimeout: 5000</span>
<span class="token comment">#</span>
<span class="token comment"># 这两种都行</span>
<span class="token key atrule">feign</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token key atrule">default</span><span class="token punctuation">:</span>
        <span class="token key atrule">connect-timeout</span><span class="token punctuation">:</span> <span class="token number">5000</span>
        <span class="token key atrule">read-timeout</span><span class="token punctuation">:</span> <span class="token number">5000</span>
  <span class="token key atrule">hystrix</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

<span class="token key atrule">hystrix</span><span class="token punctuation">:</span>
  <span class="token key atrule">command</span><span class="token punctuation">:</span>
    <span class="token key atrule">default</span><span class="token punctuation">:</span>
      <span class="token key atrule">execution</span><span class="token punctuation">:</span>
        <span class="token key atrule">isolation</span><span class="token punctuation">:</span>
          <span class="token key atrule">thread</span><span class="token punctuation">:</span>
            <span class="token key atrule">timeoutInMilliseconds</span><span class="token punctuation">:</span> <span class="token number">5000</span>
</code></pre></div><h4 id="_7-3-1-2-启动类添加hystrix注解"><a href="#_7-3-1-2-启动类添加hystrix注解" class="header-anchor">#</a> 7.3.1.2 启动类添加Hystrix注解</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token annotation punctuation">@EnableCircuitBreaker</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PaymentHystrixMain8001</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">PaymentHystrixMain8001</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><h4 id="_7-3-1-3-业务类"><a href="#_7-3-1-3-业务类" class="header-anchor">#</a> 7.3.1.3 业务类</h4> <p>使用新的注解 <code>@HystrixCommand</code></p> <p>同时需要在主启动类上新增：<code>@EnableCircuiteBreaker, 其实加@EnableHystrix也是一样的</code>，@EnableHystrix里面带了 @EnableCircuiteBreaker</p> <p>设置8001自身调用超时时间的峰值，峰值内可以正常运行，超过了需要有兜底的方法处理，作为服务降级fallback</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PaymentService</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">paymentInfo_OK</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;线程池: &quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;  paymentInfo_ok, id: &quot;</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@HystrixCommand</span><span class="token punctuation">(</span>fallbackMethod <span class="token operator">=</span> <span class="token string">&quot;paymentInfo_TimeOutHandler&quot;</span><span class="token punctuation">,</span> commandProperties <span class="token operator">=</span> <span class="token punctuation">{</span>
           <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;execution.isolation.thread.timeoutInMilliseconds&quot;</span><span class="token punctuation">,</span>value<span class="token operator">=</span><span class="token string">&quot;5000&quot;</span><span class="token punctuation">)</span>

    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">paymentInfo_TimeOut</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">int</span> timeNumber <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">// 这里弄为3是为了测 order里面的</span>
        <span class="token keyword">int</span> age <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 用于服务降级使用</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>timeNumber <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token string">&quot;线程池: &quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;  paymentInfo_ok, id: &quot;</span> <span class="token operator">+</span> id <span class="token operator">+</span> <span class="token string">&quot;耗时(秒): &quot;</span> <span class="token operator">+</span> timeNumber<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">paymentInfo_TimeOutHandler</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;线程池: &quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; paymentInfo_TimeOutHandler, id: &quot;</span> <span class="token operator">+</span> <span class="token string">&quot;系统繁忙，请稍后再试&quot;</span><span class="token operator">+</span> id <span class="token operator">+</span> <span class="token string">&quot;呜呜呜呜~~~~&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>当服务超过5000ms的时候会执行 paymentInfo_TimeOutHandler方法，或者故意制造异常 <code>int age=10/0;</code></p> <p>或者能接受5s，而运行 8s，超时异常，服务降级触发fallbackMethod</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/34.png" alt=""></p> <h3 id="_7-3-2-高并发测试"><a href="#_7-3-2-高并发测试" class="header-anchor">#</a> 7.3.2 高并发测试</h3> <p>Jmeter高并发测试</p> <p>我们创建20000个线程去访问</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/31.png" alt=""></p> <p>访问刚刚我们写的两个 延时接口</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/33.png" alt="image-20200408202400666"></p> <p>我们会发现当线程多的时候，会直接卡死，甚至把其它正常的接口都已经拖累</p> <p>这是因为我们使用20000个线程去访问那个延时的接口，这样会把该微服务的资源全部集中处理 延时接口，而导致正常的接口资源不够，出现卡顿的现象。</p> <p>同时tomcat的默认工作线程数被打满，没有多余的线程来分解压力和处理。</p> <h3 id="_7-3-3-服务消费者加入"><a href="#_7-3-3-服务消费者加入" class="header-anchor">#</a> 7.3.3 服务消费者加入</h3> <p>刚刚我们能够看到，光是调用服务提供者就不能支持20000的并发量，这个时候，在使用服务消费者的引入，同时请求该接口，这个时候我们就需要在服务消费端设置服务降级了</p> <p>首先启动 hystrix，@EnableHystrix</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableFeignClients</span>
<span class="token annotation punctuation">@EnableHystrix</span> <span class="token comment">// 自带@EnableCircuitBreaker</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderHystrixMain80</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">OrderHystrixMain80</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>然后修改yml</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">register-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">fetch-registry</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka7001.com<span class="token punctuation">:</span>7001/eureka<span class="token punctuation">,</span>http<span class="token punctuation">:</span>//eureka7002.com<span class="token punctuation">:</span>7002/eureka
  <span class="token comment"># 设置feign客户端超时时间(OpenFeign默认支持ribbon)</span>
<span class="token key atrule">feign</span><span class="token punctuation">:</span>
  <span class="token key atrule">hystrix</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre></div><p>只使用这个会使超时时间不生效，feign: hystrix: enabled: true ，官网解释：&quot;Feign将使用断路器包装所有的方法&quot;，也就是将 <code>@FeignClient</code>标记的那个 service 接口下的所有方法进行 hystrix包装（类似在这些方法上加了一个 @HystrixCommand）,这些方法会应用一个默认的超时时间为1s，所以你的service方法也有一个1s的超时时间，service 1s就会报异常，controller立马进入备用方法,controller上的3s就没有效果了</p> <p>改变这个默认超时时间的方法(这里我是在payment上面加的)</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">hystrix</span><span class="token punctuation">:</span>
  <span class="token key atrule">command</span><span class="token punctuation">:</span>
    <span class="token key atrule">default</span><span class="token punctuation">:</span>
      <span class="token key atrule">execution</span><span class="token punctuation">:</span>
        <span class="token key atrule">isolation</span><span class="token punctuation">:</span>
          <span class="token key atrule">thread</span><span class="token punctuation">:</span>
            <span class="token key atrule">timeoutInMilliseconds</span><span class="token punctuation">:</span> <span class="token number">3000</span>

<span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
  <span class="token key atrule">ReadTimeout</span><span class="token punctuation">:</span> <span class="token number">5000</span>
  <span class="token key atrule">ConnectTimeout</span><span class="token punctuation">:</span> <span class="token number">5000</span>
</code></pre></div><p>或者</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">feign</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token key atrule">default</span><span class="token punctuation">:</span>
        <span class="token key atrule">connect-timeout</span><span class="token punctuation">:</span> <span class="token number">5000</span>
        <span class="token key atrule">read-timeout</span><span class="token punctuation">:</span> <span class="token number">5000</span>
  <span class="token key atrule">hystrix</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

<span class="token key atrule">hystrix</span><span class="token punctuation">:</span>
  <span class="token key atrule">command</span><span class="token punctuation">:</span>
    <span class="token key atrule">default</span><span class="token punctuation">:</span>
      <span class="token key atrule">execution</span><span class="token punctuation">:</span>
        <span class="token key atrule">isolation</span><span class="token punctuation">:</span>
          <span class="token key atrule">thread</span><span class="token punctuation">:</span>
            <span class="token key atrule">timeoutInMilliseconds</span><span class="token punctuation">:</span> <span class="token number">5000</span>
</code></pre></div><p>最后我们在feign调用上增加 fallBack</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderHystirxController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">PaymentHystrixService</span> paymentHystrixService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/consumer/payment/hystrix/ok/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">paymentInfo_OK</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> result <span class="token operator">=</span> paymentHystrixService<span class="token punctuation">.</span><span class="token function">paymentInfo_OK</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/consumer/payment/hystrix/timeout/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@HystrixCommand</span><span class="token punctuation">(</span>fallbackMethod <span class="token operator">=</span> <span class="token string">&quot;paymentTimeOutFallbackMethod&quot;</span><span class="token punctuation">,</span>commandProperties <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;execution.isolation.thread.timeoutInMilliseconds&quot;</span><span class="token punctuation">,</span>value<span class="token operator">=</span><span class="token string">&quot;1500&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">paymentInfo_TimeOut</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> age <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> result <span class="token operator">=</span> paymentHystrixService<span class="token punctuation">.</span><span class="token function">paymentInfo_TimeOut</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 超时回调方法</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">paymentTimeOutFallbackMethod</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;我是消费者80, 对方支付系统繁忙，请10s后，再试，或者自己运行出错请检查自己，谢谢啦&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>
</code></pre></div><h2 id="_7-4-解决方案"><a href="#_7-4-解决方案" class="header-anchor">#</a> 7.4 解决方案</h2> <h3 id="_7-4-1-原因"><a href="#_7-4-1-原因" class="header-anchor">#</a> 7.4.1 原因</h3> <p>超时导致服务器变慢，超时不再等待</p> <p>出错，宕机或者程序运行出错，出错要有兜底</p> <p>解决</p> <ul><li>对方服务8001超时了，调用者80不能一直卡死等待，必须有服务降级</li> <li>对方服务8001宕机了，调用者80不能一直卡死，必须有服务降级</li> <li>对方服务8001正常，调用者自己出故障或者有自我要求（自己的等待时间小于服务提供者），自己处理降级</li></ul> <p><strong>目前问题</strong></p> <p>目前异常处理的方法，和业务代码耦合，这就造成耦合度比较高</p> <p>解决方法就是使用统一的服务降级方法</p> <h3 id="_7-4-2-统一的服务降级方法"><a href="#_7-4-2-统一的服务降级方法" class="header-anchor">#</a> 7.4.2 统一的服务降级方法</h3> <p><strong>方法1：</strong></p> <p>除了个别重要核心业务有专属，其它普通的可以通过<code>@DefaultProperties(defaultFallback = &quot;&quot;)</code>，这样通用的和独享的各自分开，避免了代码膨胀，合理减少了代码量</p> <p>可以在Controller处设置 <code>@DefaultProperties(defaultFallback = &quot;payment_Global_FallbackMethod&quot;)</code></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@DefaultProperties</span><span class="token punctuation">(</span>defaultFallback <span class="token operator">=</span> <span class="token string">&quot;payment_Global_FallbackMethod&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderHystrixController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/consumer/payment/hystrix/timeout/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@HystrixCommand</span>  <span class="token comment">// 这个方法也会走全局 fallback</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">paymentInfo_TimeOut</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> age <span class="token operator">=</span> <span class="token number">10</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//方法前挂了，跟后面挂了两种</span>
        <span class="token keyword">return</span> paymentHystrixService<span class="token punctuation">.</span><span class="token function">paymentInfo_TimeOut</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">//下面是全局fallback方法</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">payment_Global_FallbackMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;Global异常处理信息，请稍后再试,/(ㄒoㄒ)/~~&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>方法2：</strong>(这种方法感觉更常用)</p> <p>我们现在还发现，兜底的方法 和 我们的业务代码耦合在一块比较混乱</p> <p>我们可以在feign调用的时候，增加hystrix的服务降级处理的实现类，这样就可以进行解耦</p> <p>格式：<code>@FeignClient(fallback = PaymentFallbackService.class)</code></p> <p>我们要面对的异常主要有</p> <ul><li>运行</li> <li>超时</li> <li>宕机</li></ul> <p>需要新建一个FallbackService实现类，然后通过实现类统一为feign接口里面的方法进行异常处理</p> <p>feign接口</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;cloud-provider-hystrix-payment&quot;</span><span class="token punctuation">,</span> fallback <span class="token operator">=</span> <span class="token class-name">PaymentFallbackService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">PaymentHystrixService</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 正常访问
     *
     * @param id
     * @return
     */</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/payment/hystrix/ok/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">paymentInfo_OK</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 超时访问
     *
     * @param id
     * @return
     */</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/payment/hystrix/timeout/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">paymentInfo_TimeOut</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>实现类</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PaymentFallbackService</span> <span class="token keyword">implements</span> <span class="token class-name">PaymentHystrixService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">paymentInfo_OK</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;--- PaymentFallbackService  fall  paymentInfo_OK vack ，/(ㄒoㄒ)/~~&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">paymentInfo_TimeOut</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;--- PaymentFallbackService  fall  paymentInfo_TimeOut， /(ㄒoㄒ)/~~&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这个时候，如果我们将服务提供方进行关闭，但是我们在客户端做了服务降级处理，让客户端在服务端不可用时，也会获得提示信息，而不会挂起耗死服务器</p> <p>无论如何降级的流程一定会先调用正常方法再调用 fallback方法,熔断以后会跳过正常方法直接调用 fallback方法，所谓熔断后服务不可用就是因为跳过了正常方法直接执行 fallback 方法</p> <h3 id="_7-4-3-服务熔断"><a href="#_7-4-3-服务熔断" class="header-anchor">#</a> 7.4.3 服务熔断</h3> <p>服务熔断也是服务降级的一个 特例，降解是思想，熔断是对降解的具体实现，但是降解的实现并不止熔断这一种</p> <h4 id="_7-4-3-1-熔断概念"><a href="#_7-4-3-1-熔断概念" class="header-anchor">#</a> 7.4.3.1 熔断概念</h4> <p>熔断机制是应对雪崩效应的一种微服务链路保护机制，当扇出链路的某个微服务不可用或者响应时间太长时，会进行服务的降级，进而熔断该节点微服务的调用，快速返回错误的响应状态</p> <p>当检测到该节点微服务调用响应正常后，恢复调用链路</p> <p>在Spring Cloud框架里，熔断机制通过Hystrix实现，Hystrix会监控微服务间调用的状况，当失败的调用到一定的阈值，缺省是5秒内20次调用失败，就会启动熔断机制，熔断机制的注解还是 <code>@HystrixCommand</code></p> <p>来源，微服务提出者马丁福勒：https://martinfowler.com/bliki/CircuitBreaker.html</p> <blockquote><p>这个简单的断路器避免了在电路打开时进行保护调用，但是当情况恢复正常时需要外部干预来重置它。对于建筑物中的断路器，这是一种合理的方法，但是对于软件断路器，我们可以让断路器本身检测底层调用是否再次工作。我们可以通过在适当的间隔之后再次尝试protected调用来实现这种自重置行为，并在断路器成功时重置它</p></blockquote> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/35.png" style="zoom:50%;"> <p>熔断器的三种状态：打开，关闭，半开</p> <p>这里提出了 半开的概念，首先打开一半的，然后慢慢的进行恢复，最后在把断路器关闭</p> <p>降级 -&gt; 熔断 -&gt; 恢复</p> <p>这里我们在服务提供方 8001，增加服务熔断</p> <p>这里有四个字段</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 是否开启断路器</span>
<span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;circuitBreaker.enabled&quot;</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

<span class="token comment">// 请求次数</span>
<span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;circuitBreaker.requestVolumeThreshold&quot;</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">&quot;10&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

<span class="token comment">// 时间窗口期/时间范文</span>
<span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;circuitBreaker.sleepWindowInMilliseconds&quot;</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">&quot;10000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

<span class="token comment">// 失败率达到多少后跳闸</span>
<span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;circuitBreaker.errorThresholdPercentage&quot;</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">&quot;60&quot;</span><span class="token punctuation">)</span><span class="token class-name">Copy</span> <span class="token keyword">to</span> <span class="token namespace">clipboardErrorCopied</span>
</code></pre></div><p>时间窗口期意味着5s后断路器变成半开状态</p> <p>首先是是否开启熔断器，然后是在一个时间窗口内，有60%的失败，那么就启动断路器，也就是10次里面，6次失败，完整代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token comment">/**
     * 在10秒窗口期中10次请求有6次是请求失败的,断路器将起作用
     * @param id
     * @return
     */</span>
    <span class="token annotation punctuation">@HystrixCommand</span><span class="token punctuation">(</span>
            fallbackMethod <span class="token operator">=</span> <span class="token string">&quot;paymentCircuitBreaker_fallback&quot;</span><span class="token punctuation">,</span> commandProperties <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;circuitBreaker.enabled&quot;</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">// 是否开启断路器</span>
            <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;circuitBreaker.requestVolumeThreshold&quot;</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">&quot;10&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">// 请求次数</span>
            <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;circuitBreaker.sleepWindowInMilliseconds&quot;</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">&quot;10000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">// 时间窗口期/时间范文 </span>
            <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;circuitBreaker.errorThresholdPercentage&quot;</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">&quot;60&quot;</span><span class="token punctuation">)</span><span class="token comment">// 失败率达到多少后跳闸</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">paymentCircuitBreaker</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;*****id不能是负数&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">String</span> serialNumber <span class="token operator">=</span> <span class="token class-name">IdUtil</span><span class="token punctuation">.</span><span class="token function">simpleUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\t&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;调用成功,流水号:&quot;</span> <span class="token operator">+</span> serialNumber<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>当断路器被打开的时候，即使是正确的请求，该方法也会被断路</p> <h3 id="_7-4-4-总结"><a href="#_7-4-4-总结" class="header-anchor">#</a> 7.4.4 总结</h3> <h4 id="_7-4-4-1-熔断类型"><a href="#_7-4-4-1-熔断类型" class="header-anchor">#</a> 7.4.4.1 熔断类型</h4> <ul><li>熔断打开：请求不再进行调用当前服务，内部设置时钟一般为MTTR（平均故障处理时间），当打开时长达所设时钟则进入半熔断状态</li> <li>熔断关闭：熔断关闭不会对服务进行熔断</li> <li>熔断半开：部分请求根据规则调用当前服务，如果请求成功且符合规则，则认为当前服务恢复正常，关闭熔断</li></ul> <h4 id="_7-4-4-2-断路器启动条件"><a href="#_7-4-4-2-断路器启动条件" class="header-anchor">#</a> 7.4.4.2 断路器启动条件</h4> <p><img src="http://moxi159753.gitee.io/learningnotes/SpringCloud/SpringCloud2020/7_Hystrix%E4%B8%AD%E7%9A%84%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7%E5%92%8C%E7%86%94%E6%96%AD/images/image-20200409114527145.png" alt="image-20200409114527145"></p> <p>涉及到断路器的三个重要参数：<strong>快照时间窗，请求总阈值，错误百分比阈值</strong></p> <ul><li>快照时间窗：断路器确定是否打开需要统计一些请求和错误数据，而统计的时间范围就是快照时间窗，默认为最近的10秒。</li> <li>请求总数阈值：在快照时间窗口内，必须满足请求总数阈值才有资格熔断。默认为20，意味着在10秒内，如果hystrix的调用总次数不足20次，即使所有请求都超时或者其他原因失败，断路器都不会打开。</li> <li>错误百分比阈值：当请求总数在快照时间窗内超过了阈值，比如发生了30次调用，并且有15次发生了超时异常，也就是超过了50的错误百分比，在默认设定的50%阈值情况下，这时候就会将断路器打开</li></ul> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/36.png" style="zoom:67%;"> <p><strong>开启和关闭的条件</strong></p> <ul><li>当满足一定阈值的时候（**默认10秒内超过20个请求）</li> <li>当失败率达到一定的时候（默认10秒内超过50%的请求失败）</li> <li>到达以上阈值，断路器将会开启</li> <li>当开启的时候，所有请求都不会进行转发</li> <li>一段时间之后（默认是5秒），这个时候断路器是半开状态，会让其中一个请求进行转发。如果成功，断路器会关闭，若失败，继续开启，重复4和5</li></ul> <p>断路器开启后</p> <ul><li>再有请求调用的时候，将不会调用主逻辑，而是直接调用降级fallback，通过断路器，实现了自动的发现错误并将降级逻辑切换为主逻辑，减少相应延迟的效果。</li> <li>原来的主逻辑如何恢复？
<ul><li>对于这个问题，Hystrix实现了自动恢复功能，当断路器打开，对主逻辑进行熔断之后，hystrix会启动一个休眠时间窗，在这个时间窗内，降级逻辑是临时的成为主逻辑，当休眠时间窗到期，断路器将进入半开状态，释放一次请求到原来的主逻辑上，如果此次请求正常返回，断路器将继续闭合，主逻辑恢复，如果这次请求依然有问题，断路器继续保持打开状态，休眠时间窗重新计时。</li></ul></li></ul> <p>就是假如调用了很多次错误的，突然调用一次正确的，正确的也是显示错误的，正确的请求多了逐渐恢复正确的</p> <h3 id="_7-4-5-服务限流"><a href="#_7-4-5-服务限流" class="header-anchor">#</a> 7.4.5 服务限流</h3> <p>后面讲解Sentinel的时候进行说明</p> <h2 id="_7-5-hystrix工作流程"><a href="#_7-5-hystrix工作流程" class="header-anchor">#</a> 7.5 Hystrix工作流程</h2> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/37.png" alt=""></p> <p>蓝色：调用路径</p> <p>红色：返回路径</p> <p>完整的请求路线：</p> <ol><li>选择一个Hystrix注册方式</li> <li>二选一即可</li> <li>判断缓存中是否包含需要返回的内容（如果有直接返回）</li> <li>断路器是否为打开状态（如果是，直接跳转到8，返回）</li> <li>断路器为健康状态，判断是否有可用资源（没有，直接跳转8）</li> <li>构造方法和Run方法</li> <li>将正常，超时，异常的消息发送给断路器</li> <li>调用getFallback方法，也就是服务降级</li> <li>直接返回正确结果</li></ol> <h2 id="_7-6-服务监控hystrixdashboard"><a href="#_7-6-服务监控hystrixdashboard" class="header-anchor">#</a> 7.6 服务监控HystrixDashboard</h2> <h3 id="_7-6-1-概述"><a href="#_7-6-1-概述" class="header-anchor">#</a> 7.6.1 概述</h3> <p>除了隔离依赖服务的调用以外，Hystrix还提供了准实时的调用监控（Hystrix Dashboard），Hystrix会持续地记录所有通过Hystrix发起的请求的执行信息，并以统计报表和图形化的形式展示给用户，包括每秒执行多少请求，成功多少请求，失败多少，Netflix通过Hystrix-metrics-event-stream项目实现了对以上指标的监控，SpringCloud也提供了HystrixDashboard整合，对监控内容转化成可视化页面</p> <h3 id="_7-6-2-搭建"><a href="#_7-6-2-搭建" class="header-anchor">#</a> 7.6.2 搭建</h3> <p>引入依赖</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token comment">&lt;!--hystrix dashboard--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-hystrix-dashboard<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!--监控--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-actuator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>application.yml添加端口</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9001</span>
</code></pre></div><p>主启动类：配置注解<code>@EnableHystrixDashboard</code></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableHystrixDashboard</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HystrixDashboardMain9001</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">HystrixDashboardMain9001</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>同时，最后我们需要注意，每个服务类想要被监控的，都需要在pom文件中，添加一下注解</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>监控<span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">-</span>actuator<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
</code></pre></div><p>同时在服务提供者的启动类上，需要添加以下的内容</p> <div class="language- extra-class"><pre class="language-text"><code>@SpringBootApplication
@EnableDiscoveryClient
@EnableCircuitBreaker
public class PaymentHystrixMain8001 {
    public static void main(String[] args) {
        SpringApplication.run(PaymentHystrixMain8001.class, args);
    }
    /**
     * 此配置是为了服务监控而配置，与服务容错本身无观，springCloud 升级之后的坑
     * ServletRegistrationBean因为springboot的默认路径不是/hystrix.stream
     * 只要在自己的项目中配置上下面的servlet即可
     * @return
     */
    @Bean
    public ServletRegistrationBean getServlet(){
        HystrixMetricsStreamServlet streamServlet = new HystrixMetricsStreamServlet();
        ServletRegistrationBean&lt;HystrixMetricsStreamServlet&gt; registrationBean = new ServletRegistrationBean&lt;&gt;(streamServlet);
        registrationBean.setLoadOnStartup(1);
        registrationBean.addUrlMappings(&quot;/hystrix.stream&quot;);
        registrationBean.setName(&quot;HystrixMetricsStreamServlet&quot;);
        return registrationBean;
    }
}
</code></pre></div><p>输入以下地址，进入Hystrix的图形化界面</p> <div class="language-java extra-class"><pre class="language-java"><code>http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">9001</span><span class="token operator">/</span>hystrix
</code></pre></div><p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/38.png" alt=""></p> <h3 id="_7-6-3-使用监控"><a href="#_7-6-3-使用监控" class="header-anchor">#</a> 7.6.3 使用监控</h3> <p>我们需要使用当前hystrix需要监控的端口号，也就是使用 9001 去监控 8001，即使用hystrix dashboard去监控服务提供者的端口号</p> <p><img src="http://moxi159753.gitee.io/learningnotes/SpringCloud/SpringCloud2020/7_Hystrix%E4%B8%AD%E7%9A%84%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7%E5%92%8C%E7%86%94%E6%96%AD/images/image-20200409122102137.png" alt="image-20200409122102137"></p> <p>然后我们运行</p> <div class="language- extra-class"><pre class="language-text"><code>http://localhost:8001/payment/circuit/31
</code></pre></div><p>就能够发现Hystrix Dashboard能够检测到我们的请求</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/39.png" alt=""></p> <p>假设我们访问错误的方法后</p> <div class="language- extra-class"><pre class="language-text"><code>http://localhost:8001/payment/circuit/-31
</code></pre></div><p>我们能够发现，此时断路器处于开启状态，并且错误率百分100</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/40.png" alt=""></p> <p>如何看懂图</p> <p>首先是七种颜色</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/41.png" alt=""></p> <p>每个颜色都对应的一种结果</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/42.png" alt=""></p> <p>然后是里面的圆</p> <p>实心圆：共有两种含义。它通过颜色的变化代表了实例的健康程度，它的健康程度从</p> <p>绿色 &lt; 黄色 &lt; 橙色 &lt;红色，递减</p> <p>该实心圆除了颜色变化之外，它的大小也会根据实例的请求流量发生变化，流量越大该实心圆就越大，所以通过该实心圆的展示，就可以快速在大量的实例中快速发现故障实例和高压力实例</p> <p>曲线：用于记录2分钟内流量的相对变化，可以通过它来观察到流量的上升和下降趋势</p> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/43.png" style="zoom:50%;"> <h1 id="_8-服务网关-gateway"><a href="#_8-服务网关-gateway" class="header-anchor">#</a> 8. 服务网关（gateway）</h1> <p>zuul目前已经出现了分歧，zuul 升级到 Zuul2的时候出现了内部分歧，并且导致Zuul的核心人员的离职，导致Zuul2一直跳票，等了两年，目前造成的局面是Zuul已经没人维护，Zuul2一直在开发中</p> <p>目前主流的服务网关采用的是Spring Cloud 社区推出了 Gateway</p> <ul><li>Zuul</li></ul> <p>官网：https://github.com/Netflix/zuul/wiki</p> <blockquote><p>Zuul是所有来自设备和web站点到Netflix流媒体应用程序后端的请求的前门。作为一个边缘服务应用程序，Zuul的构建是为了支持动态路由、监视、弹性和安全性。它还可以根据需要将请求路由到多个Amazon自动伸缩组。</p></blockquote> <h2 id="_8-1-gateway"><a href="#_8-1-gateway" class="header-anchor">#</a> 8.1 Gateway</h2> <h3 id="_8-1-1-介绍"><a href="#_8-1-1-介绍" class="header-anchor">#</a> 8.1.1 介绍</h3> <p>Cloud全家桶有个很重要的组件就是网关，在1.X版本中都是采用Zuul网关，但在2.X版本中，zuul的升级一直跳票，SpringCloud最后自己研发了一个网关替代Zuul，那就是SpringCloudGateway，一句话Gateway是原来Zuul 1.X 版本的替代品</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/44.png" alt=""></p> <p>Gateway是在Spring生态系统之上构建的API网关服务，基于Spring 5，Spring Boot 2 和 Project Reactor等技术。Gateway旨在提供一种简单而且有效的方式来对API进行路由，以及提供一些强大的过滤器功能，例如：熔断，限流，重试等。</p> <p>Spring Cloud Gateway 是Spring Cloud的一个全新项目，作为Spring Cloud生态系统中的网关，目标是替代Zuul，在Spring Cloud 2.0以上版本中，没有对新版本的Zuul 2.0以上最新高性能版本进行集成，仍然还是使用的Zuul 1.X非Reactor模式的老版本，而为了提高网关的性能，Spring Cloud Gateway是基于WebFlux框架实现的，而WebFlux框架底层则使用了高性能的Reactor模式通信框架Netty。</p> <p>Spring Cloud Gateway的目标提供统一的路由方式，且基于Filter链的方式提供了网关基本的功能，例如：安全，监控、指标 和 限流。</p> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/45.png" style="zoom:50%;"> <h3 id="_8-1-2-能做啥"><a href="#_8-1-2-能做啥" class="header-anchor">#</a> 8.1.2 能做啥</h3> <ul><li>反向代理</li> <li>鉴权</li> <li>流量控制</li> <li>熔断</li> <li>日志监控</li></ul> <h3 id="_8-1-3-使用场景"><a href="#_8-1-3-使用场景" class="header-anchor">#</a> 8.1.3 使用场景</h3> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/46.png" style="zoom:50%;"> <p>网关可以想象成是所有服务的入口</p> <h3 id="_8-1-4-为什么选用gateway"><a href="#_8-1-4-为什么选用gateway" class="header-anchor">#</a> 8.1.4 为什么选用Gateway</h3> <p>目前已经有了Zuul了，为什么还要开发出Gateway呢？</p> <p>一方面是因为Zuul 1.0已经进入了维护阶段，而且Gateway是Spring Cloud团队研发的，属于亲儿子，值得信赖，并且很多功能Zuul都没有用起来，同时Gateway也非常简单便捷</p> <p>Gateway是基于异步非阻塞模型上进行开发的，性能方面不需要担心。虽然Netflix早就发布了Zuul 2.X，但是Spring Cloud没有整合计划，因为NetFlix相关组件都进入维护期，随意综合考虑Gateway是很理想的网关选择。</p> <h3 id="_8-1-5-gateway特性"><a href="#_8-1-5-gateway特性" class="header-anchor">#</a> 8.1.5 Gateway特性</h3> <p>基于Spring Framework 5，Project Reactor 和Spring boot 2.0 进行构建</p> <ul><li>动态路由，能匹配任何请求属性</li> <li>可以对路由指定Predicate（断言） 和 Filter（过滤器）</li> <li>集成Hystrix的断路器功能</li> <li>集成Spring Cloud服务发现功能</li> <li>易于编写Predicate 和 Filter</li> <li>请求限流功能</li> <li>支持路径重写</li></ul> <h3 id="_8-1-6-spring-cloud-gateway-和-zuul的区别"><a href="#_8-1-6-spring-cloud-gateway-和-zuul的区别" class="header-anchor">#</a> 8.1.6 Spring Cloud Gateway 和 Zuul的区别</h3> <p>在Spring Cloud Gateway Finchley正式版发布之前，Spring Cloud推荐网关是NetFlix提供的Zuul</p> <ul><li>Zuul 1.X 是一个基于<strong>阻塞IO</strong>的API Gateway</li> <li>Zuul 1.x 基于Servlet 2.5使用阻塞架构，它不支持任何场连接，Zuul的设计模式和Nginx比较像，每次IO操作都是从工作线程中选择一个执行，请求线程被阻塞到工作线程完成，但是差别是Nginx用C++实现，Zuul用Java实现，而JVM本身会有第一次加载较慢的情况，使得Zuul的性能较差。</li> <li>Zuul 2.X理念更先进，想基于Netty非阻塞和支持长连接，但Spring Cloud目前还没有整合。Zuul 2.X的性能相比于1.X有较大提升，在性能方面，根据官方提供的基准测试，Spring Cloud Gateway的RPS（每秒请求数）是Zuul的1.6倍。</li> <li>Spring Cloud Gateway建立在Spring 5，Spring Boot 2.X之上，使用非阻塞API</li> <li>Spring Cloud Gateway还支持WebSocket，并且与Spring紧密集成拥有更好的开发体验。</li></ul> <p>Spring Cloud 中所集成的Zuul版本，采用的是Tomcat容器，使用的还是传统的Servlet IO处理模型</p> <p>Servlet的生命周期中，Servlet由Servlet Container进行生命周期管理。</p> <p>Container启动时构建servlet对象，并调用servlet init()进行初始化</p> <p>Container运行时接收请求，并为每个请求分配一个线程，（一般从线程池中获取空闲线程），然后调用Service</p> <p>container关闭时，调用servlet destory() 销毁servlet</p> <p><img src="http://moxi159753.gitee.io/learningnotes/SpringCloud/SpringCloud2020/8_%E6%9C%8D%E5%8A%A1%E7%BD%91%E5%85%B3Gateway/images/image-20200409145343133.png" alt="image-20200409145343133"></p> <p>上述模式的缺点：</p> <p>servlet是一个简单的网络IO模型，当请求进入Servlet container时，servlet container就会为其绑定一个线程，在并发不高的场景下，这种网络模型是适用的，但是一旦高并发（Jmeter测试），线程数就会上涨，而线程资源代价是昂贵的（上下文切换，内存消耗大），严重影响了请求的处理时间。在一些简单业务场景下，不希望为每个Request分配一个线程，只需要1个或几个线程就能应对极大并发的请求，这种业务场景下Servlet模型没有优势。</p> <p>所以Zuul 1.X是基于Servlet之上的一种阻塞式锤模型，即Spring实现了处理所有request请求的Servlet（DispatcherServlet）并由该Servlet阻塞式处理，因此Zuul 1.X无法摆脱Servlet模型的弊端</p> <h3 id="_8-1-7-webflux框架"><a href="#_8-1-7-webflux框架" class="header-anchor">#</a> 8.1.7 WebFlux框架</h3> <p>传统的Web框架，比如Struts2，Spring MVC等都是基于Servlet API 与Servlet容器基础之上运行的，但是在Servlet 3.1之后有了异步非阻塞的支持，而WebFlux是一个典型的非阻塞异步的框架，它的核心是基于Reactor的相关API实现的，相对于传统的Web框架来说，它可以运行在如 Netty，Undertow 及支持Servlet3.1的容器上。非阻塞式 + 函数式编程（Spring5必须让你使用Java8）</p> <p>Spring WebFlux是Spring 5.0引入的新的响应式框架，区别与Spring MVC，他不依赖Servlet API，它是完全异步非阻塞的，并且基于Reactor来实现响应式流规范。</p> <h2 id="_8-2-三大核心概念"><a href="#_8-2-三大核心概念" class="header-anchor">#</a> 8.2 三大核心概念</h2> <h3 id="_8-2-1-route-路由"><a href="#_8-2-1-route-路由" class="header-anchor">#</a> 8.2.1 Route 路由</h3> <p>路由就是构建网关的基本模块，它由ID，目标URI，一系列的断言和过滤器组成，如果断言为True则匹配该路由</p> <h3 id="_8-2-2-predicate-断言"><a href="#_8-2-2-predicate-断言" class="header-anchor">#</a> 8.2.2 Predicate 断言</h3> <p>参考的Java8的 <code>java.util.function.Predicate</code></p> <p>开发人员可以匹配HTTP请求中的所有内容，例如请求头和请求参数，如果请求与断言想匹配则进行路由</p> <h3 id="_8-2-3-filter-过滤"><a href="#_8-2-3-filter-过滤" class="header-anchor">#</a> 8.2.3 Filter 过滤</h3> <p>指的是Spring框架中GatewayFilter的实例，使用过滤器，可以在请求被路由前或者之后对请求进行修改。</p> <h2 id="_8-3-gateway工作流程"><a href="#_8-3-gateway工作流程" class="header-anchor">#</a> 8.3 Gateway工作流程</h2> <p>Web请求通过一些匹配条件，定位到真正的服务节点，并在这个转发过程的前后，进行了一些精细化的控制。</p> <p>Predicate就是我们的匹配条件，而Filter就可以理解为一个无所不能的拦截器，有了这两个元素，在加上目标URL，就可以实现一个具体的路由了。</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/47.png" alt=""></p> <p>客户端向Spring Cloud Gateway发出请求，然后在Gateway Handler Mapping中找到与请求相匹配的路由，将其发送到Gateway Web Handler。</p> <p>Handler在通过指定的过滤器链来将请求发送到我们实际的服务执行业务逻辑，然后返回。</p> <p>过滤器之间用虚线分开是因为过滤器可能会在发送代理请求前（pre）或之后（post）执行业务逻辑。</p> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/48.png" style="zoom:50%;"> <p>Filter在 Pre 类型的过滤器可以做参数校验，权限校验，流量监控，日志输出，协议转换等。</p> <p>在 Post类型的过滤器中可以做响应内容，响应头的修改，日志的输出，流量监控等有着非常重要的作用。</p> <p>Gateway的核心逻辑：路由转发 + 执行过滤链</p> <h2 id="_8-4-入门配置"><a href="#_8-4-入门配置" class="header-anchor">#</a> 8.4 入门配置</h2> <h3 id="_8-4-1-引入依赖"><a href="#_8-4-1-引入依赖" class="header-anchor">#</a> 8.4.1 引入依赖</h3> <div class="language- extra-class"><pre class="language-text"><code>&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-gateway&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre></div><p>需要说明的是 gateway里面有 webmvc 依赖，不需要加web的依赖，如果必要添加，需要进行排除，其他有的话也需要进行排除</p> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/49.png" style="zoom:50%;"> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/50.png" alt="50" style="zoom:50%;"> <div class="language-xml extra-class"><pre class="language-xml"><code>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.jiang<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
          <span class="token comment">&lt;!--
               	这里面有spring-boot-starter-web
            --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>common_utils<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span> 
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!--
                1. webflux与webmvc不兼容，否则会项目启动不起来
            --&gt;</span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-webmvc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-tomcat<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-gateway<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-webmvc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="_8-4-2-修改yml"><a href="#_8-4-2-修改yml" class="header-anchor">#</a> 8.4.2 修改YML</h3> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9527</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> cloud<span class="token punctuation">-</span>gateway
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">locator</span><span class="token punctuation">:</span>
          <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment">#开启从注册中心动态创建路由的功能，利用微服务名进行路由</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> payment_routh <span class="token comment">#payment_route    #路由的ID，没有固定规则但要求唯一，建议配合服务名</span>
          <span class="token comment">#uri: http://localhost:8001          #匹配后提供服务的路由地址</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//cloud<span class="token punctuation">-</span>payment<span class="token punctuation">-</span>service <span class="token comment">#匹配后提供服务的路由地址</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/payment/get/<span class="token important">**</span>         <span class="token comment"># 断言，路径相匹配的进行路由</span>

        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> payment_routh2 <span class="token comment">#payment_route    #路由的ID，没有固定规则但要求唯一，建议配合服务名</span>
<span class="token comment">#          uri: http://localhost:8001          #匹配后提供服务的路由地址</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//cloud<span class="token punctuation">-</span>payment<span class="token punctuation">-</span>service <span class="token comment">#匹配后提供服务的路由地址</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/payment/lb/<span class="token important">**</span>         <span class="token comment"># 断言，路径相匹配的进行路由</span>
            <span class="token comment">#- After=2020-02-21T15:51:37.485+08:00[Asia/Shanghai]</span>
            <span class="token comment">#- Cookie=username,zzyy</span>
            <span class="token comment">#- Header=X-Request-Id, \d+  # 请求头要有X-Request-Id属性并且值为整数的正则表达式</span>

<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> cloud<span class="token punctuation">-</span>gateway<span class="token punctuation">-</span>service
  <span class="token key atrule">client</span><span class="token punctuation">:</span> <span class="token comment">#服务提供者provider注册进eureka服务列表内</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">register-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">fetch-registry</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka7001.com<span class="token punctuation">:</span>7001/eureka
</code></pre></div><h3 id="_8-4-3-访问"><a href="#_8-4-3-访问" class="header-anchor">#</a> 8.4.3 访问</h3> <p>在添加网关之前，我们的访问是</p> <div class="language- extra-class"><pre class="language-text"><code>http://localhost:8001/payment/get/31
</code></pre></div><p>添加网关之后，我们的访问路径是</p> <div class="language- extra-class"><pre class="language-text"><code>http://localhost:9527/payment/get/31
</code></pre></div><p>这么做的好处是慢慢淡化我们真实的IP端口号，这点与nginx相似，路由转发</p> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/52.png" style="zoom:67%;"> <h3 id="_8-4-4-路由匹配"><a href="#_8-4-4-路由匹配" class="header-anchor">#</a> 8.4.4 路由匹配</h3> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/51.png" alt=""></p> <h3 id="_8-4-5-路由配置的两种方式"><a href="#_8-4-5-路由配置的两种方式" class="header-anchor">#</a> 8.4.5 路由配置的两种方式</h3> <ul><li>在配置文件yml中配置</li> <li>代码中注入RouteLocator的Bean</li></ul> <p>这种不推荐，很繁琐</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GateWayConfig</span> <span class="token punctuation">{</span>

    <span class="token comment">// 配置了一个id为route-name的路由规则，当访问地址 http://localhost:9527/guonei时，会自动转发到</span>
    <span class="token comment">// 地址 http;//news.baidu.com/guonei</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RouteLocator</span> <span class="token function">customRouteLocator</span><span class="token punctuation">(</span><span class="token class-name">RouteLocatorBuilder</span> routeLocatorBuilder<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">RouteLocatorBuilder<span class="token punctuation">.</span>Builder</span> routes <span class="token operator">=</span> routeLocatorBuilder<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        routes<span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;path route atguigu&quot;</span><span class="token punctuation">,</span>
                r <span class="token operator">-&gt;</span>r<span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token string">&quot;/guonei&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">uri</span><span class="token punctuation">(</span><span class="token string">&quot;https://www.baidu.com&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> routes<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_8-5-通过微服务名实现动态路由"><a href="#_8-5-通过微服务名实现动态路由" class="header-anchor">#</a> 8.5 通过微服务名实现动态路由</h2> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/53.png" style="zoom:50%;"> <p>默认情况下Gateway会根据注册中心的服务列表，以注册中心上微服务名为路径创建动态路由进行转发，从而实现动态路由的功能。</p> <p>首先需要开启从注册中心动态创建路由的功能，利用微服务名进行路由</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> cloud<span class="token punctuation">-</span>gateway
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">locator</span><span class="token punctuation">:</span>
          <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 开启从注册中心动态创建路由的功能，利用微服务名称进行路由</span>
</code></pre></div><p>URL换成服务名</p> <div class="language- extra-class"><pre class="language-text"><code>uri: lb://CLOUD-PAYMENT-SERVICE
</code></pre></div><h2 id="_8-6-predicate的使用"><a href="#_8-6-predicate的使用" class="header-anchor">#</a> 8.6 Predicate的使用</h2> <h3 id="_8-6-1-概念"><a href="#_8-6-1-概念" class="header-anchor">#</a> 8.6.1 概念</h3> <p>断言，路径相匹配的进行路由,匹配条件</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/54.png" alt=""></p> <p>Spring Cloud Gateway将路由匹配作为Spring WebFlux HandlerMapping基础架构的一部分</p> <p>Spring Cloud Gateway包括许多内置的Route Predicate 工厂，所有这些Predicate都与Http请求的不同属性相匹配，多个Route Predicate工厂可以进行组合</p> <p>Spring Cloud Gateway创建Route对象时，使用RoutePredicateFactory创建Predicate对象，Predicate对象可以赋值给Route，SpringCloudGateway包含许多内置的RoutePredicateFactores。</p> <p>所有这些谓词都匹配Http请求的不同属性。多种谓词工厂可以组合，并通过逻辑 and</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/55.png" alt=""></p> <h3 id="_8-6-2-常用的predicate"><a href="#_8-6-2-常用的predicate" class="header-anchor">#</a> 8.6.2 常用的Predicate</h3> <ul><li><p>After Route Predicate：在什么时间之后执行</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/56.png" alt=""></p></li> <li><p>Before Route Predicate：在什么时间之前执行</p></li> <li><p>Between Route Predicate：在什么时间之间执行</p></li> <li><p>Cookie Route Predicate：Cookie级别</p> <p>常用的测试工具：</p> <ul><li>jmeter</li> <li>postman</li> <li>curl</li></ul> <div class="language- extra-class"><pre class="language-text"><code>// curl命令进行测试，携带Cookie
curl http://localhost:9527/payment/lb --cookie &quot;username=zzyy&quot;
</code></pre></div></li> <li><p>Header Route Predicate：携带请求头</p></li> <li><p>Host Route Predicate：什么样的URL路径过来</p></li> <li><p>Method Route Predicate：什么方法请求的，Post，Get</p></li> <li><p>Path Route Predicate：请求什么路径 <code>- Path=/api-web/**</code></p></li> <li><p>Query Route Predicate：带有什么参数的</p></li></ul> <h2 id="_8-7-filter的使用"><a href="#_8-7-filter的使用" class="header-anchor">#</a> 8.7 Filter的使用</h2> <h3 id="_8-7-1-概念"><a href="#_8-7-1-概念" class="header-anchor">#</a> 8.7.1 概念</h3> <p>路由过滤器可用于修改进入的HTTP请求和返回的HTTP响应，路由过滤器只能指定路由进行使用，立即为一个无所不能的拦截器</p> <p>Spring Cloud Gateway内置了多种路由过滤器，他们都由GatewayFilter的工厂类来产生的</p> <h3 id="_8-7-2-spring-cloud-gateway-filter"><a href="#_8-7-2-spring-cloud-gateway-filter" class="header-anchor">#</a> 8.7.2 Spring Cloud Gateway Filter</h3> <p>生命周期：only Two：pre，Post</p> <p>种类：Only Two</p> <ul><li>GatewayFilter</li> <li>GlobalFilter</li></ul> <h3 id="_8-7-3-自定义过滤器"><a href="#_8-7-3-自定义过滤器" class="header-anchor">#</a> 8.7.3 自定义过滤器</h3> <p>主要作用：</p> <ul><li>全局日志记录</li> <li>统一网关鉴权</li></ul> <p>需要实现接口：<code>implements GlobalFilter, Ordered</code></p> <p>全局过滤器代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyLogGateWayFilter</span> <span class="token keyword">implements</span> <span class="token class-name">GlobalFilter</span><span class="token punctuation">,</span> <span class="token class-name">Ordered</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;come in global filter: {}&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ServerHttpRequest</span> request <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> uname <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getQueryParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFirst</span><span class="token punctuation">(</span><span class="token string">&quot;uname&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>uname <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;用户名为null，非法用户&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setStatusCode</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>NOT_ACCEPTABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 放行</span>
        <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 过滤器加载的顺序 越小,优先级别越高
     *
     * @return
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这样就无法直接得到结果了</p> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/57.png" style="zoom:50%;"> <h1 id="_9-分布式配置中心springcloudconfig"><a href="#_9-分布式配置中心springcloudconfig" class="header-anchor">#</a> 9. 分布式配置中心SpringCloudConfig</h1> <h2 id="_9-1-概述"><a href="#_9-1-概述" class="header-anchor">#</a> 9.1 概述</h2> <h3 id="_9-1-1-面临的问题"><a href="#_9-1-1-面临的问题" class="header-anchor">#</a> 9.1.1 面临的问题</h3> <p>微服务意味着要将单体应用中的业务拆分成一个个子服务，每个服务的粒度相对较小，因此系统中会出现大量的服务，由于每个服务都需要必要的配置信息才能运行，所以一套集中式，动态的配置管理设施是必不可少的。</p> <p>SpringCloud提供了ConfigServer来解决这个问题，原来四个微服务，需要配置四个application.yml，但需要四十个微服务，那么就需要配置40份配置文件，我们需要做的就是一处配置，到处生效。</p> <p>所以这个时候就需要一个统一的配置管理</p> <h3 id="_9-1-2-是什么"><a href="#_9-1-2-是什么" class="header-anchor">#</a> 9.1.2 是什么</h3> <p>SpringCloud Config为微服务架构中的微服务提供集中化的外部配置支持，配置服务器为各个不同微服务应用提供了一个中心化的外部配置。</p> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/58.png" style="zoom:67%;"> <h3 id="_9-1-3-怎么玩"><a href="#_9-1-3-怎么玩" class="header-anchor">#</a> 9.1.3 怎么玩</h3> <p>服务端也称为分布式配置中心，它是一个独立的微服务应用，用来连接配置服务器并为客户端提供获取配置信息，加密/解密信息等访问接口。</p> <p>客户端则是通过指定的配置中心来管理应用资源，以及与业务相关的配置内容，并在启动的时候从配置中心获取和加载配置信息，配置服务器默认采用git来存储配置信息，这样有助于对环境配置进行版本管理，并且可以通过git客户端工具来方便的管理和访问配置内容。</p> <h3 id="_9-1-4-能做什么"><a href="#_9-1-4-能做什么" class="header-anchor">#</a> 9.1.4 能做什么</h3> <ul><li>集中管理配置文件</li> <li>不同环境不同配置，动态化的配置更新，分布式部署，比如 <code>dev/test/prod/beta/release</code></li> <li>运行期间动态调整配置，不再需要在每个服务部署的机器上编写配置文件，服务会向配置中心统一拉取自己的信息</li> <li>当配置发生变动时，服务不需要重启即可感知配置的变化并应用新的配置</li> <li>将配置信息以REST接口的形式暴露：post，curl命令刷新</li></ul> <h3 id="_9-1-5-与github-gitee整合部署"><a href="#_9-1-5-与github-gitee整合部署" class="header-anchor">#</a> 9.1.5 与github/gitee整合部署</h3> <p>由于SpringCloud Config默认使用Git来存储配置文件（也有其他方式，比如支持SVN和本地文件），但最推荐的还是Git，而且使用的是Http/https访问的形式</p> <h2 id="_9-2-config服务端配置与测试"><a href="#_9-2-config服务端配置与测试" class="header-anchor">#</a> 9.2 Config服务端配置与测试</h2> <h3 id="_9-2-1-引入依赖"><a href="#_9-2-1-引入依赖" class="header-anchor">#</a> 9.2.1 引入依赖</h3> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token comment">&lt;!--config--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-config-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="_9-2-2-修改yml"><a href="#_9-2-2-修改yml" class="header-anchor">#</a> 9.2.2 修改YML</h3> <p><code>application.yml</code></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3344</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span>  cloud<span class="token punctuation">-</span>config<span class="token punctuation">-</span>center <span class="token comment">#注册进Eureka服务器的微服务名</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token key atrule">server</span><span class="token punctuation">:</span>
        <span class="token key atrule">git</span><span class="token punctuation">:</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//gitee.com/jiangcji/config.git <span class="token comment">#GitHub上面的git仓库名字</span>
          <span class="token comment">####搜索目录</span>
          <span class="token key atrule">search-paths</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> config
          <span class="token key atrule">username</span><span class="token punctuation">:</span> <span class="token important">****</span>
          <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token important">****</span>
<span class="token comment">#          private-key:</span>
      <span class="token comment">####读取分支</span>
      <span class="token key atrule">label</span><span class="token punctuation">:</span> main

<span class="token comment">#服务注册到eureka地址</span>
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka7001.com<span class="token punctuation">:</span>7001/eureka/
</code></pre></div><h3 id="_9-2-3-配置读取规则"><a href="#_9-2-3-配置读取规则" class="header-anchor">#</a> 9.2.3 配置读取规则</h3> <ul><li>/{label}/{application}-{profile}.yml
<ul><li>http://config-3344.com:3344/master/config-dev.yml</li></ul></li> <li>/{application}-{profile}.yml
<ul><li>http://config-3344.com:3344/config-dev.yml：如果不写的话，默认就是从master分支上找</li></ul></li></ul> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/59.png" style="zoom:50%;"> <h3 id="_9-2-4-参数总结"><a href="#_9-2-4-参数总结" class="header-anchor">#</a> 9.2.4 参数总结</h3> <p>label：分支，branch</p> <p>name：服务名</p> <p>profiles：环境(dev/test/prod)</p> <h2 id="_9-3-config客户端配置与测试"><a href="#_9-3-config客户端配置与测试" class="header-anchor">#</a> 9.3 Config客户端配置与测试</h2> <h3 id="_9-3-1-引入依赖"><a href="#_9-3-1-引入依赖" class="header-anchor">#</a> 9.3.1 引入依赖</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>config<span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>spring<span class="token operator">-</span>cloud<span class="token operator">-</span>starter<span class="token operator">-</span>config<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
</code></pre></div><h3 id="_9-3-2-bootstrap-yml"><a href="#_9-3-2-bootstrap-yml" class="header-anchor">#</a> 9.3.2 bootstrap.yml</h3> <p>application.yml：是用户级的资源配置项</p> <p>bootstrap.yml：是系统级别的，<strong>优先级更加高</strong></p> <p>Spring Cloud会创建一个Bootstrap Context，作为Spring应用的Application Context的<strong>父上下文</strong>。初始化的时候，Bootstrap Context负责从外部源加载配置属性并解析配置。这两个上下文共享一个从外部获取的Environment。</p> <p>Bootstrap属性有高优先级，默认情况下，他们不会被本地配置覆盖，Bootstrap context 和 Application Context有着不同的约定，所以新增了一个bootstrap.yml文件，保证Bootstrap Context 和 Application Context配置的分离。</p> <p>要将客户端Client模块下的Application.yml文件改成bootstrap.yml这是很关键的，因为bootstrap.yml是比application.yml先加载的，bootstrap.yml优先级高于application.yml</p> <p><code>bootstrap.yml</code></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3355</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> config<span class="token punctuation">-</span>client
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
  <span class="token comment">#Config客户端配置</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token key atrule">label</span><span class="token punctuation">:</span> master <span class="token comment">#分支名称</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> application <span class="token comment">#配置文件名称</span>
      <span class="token key atrule">profile</span><span class="token punctuation">:</span> web <span class="token comment">#读取后缀名称   上述3个综合：master分支上config-dev.yml的配置文件被读取http://config-3344.com:3344/master/config-dev.yml</span>
      <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">3344</span> <span class="token comment">#配置中心地址k</span>

<span class="token comment">#服务注册到eureka地址</span>
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>7001/eureka

<span class="token comment"># 暴露监控端点</span>
<span class="token key atrule">management</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
    <span class="token key atrule">web</span><span class="token punctuation">:</span>
      <span class="token key atrule">exposure</span><span class="token punctuation">:</span>
        <span class="token key atrule">include</span><span class="token punctuation">:</span> <span class="token string">&quot;*&quot;</span>
</code></pre></div><ul><li>controller端</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RefreshScope</span> <span class="token comment">// 这个是进行刷新的，更改以后刷新，会配合着使用，这里可不用</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConfigClientController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${config.info}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> configInfo<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/configInfo&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getConfigInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> configInfo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>先启动 eureka再启动这个，最后启动客户端</p> <p>两个服务都注入了</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/60.png" alt=""></p> <p>访问的时候，3355可以访问到gitee里面的信息</p> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/61.png" style="zoom:67%;"> <h2 id="_9-4-存在的问题"><a href="#_9-4-存在的问题" class="header-anchor">#</a> 9.4 存在的问题</h2> <p>分布式配置的动态刷新问题？</p> <ul><li>Linux运维修改Github上的配置文件内容做调整</li> <li>刷新3344，发现ConfigServer配置中心立刻响应</li> <li>刷新3355，发现ConfigClient客户端没有任何响应</li> <li>3355没有变化除非自己重启或者重启加载</li> <li>难道每次运维修改后，都需要重启？</li></ul> <p>相当于直接修改Github上的配置文件，配置不会改变，这个时候就存在了分布式配置的动态刷新问题</p> <h2 id="_9-5-config客户端之动态刷新"><a href="#_9-5-config客户端之动态刷新" class="header-anchor">#</a> 9.5 Config客户端之动态刷新</h2> <p>为了避免每次更新配置都要重启客户端微服务3355</p> <h3 id="_9-5-1-引入了动态刷新"><a href="#_9-5-1-引入了动态刷新" class="header-anchor">#</a> 9.5.1 引入了动态刷新</h3> <p>引入actuator监控依赖</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token comment">&lt;!--web启动器--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--监控--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-actuator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>然后修改bootstrap.yml，暴露监控端点</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token comment">#暴露监控端点</span>
<span class="token key atrule">management</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
    <span class="token key atrule">web</span><span class="token punctuation">:</span>
      <span class="token key atrule">exposure</span><span class="token punctuation">:</span>
        <span class="token key atrule">include</span><span class="token punctuation">:</span> <span class="token string">&quot;*&quot;</span>
</code></pre></div><p>在业务类中，添加 <code>@RefreshScope</code>标签</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code>@RestController
//实现刷新功能
@RefreshScope
public class ConfigClientController <span class="token punctuation">{</span>

    @Value(&quot;$<span class="token punctuation">{</span>config.info<span class="token punctuation">}</span>&quot;)
    private String configInfo;

    @GetMapping(&quot;/configInfo&quot;)
    public String getConfigInfo()<span class="token punctuation">{</span>
        return configInfo;
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>然后让运维人员发送一个post请求</p> <div class="language- extra-class"><pre class="language-text"><code>curl -X POST &quot;http://localhost:3355/actuator/refresh&quot;
</code></pre></div><p>然后就能够生效了，成功刷新了配置，避免了服务重启</p> <p>这个方案存在问题：</p> <ul><li>假设有多个微服务客户端 3355/ 3366 / 3377</li> <li>每个微服务都要执行一次post请求，手动刷新？</li> <li>可否广播，一次通知，处处生效？</li> <li>....</li></ul> <p>目前来说，暂时做不到这个，所以才用了下面的内容，即Spring Cloud Bus 消息总线</p> <h1 id="_10-消息总线springcloudbus"><a href="#_10-消息总线springcloudbus" class="header-anchor">#</a> 10 消息总线SpringCloudBUS</h1> <p>消息总线一般是配合SpringCloudConfig一起使用的</p> <h2 id="_10-1-概述"><a href="#_10-1-概述" class="header-anchor">#</a> 10.1 概述</h2> <p>分布式自动刷新配置功能，SpringCloudBus配合SpringCloudConfig使用可以实现配置的动态刷新</p> <p>Bus支持两种消息代理：RabbitMQ和Kafka</p> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/62.png" style="zoom:67%;"> <p>SpringCloudBus是用来将分布式系统的节点与轻量级消息系统链接起来的框架，它<strong>整合了Java的事件处理机制和消息中间件的功能</strong>。</p> <p>SpringCloudBus能管理和传播分布式系统的消息，就像一个分布式执行器，可用于广播状态更改，事件推送等，也可以当做微服务的通信通道。</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/63.png" alt=""></p> <h3 id="_10-1-1-什么是总线"><a href="#_10-1-1-什么是总线" class="header-anchor">#</a> 10.1.1 什么是总线</h3> <p>在微服务架构的系统中，通常会使用轻量级的消息代理来构建一个共用的消息主题，并让系统中所有微服务实例都连接上来。由于该主题中产生的消息会被所有实例监听和消费，所以被称为消息总线。在总线上的各个实例，都可以方便的广播一些需要让其它连接在该主题上的实例都知道的消息。</p> <h3 id="_10-1-2-基本原理"><a href="#_10-1-2-基本原理" class="header-anchor">#</a> 10.1.2 基本原理</h3> <p>ConfigClient实例都监听MQ中同一个topic（默认是SpringCloudBus），但一个服务刷新数据的时候，它会被这个消息放到Topic中，这样其它监听同一个Topic的服务就能够得到通知，然后去更新自身的配置</p> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/64.png" style="zoom:50%;"> <p>通过topic进行广播通知</p> <h2 id="_10-2-springcloudbus动态刷新全局广播"><a href="#_10-2-springcloudbus动态刷新全局广播" class="header-anchor">#</a> 10.2 SpringCloudBus动态刷新全局广播</h2> <ol><li>给 cloud-config-center-3344<code>配置中心</code>服务端添加消息总线支持</li> <li>给 cloud-config-client-3355<code>客户端</code>添加消息总线支持</li> <li>给 cloud-config-client-3366 <code>客户端</code>添加消息总线支持</li> <li>达到一次修改，广播通知，处处生效</li></ol> <h3 id="_10-2-1-配置中心配置"><a href="#_10-2-1-配置中心配置" class="header-anchor">#</a> 10.2.1 配置中心配置</h3> <p>首先需要搭建好rabbitmq环境</p> <p>然后引入RabbitMQ依赖</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token comment">&lt;!--添加消息总线Rabbitmq支持--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-bus-amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>增加yml中的rabbitmq配置</p> <p><code>application.yml</code></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3344</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span>  cloud<span class="token punctuation">-</span>config<span class="token punctuation">-</span>center <span class="token comment">#注册进Eureka服务器的微服务名</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token key atrule">server</span><span class="token punctuation">:</span>
        <span class="token key atrule">git</span><span class="token punctuation">:</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//gitee.com/jiangcji/config.git <span class="token comment">#GitHub上面的git仓库名字</span>
          <span class="token comment">####搜索目录</span>
          <span class="token key atrule">search-paths</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> config
          <span class="token key atrule">username</span><span class="token punctuation">:</span> gitee的账号
          <span class="token key atrule">password</span><span class="token punctuation">:</span> gitee的密码
      <span class="token comment">####读取分支</span>
      <span class="token key atrule">label</span><span class="token punctuation">:</span> main <span class="token comment"># 这里我的要叫做main</span>

<span class="token comment">##rabbitmq相关配置</span>
  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> xxxxx
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5672</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> xxxx
    <span class="token key atrule">password</span><span class="token punctuation">:</span> xxxx

<span class="token comment">#服务注册到eureka地址</span>
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka7001.com<span class="token punctuation">:</span>7001/eureka/

<span class="token comment">###rabbitmq相关配置,暴露bus刷新配置的端点, 一定要有 actuator</span>
<span class="token key atrule">management</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span> <span class="token comment">#暴露bus刷新配置的端点</span>
    <span class="token key atrule">web</span><span class="token punctuation">:</span>
      <span class="token key atrule">exposure</span><span class="token punctuation">:</span>
        <span class="token key atrule">include</span><span class="token punctuation">:</span> <span class="token string">'bus-refresh'</span>
</code></pre></div><h3 id="_10-2-2-设计思想"><a href="#_10-2-2-设计思想" class="header-anchor">#</a> 10.2.2 设计思想</h3> <ul><li>利用消息总线触发一个客户端/bus/refresh，而刷新所有客户端配置</li></ul> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/65.png" style="zoom:67%;"> <ul><li>利用消息总线出发一个服务端ConfigServer的/bus/refresh断点，而刷新所有客户端的配置</li></ul> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/66.png" style="zoom:50%;"> <ul><li>图二的架构更加适合，图一不适合的原因有
<ul><li>图一打破了微服务的职责单一性，因为微服务本身是业务模块，他不应该承担配置刷新的之职责</li> <li>打破了微服务各节点的对等性</li> <li>有一定的局限性，例如，微服务在迁移时，它的网络地址常常发生变化，此时如果想要做到自动刷新，那就会增加更多的修改。</li></ul></li></ul> <h2 id="_10-3-服务端添加消息总线"><a href="#_10-3-服务端添加消息总线" class="header-anchor">#</a> 10.3 服务端添加消息总线</h2> <h3 id="_10-3-1-引入依赖"><a href="#_10-3-1-引入依赖" class="header-anchor">#</a> 10.3.1 引入依赖</h3> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token comment">&lt;!--添加消息总线RabbitMQ支持--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-bus-amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-config<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="_10-3-2-增加配置"><a href="#_10-3-2-增加配置" class="header-anchor">#</a> 10.3.2 增加配置</h3> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3344</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span>  cloud<span class="token punctuation">-</span>config<span class="token punctuation">-</span>center <span class="token comment">#注册进Eureka服务器的微服务名</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token key atrule">server</span><span class="token punctuation">:</span>
        <span class="token key atrule">git</span><span class="token punctuation">:</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//gitee.com/jiangcji/config.git <span class="token comment">#GitHub上面的git仓库名字</span>
          <span class="token comment">####搜索目录</span>
          <span class="token key atrule">search-paths</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> config
          <span class="token key atrule">username</span><span class="token punctuation">:</span> jiangcji
          <span class="token key atrule">password</span><span class="token punctuation">:</span> xxxx
      <span class="token comment">####读取分支</span>
      <span class="token key atrule">label</span><span class="token punctuation">:</span> main <span class="token comment"># 这里要是main而不是master</span>

<span class="token comment">##rabbitmq相关配置</span>
  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> xxxxx
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5672</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> xxxx
    <span class="token key atrule">password</span><span class="token punctuation">:</span> xxxx

<span class="token comment">#服务注册到eureka地址</span>
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//eureka7001.com<span class="token punctuation">:</span>7001/eureka/

<span class="token comment">###rabbitmq相关配置,暴露bus刷新配置的端点, 一定要有 actuator</span>
<span class="token key atrule">management</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span> <span class="token comment">#暴露bus刷新配置的端点</span>
    <span class="token key atrule">web</span><span class="token punctuation">:</span>
      <span class="token key atrule">exposure</span><span class="token punctuation">:</span>
        <span class="token key atrule">include</span><span class="token punctuation">:</span> <span class="token string">'bus-refresh'</span>
</code></pre></div><p>注意，上面的 <code>bus-refresh</code> 就是actuator的刷新机制，相当于提供了一个 /bus-refresh的post方法，当我们调用的时候，会刷新配置，然后一次发送，处处生效。</p> <h3 id="_10-3-3-启动类"><a href="#_10-3-3-启动类" class="header-anchor">#</a> 10.3.3 启动类</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableConfigServer</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConfigCenterMain3344</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ConfigCenterMain3344</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_10-4-客户端引入消息总线支持"><a href="#_10-4-客户端引入消息总线支持" class="header-anchor">#</a> 10.4 客户端引入消息总线支持</h2> <h3 id="_10-4-1-引入依赖"><a href="#_10-4-1-引入依赖" class="header-anchor">#</a> 10.4.1 引入依赖</h3> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token comment">&lt;!--添加消息总线Rabbitmq支持--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-bus-amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="_10-4-2-修改yml"><a href="#_10-4-2-修改yml" class="header-anchor">#</a> 10.4.2 修改yml</h3> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3355</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> config<span class="token punctuation">-</span>client
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
  <span class="token comment">#Config客户端配置</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token key atrule">label</span><span class="token punctuation">:</span> master <span class="token comment">#分支名称</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> application <span class="token comment">#配置文件名称</span>
      <span class="token key atrule">profile</span><span class="token punctuation">:</span> web <span class="token comment">#读取后缀名称   上述3个综合：master分支上config-dev.yml的配置文件被读取http://config-3344.com:3344/master/config-dev.yml</span>
      <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">3344</span> <span class="token comment">#配置中心地址k</span>

<span class="token comment">#  #rabbitmq相关配置 15672是Web管理界面的端口；5672是MQ访问的端口</span>
  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> 182.92.227.85
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5672</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> jiang
    <span class="token key atrule">password</span><span class="token punctuation">:</span> QAZ123456

<span class="token comment">#服务注册到eureka地址</span>
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>7001/eureka

<span class="token comment"># 暴露监控端点</span>
<span class="token key atrule">management</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
    <span class="token key atrule">web</span><span class="token punctuation">:</span>
      <span class="token key atrule">exposure</span><span class="token punctuation">:</span>
        <span class="token key atrule">include</span><span class="token punctuation">:</span> <span class="token string">&quot;*&quot;</span>
</code></pre></div><p>这里的暴露端点和上面的不太一样，同理得到3366的</p> <h3 id="_10-4-3-启动类"><a href="#_10-4-3-启动类" class="header-anchor">#</a> 10.4.3 启动类</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableEurekaClient</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConfigClientMain3355</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ConfigClientMain3355</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_10-5-测试"><a href="#_10-5-测试" class="header-anchor">#</a> 10.5 测试</h2> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/67.png" style="zoom:67%;"> <p>rabbitmq中有相应的队列</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/68.png" alt=""></p> <p>当我们的服务端配置中心 和 客户端都增加完上述配置后，我们需要做的就是手动发送一个POST请求到服务端</p> <div class="language- extra-class"><pre class="language-text"><code>curl -X POST &quot;http://localhsot:33444/actuator/bus-refresh&quot;
</code></pre></div><p>执行完成后，配置中心会通过BUS消息总线，发送到所有的客户端，并完成配置的刷新操作。</p> <p>完成了一次修改，广播通知，处处生效的效果</p> <h2 id="_10-6-springcloudbus动态刷新定点通知"><a href="#_10-6-springcloudbus动态刷新定点通知" class="header-anchor">#</a> 10.6 SpringCloudBus动态刷新定点通知</h2> <p>就是我想通知的目标是有差异化，有些客户端需要通过，有些不通知，也就是10个客户端，我只通知1个</p> <p>简单一句话，就是指定某一个实例生效而不是全部</p> <p>公式：<code>http://localhost:配置中心端口/actuator/bus-refresh/{destination}</code></p> <p><code>/bus/refresh</code>请求不再发送到具体的服务实例上，而是发送给config server并通过destination参数类指定需要更新配置的服务或实例。</p> <h3 id="_10-6-1-案例"><a href="#_10-6-1-案例" class="header-anchor">#</a> 10.6.1 案例</h3> <p>以刷新运行在3355端口上的config-client为例，只通知3355，不通知3366，可以使用下面命令</p> <div class="language- extra-class"><pre class="language-text"><code>curl -X POST &quot;http://localhsot:33444/actuator/bus-refresh/config-client:3355&quot;
</code></pre></div><p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/69.png" alt=""></p> <h1 id="_11-springcloud-stream-消息驱动"><a href="#_11-springcloud-stream-消息驱动" class="header-anchor">#</a> 11 SpringCloud Stream 消息驱动</h1> <h2 id="_11-1-为什么引入消息驱动"><a href="#_11-1-为什么引入消息驱动" class="header-anchor">#</a> 11.1 为什么引入消息驱动？</h2> <p>首先看到消息驱动，我们会想到，消息中间件</p> <ul><li>ActiveMQ</li> <li>RabbitMQ</li> <li>RocketMQ</li> <li>Kafka</li></ul> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/70.png" alt=""></p> <p>存在的问题就是，中台和后台 可能存在两种MQ，那么他们之间的实现都是不一样的，这样会导致多种问题出现，而且上述我们也看到了，目前主流的MQ有四种，我们不可能每个都去学习</p> <p>这个时候的痛点就是：有没有一种新的技术诞生，让我们不在关注具体MQ的细节，我们只需要用一种适配绑定的方式，自动的给我们在各种MQ内切换。</p> <p>这个时候，SpringCloudStream就运营而生，解决的痛点就是屏蔽了消息中间件的底层的细节差异，我们操作Stream就可以操作各种消息中间件了，从而降低开发人员的开发成本。</p> <h2 id="_11-2-消息驱动概述"><a href="#_11-2-消息驱动概述" class="header-anchor">#</a> 11.2 消息驱动概述</h2> <h3 id="_11-2-1-是什么"><a href="#_11-2-1-是什么" class="header-anchor">#</a> 11.2.1 是什么</h3> <p><strong>屏蔽底层消息中间件的差异，降低切换成本，统一消息的编程模型</strong></p> <p>这就有点像Hibernate，它同时支持多种数据库，同时还提供了Hibernate Session的语法，也就是HQL语句，这样屏蔽了SQL具体实现细节，我们只需要操作HQL语句，就能够操作不同的数据库。</p> <h3 id="_11-2-2-什么是springcloudstream"><a href="#_11-2-2-什么是springcloudstream" class="header-anchor">#</a> 11.2.2 什么是SpringCloudStream</h3> <p>官方定义 SpringCloudStream是一个构件消息驱动微服务的框架</p> <p>应用程序通过inputs或者outputs来与SpringCloudStream中binder对象（绑定器）交互。</p> <p>通过我们配置来binding(绑定)，而SpringCloudStream的binder对象负责与消息中间件交互</p> <p>所以，我们只需要搞清楚如何与SpringCloudStream交互，就可以方便的使用消息驱动的方式。</p> <p>通过使用SpringIntegration来连接消息代理中间件以实现消息事件驱动。</p> <p>SpringCloudStream为一些供应商的消息中间件产品提供了个性化的自动化配置实现，引用了发布-订阅，消费组，分区的三个核心概念</p> <p>目前仅支持RabbitMQ 和 Kafka</p> <h3 id="_11-2-3-springcloudstrem设计思想"><a href="#_11-2-3-springcloudstrem设计思想" class="header-anchor">#</a> 11.2.3 SpringCloudStrem设计思想</h3> <h4 id="_11-2-3-1-标准mq"><a href="#_11-2-3-1-标准mq" class="header-anchor">#</a> 11.2.3.1 标准MQ</h4> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/71.png" alt=""></p> <ul><li>生产者/消费者之间靠消息媒介传递消息内容：Message</li> <li>消息必须走特定的通道（信道）：Channel</li> <li>消息通道里的消息如何被消费呢，谁负责收发处理
<ul><li>消息通道MessageChannel的子接口SubscribableChannel，由MessageHandler消息处理器所订阅</li></ul></li></ul> <h4 id="_11-2-3-2-为什么用springcloudstream"><a href="#_11-2-3-2-为什么用springcloudstream" class="header-anchor">#</a> 11.2.3.2 为什么用SpringCloudStream</h4> <p>RabbitMQ和Kafka，由于这两个消息中间件的架构上不同</p> <p>像RabbitMQ有exchange，kafka有Tpic和Partitions分区</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/72.png" alt=""></p> <p>这些中间件的差异导致我们实际项目开发给我们造成了一定的困扰，我们如果用了两个消息队列的其中一种，后面的业务需求，我们想往另外一种消息队列进行迁移，这时候无疑就是灾难性的，一大堆东西都要推到重新做，因为它根我们的系统耦合了，这时候SpringCloudStream给我们提供了一种解耦的方式</p> <p>这个时候，我们就需要一个绑定器，可以想成是翻译官，用于实现两种消息之间的转换</p> <h4 id="_11-2-3-3-springcloudstream为什么能屏蔽底层差异"><a href="#_11-2-3-3-springcloudstream为什么能屏蔽底层差异" class="header-anchor">#</a> 11.2.3.3 springCloudStream为什么能屏蔽底层差异</h4> <p>在没有绑定器这个概念的情况下，我们的SpringBoot应用要直接与消息中间件进行消息交互的时候，由于各消息中间件构建的初衷不同，它们的实现细节上会有较大的差异性。通过定义绑定器作为中间件，完美的实现了应用程序与消息中间件细节之间的隔离。</p> <p>通过向应用程序暴露统一的Channel通道，使得应用程序不需要在考虑各种不同消息中间件的实现。</p> <p>通过定义绑定器Binder作为中间层，实现了应用程序与消息中间件细节之间的隔离。</p> <h4 id="_11-2-3-4-binder"><a href="#_11-2-3-4-binder" class="header-anchor">#</a> 11.2.3.4 Binder</h4> <ul><li>input：对应消费者</li> <li>output：对应生产者</li></ul> <p>Stream对消息中间件的进一步封装，可以做到代码层面对中间件的无感知，甚至于动态的切换中间件（RabbitMQ切换Kafka），使得微服务开发的高度解耦，服务可以关注更多的自己的业务流程。</p> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/73.png" style="zoom:50%;"> <p><strong>通过定义绑定器Binder作为中间层，实现了应用程序与消息中间件细节之间的隔离。</strong></p> <p>Stream中的消息通信方式遵循了<strong>发布-订阅</strong>模式，Topic主题进行广播，在RabbitMQ中就是Exchange，在Kafka中就是Topic</p> <h4 id="_11-2-3-5-stream标准流程套路"><a href="#_11-2-3-5-stream标准流程套路" class="header-anchor">#</a> 11.2.3.5 Stream标准流程套路</h4> <p>我们的消息生产者和消费者只和Stream交互</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/74.png" alt=""></p> <ul><li>Binder：很方便的连接中间件，屏蔽差异</li> <li>Channel：通道，是队列Queue的一种抽象，在消息通讯系统中就是实现存储和转发的没接，通过Channel对队列进行配置</li> <li>Source和Sink：简单的可以理解为参照对象是SpringCloudStream自身，从Stream发布消息就是输出，接受消息就是输入。</li></ul> <h4 id="_11-2-3-6-编码中的注解"><a href="#_11-2-3-6-编码中的注解" class="header-anchor">#</a> 11.2.3.6 编码中的注解</h4> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/75.png" alt=""></p> <h2 id="_11-3-案例说明"><a href="#_11-3-案例说明" class="header-anchor">#</a> 11.3 案例说明</h2> <ul><li>cloud-stream-rabbitmq-procider8801，作为消息生产者进行发消息模块</li> <li>cloud-stream-rabbitmq-procider8802，消息接收模块</li> <li>cloud-stream-rabbitmq-procider8803，消息接收模块</li></ul> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/76.png" style="zoom:67%;"> <h2 id="_11-4-消息驱动之生产者"><a href="#_11-4-消息驱动之生产者" class="header-anchor">#</a> 11.4 消息驱动之生产者</h2> <h3 id="_11-4-1-引入依赖"><a href="#_11-4-1-引入依赖" class="header-anchor">#</a> 11.4.1 引入依赖</h3> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token comment">&lt;!--Stream--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-stream-rabbit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="_11-4-2-修改yml"><a href="#_11-4-2-修改yml" class="header-anchor">#</a> 11.4.2 修改yml</h3> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8801</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> cloud<span class="token punctuation">-</span>stream<span class="token punctuation">-</span>provider
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">stream</span><span class="token punctuation">:</span>
      <span class="token key atrule">binders</span><span class="token punctuation">:</span> <span class="token comment"># 在此处配置要绑定的rabbitmq的服务信息；</span>
        <span class="token key atrule">defaultRabbit</span><span class="token punctuation">:</span> <span class="token comment"># 表示定义的名称，用于于binding整合</span>
          <span class="token key atrule">type</span><span class="token punctuation">:</span> rabbit <span class="token comment"># 消息组件类型</span>
          <span class="token key atrule">environment</span><span class="token punctuation">:</span> <span class="token comment"># 设置rabbitmq的相关的环境配置</span>
            <span class="token key atrule">spring</span><span class="token punctuation">:</span>
              <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
                <span class="token key atrule">host</span><span class="token punctuation">:</span> xxxxxx
                <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5672</span>
                <span class="token key atrule">username</span><span class="token punctuation">:</span> xxxx
                <span class="token key atrule">password</span><span class="token punctuation">:</span> xxxx
      <span class="token key atrule">bindings</span><span class="token punctuation">:</span> <span class="token comment"># 服务的整合处理</span>
        <span class="token key atrule">output</span><span class="token punctuation">:</span> <span class="token comment"># 这个名字是一个通道的名称</span>
          <span class="token key atrule">destination</span><span class="token punctuation">:</span> studyExchange <span class="token comment"># 表示要使用的Exchange名称定义</span>
          <span class="token key atrule">content-type</span><span class="token punctuation">:</span> application/json <span class="token comment"># 设置消息类型，本次为json，文本则设置“text/plain”</span>
          <span class="token key atrule">binder</span><span class="token punctuation">:</span> defaultRabbit <span class="token comment"># 设置要绑定的消息服务的具体设置</span>

<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span> <span class="token comment"># 客户端进行Eureka注册的配置</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>7001/eureka
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token key atrule">lease-renewal-interval-in-seconds</span><span class="token punctuation">:</span> <span class="token number">2</span> <span class="token comment"># 设置心跳的时间间隔（默认是30秒）</span>
    <span class="token key atrule">lease-expiration-duration-in-seconds</span><span class="token punctuation">:</span> <span class="token number">5</span> <span class="token comment"># 如果现在超过了5秒的间隔（默认是90秒）</span>
    <span class="token key atrule">instance-id</span><span class="token punctuation">:</span> send<span class="token punctuation">-</span>8801.com  <span class="token comment"># 在信息列表时显示主机名称</span>
    <span class="token key atrule">prefer-ip-address</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>     <span class="token comment"># 访问的路径变为IP地址</span>
</code></pre></div><h3 id="_11-4-3-业务类"><a href="#_11-4-3-业务类" class="header-anchor">#</a> 11.4.3 业务类</h3> <h4 id="_11-4-3-1-发送消息的接口"><a href="#_11-4-3-1-发送消息的接口" class="header-anchor">#</a> 11.4.3.1 发送消息的接口</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IMessageProvider</span> <span class="token punctuation">{</span>
	<span class="token comment">// 发送消息的方法</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_11-4-3-2-发送消息的接口实现类"><a href="#_11-4-3-2-发送消息的接口实现类" class="header-anchor">#</a> 11.4.3.2 发送消息的接口实现类</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@EnableBinding</span><span class="token punctuation">(</span><span class="token class-name">Source</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token comment">// 定义消息的推送管道 指信道channel 和 exchange绑定在一起</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MessageProviderImpl</span> <span class="token keyword">implements</span> <span class="token class-name">IMessageProvider</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span> <span class="token comment">// 因为引用了 stream依赖，所以自动注入了</span>
    <span class="token keyword">private</span> <span class="token class-name">MessageChannel</span> output<span class="token punctuation">;</span> <span class="token comment">// 消息发送管道</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> serial <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// // 消息构建器构建一个消息 MessageBuilder</span>
        output<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">MessageBuilder</span><span class="token punctuation">.</span><span class="token function">withPayload</span><span class="token punctuation">(</span>serial<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;****serial = &quot;</span> <span class="token operator">+</span> serial<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>本来正常的是要加@service注解，但是集成了 <code>@Configuration</code>注解，所以会自动注入到容器中</p> <p>1）注入的就是实现类，只不过拿接口来接收，接受的类型为接口，面向接口编程，那么为何要面向接口编程？这就涉及到使用接口做代理，因为通过@autowired的对象是通过接口的方式会使用jdk动态代理，jdk动态代理只能对实现接口的类生成代理，而不能针对类。</p> <p>2）注入的是实现类对象，接收的是接口；理解为多态；</p> <p>如果一个service接口有多个实现类呢？</p> <p>controller类中使用@resource并通过byname的方式注入，不要用@autowired这种通过类型的方式了，</p> <h4 id="_11-4-3-3-controller"><a href="#_11-4-3-3-controller" class="header-anchor">#</a> 11.4.3.3 Controller</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SendMessageController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">IMessageProvider</span> messageProvider<span class="token punctuation">;</span> <span class="token comment">// 注入的是接口</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/sendMessage&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> messageProvider<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>定义一个REST接口，调用的时候，发送一个消息</p> <h4 id="_11-4-3-5-测试"><a href="#_11-4-3-5-测试" class="header-anchor">#</a> 11.4.3.5 测试</h4> <p>我们进入RabbitAdmin页面 <code>http://xxxx:15672</code></p> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/77.png" style="zoom:67%;"> <p>会发现它已经成功创建了一个studyExchange的交换机，这个就是我们上面配置的</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code>      <span class="token key atrule">bindings</span><span class="token punctuation">:</span> <span class="token comment"># 服务的整合处理</span>
        <span class="token key atrule">output</span><span class="token punctuation">:</span> <span class="token comment"># 这个名字是一个通道的名称</span>
          <span class="token key atrule">destination</span><span class="token punctuation">:</span> studyExchange <span class="token comment"># 表示要使用的exchange名称定义</span>
          <span class="token key atrule">content-type</span><span class="token punctuation">:</span> application/json <span class="token comment"># 设置消息类型，本次为json，文本则设为text/plain</span>
          <span class="token key atrule">binder</span><span class="token punctuation">:</span> defaultRabbit <span class="token comment"># 设置要绑定的消息服务的具体设置</span>
</code></pre></div><p>以后就会通过这个交换机进行消息的消费</p> <p>我们运行下列代码，进行测试消息发送 <code>http://localhost:8801/sendMessage</code></p> <p>能够发现消息已经成功被RabbitMQ捕获，这个时候就完成了消息的发送</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/78.png" alt=""></p> <h2 id="_11-5-消息驱动之消费者"><a href="#_11-5-消息驱动之消费者" class="header-anchor">#</a> 11.5 消息驱动之消费者</h2> <h3 id="_11-5-1-引入依赖"><a href="#_11-5-1-引入依赖" class="header-anchor">#</a> 11.5.1 引入依赖</h3> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token comment">&lt;!--Stream--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-stream-rabbit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="_11-5-2-修改yml"><a href="#_11-5-2-修改yml" class="header-anchor">#</a> 11.5.2 修改yml</h3> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8802</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> cloud<span class="token punctuation">-</span>stream<span class="token punctuation">-</span>consumer
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">stream</span><span class="token punctuation">:</span>
      <span class="token key atrule">binders</span><span class="token punctuation">:</span> <span class="token comment"># 在此处配置要绑定的rabbitmq的服务信息；</span>
        <span class="token key atrule">defaultRabbit</span><span class="token punctuation">:</span> <span class="token comment"># 表示定义的名称，用于于binding整合</span>
          <span class="token key atrule">type</span><span class="token punctuation">:</span> rabbit <span class="token comment"># 消息组件类型</span>
          <span class="token key atrule">environment</span><span class="token punctuation">:</span> <span class="token comment"># 设置rabbitmq的相关的环境配置</span>
            <span class="token key atrule">spring</span><span class="token punctuation">:</span>
              <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
                <span class="token key atrule">host</span><span class="token punctuation">:</span> 182.92.227.85
                <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5672</span>
                <span class="token key atrule">username</span><span class="token punctuation">:</span> jiang
                <span class="token key atrule">password</span><span class="token punctuation">:</span> QAZ123456
      <span class="token key atrule">bindings</span><span class="token punctuation">:</span> <span class="token comment"># 服务的整合处理</span>
        <span class="token key atrule">input</span><span class="token punctuation">:</span> <span class="token comment"># 这个名字是一个通道的名称</span>
          <span class="token key atrule">destination</span><span class="token punctuation">:</span> studyExchange <span class="token comment"># 表示要使用的Exchange名称定义</span>
          <span class="token key atrule">content-type</span><span class="token punctuation">:</span> application/json <span class="token comment"># 设置消息类型，本次为对象json，如果是文本则设置“text/plain”</span>
          <span class="token key atrule">binder</span><span class="token punctuation">:</span> defaultRabbit <span class="token comment"># 设置要绑定的消息服务的具体设置</span>
          <span class="token key atrule">group</span><span class="token punctuation">:</span> jiangA <span class="token comment"># 自定义分组 # 通过设置分组，这里分组就是队列名</span>



<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span> <span class="token comment"># 客户端进行Eureka注册的配置</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>7001/eureka
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token key atrule">lease-renewal-interval-in-seconds</span><span class="token punctuation">:</span> <span class="token number">2</span> <span class="token comment"># 设置心跳的时间间隔（默认是30秒）</span>
    <span class="token key atrule">lease-expiration-duration-in-seconds</span><span class="token punctuation">:</span> <span class="token number">5</span> <span class="token comment"># 如果现在超过了5秒的间隔（默认是90秒）</span>
    <span class="token key atrule">instance-id</span><span class="token punctuation">:</span> receive<span class="token punctuation">-</span>8802.com  <span class="token comment"># 在信息列表时显示主机名称</span>
    <span class="token key atrule">prefer-ip-address</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>     <span class="token comment"># 访问的路径变为IP地址</span>
</code></pre></div><h3 id="_11-5-3-业务类"><a href="#_11-5-3-业务类" class="header-anchor">#</a> 11.5.3 业务类</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@EnableBinding</span><span class="token punctuation">(</span><span class="token class-name">Sink</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token comment">// 绑定通道</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReceiveMessageListenerController</span>
<span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${server.port}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> serverPort<span class="token punctuation">;</span>


    <span class="token annotation punctuation">@StreamListener</span><span class="token punctuation">(</span><span class="token class-name">Sink</span><span class="token punctuation">.</span>INPUT<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">input</span><span class="token punctuation">(</span><span class="token class-name">Message</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> message<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;消费者1号,-----&gt;接受到的消息: &quot;</span><span class="token operator">+</span>message<span class="token punctuation">.</span><span class="token function">getPayload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\t  port: &quot;</span><span class="token operator">+</span>serverPort<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过先启动 eureka，然后 服务端 消费端</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/80.png" alt=""></p> <h2 id="_11-6-分组消费"><a href="#_11-6-分组消费" class="header-anchor">#</a> 11.6 分组消费</h2> <p>我们在创建一个8803的消费者服务，需要启动的服务</p> <ul><li>RabbitMQ：消息中间件</li> <li>7001：服务注册</li> <li>8801：消息生产</li> <li>8802：消息消费</li> <li>8803：消息消费</li></ul> <h3 id="_11-6-1-运行后有两个问题"><a href="#_11-6-1-运行后有两个问题" class="header-anchor">#</a> 11.6.1 运行后有两个问题</h3> <ul><li>有重复消费问题</li> <li>消息持久化问题</li></ul> <h3 id="_11-6-2-消费"><a href="#_11-6-2-消费" class="header-anchor">#</a> 11.6.2 消费</h3> <p>目前8802 、8803同时都收到了，存在重复消费的问题</p> <p>如何解决：使用<strong>分组和持久化属性</strong> group来解决</p> <p>比如在如下场景中，订单系统我们做集群部署，都会从RabbitMQ中获取订单信息，那如果一个订单同时被两个服务获取到，那么就会造成数据错误，我们得避免这种情况，这时我们就可以使用Stream中的消息分组来解决。</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/79.png" alt=""></p> <p>注意：在Stream中处于同一个group中的多个消费者是竞争关系，就能够<strong>保证消息只能被其中一个消费一次</strong></p> <p><strong>不同组是可以全面消费的（重复消费）</strong></p> <p>同一组会发生竞争关系，只能其中一个可以消费</p> <p>分布式微服务应用为了实现高可用和负载均衡，实际上都会部署多个实例，这里部署了8802 8803</p> <p>多数情况下，生产者发送消息给某个具体微服务时，只希望被消费一次，按照上面我们启动两个应用的例子，虽然它们同属一个应用，但是这个消息出现了被重复消费两次的情况，为了解决这个情况，在SpringCloudStream中，就提供了 消费组 的概念</p> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/81.png" style="zoom:50%;"> <p>8802/8803都变成不同的组（也就是队列），group两个不同</p> <h3 id="_11-6-3-分组"><a href="#_11-6-3-分组" class="header-anchor">#</a> 11.6.3 分组</h3> <h4 id="_11-6-3-1-原理"><a href="#_11-6-3-1-原理" class="header-anchor">#</a> 11.6.3.1 原理</h4> <p>微服务应用放置于同一个group中，就能够保证消息只会被其中一个应用消费一次，不同的组是可以消费的，同一组内会发生竞争关系，只有其中一个可以被消费。</p> <p>我们将8802和8803划分为同一组</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> cloud<span class="token punctuation">-</span>stream<span class="token punctuation">-</span>consumer
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">stream</span><span class="token punctuation">:</span>
      <span class="token key atrule">binders</span><span class="token punctuation">:</span> <span class="token comment"># 在此处配置要绑定的rabbitMQ的服务信息</span>
        <span class="token key atrule">defaultRabbit</span><span class="token punctuation">:</span> <span class="token comment"># 表示定义的名称，用于binding的整合</span>
          <span class="token key atrule">type</span><span class="token punctuation">:</span> rabbit <span class="token comment"># 消息中间件类型</span>
          <span class="token key atrule">environment</span><span class="token punctuation">:</span> <span class="token comment"># 设置rabbitMQ的相关环境配置</span>
            <span class="token key atrule">spring</span><span class="token punctuation">:</span>
              <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
                <span class="token key atrule">host</span><span class="token punctuation">:</span> localhost
                <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5672</span>
                <span class="token key atrule">username</span><span class="token punctuation">:</span> guest
                <span class="token key atrule">password</span><span class="token punctuation">:</span> guest
      <span class="token key atrule">bindings</span><span class="token punctuation">:</span> <span class="token comment"># 服务的整合处理</span>
        <span class="token key atrule">input</span><span class="token punctuation">:</span> <span class="token comment"># 这个名字是一个通道的名称</span>
          <span class="token key atrule">destination</span><span class="token punctuation">:</span> studyExchange <span class="token comment"># 表示要使用的exchange名称定义</span>
          <span class="token key atrule">content-type</span><span class="token punctuation">:</span> application/json <span class="token comment"># 设置消息类型，本次为json，文本则设为text/plain</span>
          <span class="token key atrule">binder</span><span class="token punctuation">:</span> defaultRabbit <span class="token comment"># 设置要绑定的消息服务的具体设置</span>
          <span class="token key atrule">group</span><span class="token punctuation">:</span> atguiguA
</code></pre></div><p>引入：<code>group: atguiguA</code></p> <p>然后我们执行消息发送的接口：<code>http://localhost:8801/sendMessage</code></p> <p>我们在8801服务，同时发送了6条消息</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/82.png" alt=""></p> <p>然后看8802服务，接收到了3条</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/83.png" alt=""></p> <p>8803服务，也接收到了3条</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/84.png" alt=""></p> <p>这个时候，就通过分组，避免了消息的重复消费问题</p> <p>8802、8803通过实现轮询分组，每次只有一个消费者，最后发送的消息只能够被一个接受</p> <p>如果将他们的group变成两个不同的组，那么消息就会被重复消费</p> <h2 id="_11-7-消息持久化"><a href="#_11-7-消息持久化" class="header-anchor">#</a> 11.7 消息持久化</h2> <p>通过上面的方式，我们解决了重复消费的问题，再看看持久化</p> <h3 id="_11-7-1-案例"><a href="#_11-7-1-案例" class="header-anchor">#</a> 11.7.1 案例</h3> <ul><li>停止8802和8803，并移除8802的group，保留8803的group</li> <li>8801先发送4条消息到RabbitMQ</li> <li>先启动8802，无分组属性，后台没有打出来消息</li> <li>在启动8803，有分组属性，后台打出来MQ上的消息</li></ul> <p>这就说明消息已经被持久化了，等消费者登录后，会自动从消息队列中获取消息进行消费</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/85.png" alt=""></p> <h1 id="_12-springcloudsleuth分布式请求链路跟踪"><a href="#_12-springcloudsleuth分布式请求链路跟踪" class="header-anchor">#</a> 12 SpringCloudSleuth分布式请求链路跟踪</h1> <h2 id="_12-1-概述"><a href="#_12-1-概述" class="header-anchor">#</a> 12.1 概述</h2> <p>详细可以参考：<a href="http://moguit.cn/#/info?blogUid=35bd93cabc08611c7f74ce4564753ef9" target="_blank" rel="noopener noreferrer">使用Zipkin搭建蘑菇博客链路追踪<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>在微服务框架中，一个由客户端发起的请求在后端系统中会经过多个不同的服务节点调用来协同产生最后的请求结果，每一个前端请求都会形成一条复杂的分布式服务调用链路，链路中的任何一环出现高延时或错误都会引起整个请求最后的失败。</p> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/86.png" style="zoom:50%;"> <p>当链路特别多的时候</p> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/87.png" style="zoom:33%;"> <p>就需要有一个用于调用链路的监控和服务跟踪的解决方案</p> <p>SpringCloudSleuth提供了一套完整的服务跟踪解决方案，在分布式系统中，提供了追踪解决方案，并且兼容支持了zipkin。</p> <h2 id="_12-2-搭建"><a href="#_12-2-搭建" class="header-anchor">#</a> 12.2 搭建</h2> <h3 id="_12-2-1-zipkin"><a href="#_12-2-1-zipkin" class="header-anchor">#</a> 12.2.1 zipkin</h3> <p>SpringCloud从F版起，已经不需要自己构建Zipkin Server了，只需要调用jar包即可</p> <h4 id="_12-2-1-1-运行"><a href="#_12-2-1-1-运行" class="header-anchor">#</a> 12.2.1.1 运行</h4> <div class="language- extra-class"><pre class="language-text"><code>java -jar zipkin.jar
</code></pre></div><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/88.png" style="zoom:50%;"> <h4 id="_12-2-1-2-打开"><a href="#_12-2-1-2-打开" class="header-anchor">#</a> 12.2.1.2 打开</h4> <div class="language- extra-class"><pre class="language-text"><code>http://localhost:9441/zipkin
</code></pre></div><p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/89.png" alt=""></p> <h3 id="_12-2-2-名词解释"><a href="#_12-2-2-名词解释" class="header-anchor">#</a> 12.2.2 名词解释</h3> <ul><li>Trace：类似于树结构的Span集合，表示一条调用链路，存在唯一标识</li> <li>Span：表示调用链路来源，通俗的理解span就是一次请求信息</li></ul> <h4 id="_12-2-2-1-完整的调用链路"><a href="#_12-2-2-1-完整的调用链路" class="header-anchor">#</a> 12.2.2.1 完整的调用链路</h4> <p>表示一请求链路， 一条链路通过Trace ID唯一标识，Span标识发起请求信息，各span通过parent id关联起来。</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/90.png" alt=""></p> <p>一条链路通过Trace Id唯一标识，Span表示发起的请求信息，各span通过parent id关联起来</p> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/91.png" style="zoom:67%;"> <p>整个链路的依赖关系如下：</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/92.png" alt=""></p> <h3 id="_12-2-3-引入依赖"><a href="#_12-2-3-引入依赖" class="header-anchor">#</a> 12.2.3 引入依赖</h3> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token comment">&lt;!--链路监控包含sleuth+zipkin--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-zipkin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="_12-2-4-修改yml"><a href="#_12-2-4-修改yml" class="header-anchor">#</a> 12.2.4 修改yml</h3> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> cloud<span class="token punctuation">-</span>order<span class="token punctuation">-</span>service
  <span class="token key atrule">zipkin</span><span class="token punctuation">:</span>
    <span class="token key atrule">base-url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">9411</span>
  <span class="token key atrule">sleuth</span><span class="token punctuation">:</span>
    <span class="token key atrule">sampler</span><span class="token punctuation">:</span>
      <span class="token comment"># 采集率介于0到1之间，1表示全部采集</span>
      <span class="token key atrule">probability</span><span class="token punctuation">:</span> <span class="token number">1</span>
</code></pre></div><h1 id="_13-nacos"><a href="#_13-nacos" class="header-anchor">#</a> 13 Nacos</h1> <h2 id="_13-1-springcloud-alibaba简介"><a href="#_13-1-springcloud-alibaba简介" class="header-anchor">#</a> 13.1 SpringCloud Alibaba简介</h2> <p>SpringCloud Alibaba诞生的主要原因是：因为Spring Cloud Netflix项目进入了维护模式</p> <h3 id="_13-1-1-维护模式"><a href="#_13-1-1-维护模式" class="header-anchor">#</a> 13.1.1 维护模式</h3> <p>将模块置为维护模式，意味着SpringCloud团队将不再向模块添加新功能，我们将恢复block级别的bug以及安全问题，我们也会考虑并审查社区的小型pull request</p> <p>我们打算继续支持这些模块，知道Greenwich版本被普遍采用至少一年</p> <h3 id="_13-1-2-意味着"><a href="#_13-1-2-意味着" class="header-anchor">#</a> 13.1.2 意味着</h3> <p>Spring Cloud Netflix将不再开发新的组件，我们都知道Spring Cloud项目迭代算是比较快，因此出现了很多重大issue都还来不及Fix，就又推出了另一个Release。进入维护模式意思就是以后一段时间Spring Cloud Netflix提供的服务和功能就这么多了，不在开发新的组件和功能了，以后将以维护和Merge分支Pull Request为主，新组件将以其他替代</p> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/93.png" style="zoom:50%;"> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/94.png" alt=""></p> <h3 id="_13-1-3-能做啥"><a href="#_13-1-3-能做啥" class="header-anchor">#</a> 13.1.3 能做啥</h3> <ul><li>服务限流降级：默认支持servlet，Feign，RestTemplate，Dubbo和RocketMQ限流降级功能的接入，可以在运行时通过控制台实时修改限流降级规则，还支持查看限流降级Metrics监控</li> <li>服务注册与发现：适配Spring Cloud服务注册与发现标准，默认集成了Ribbon的支持</li> <li>分布式配置管理：支持分布式系统中的外部化配置，配置更改时自动刷新</li> <li>消息驱动能力：基于Spring Cloud Stream （内部用RocketMQ）为微服务应用构建消息驱动能力</li> <li>阿里云对象存储：阿里云提供的海量、安全、低成本、高可靠的云存储服务，支持在任何应用、任何时间、任何地点存储和访问任意类型的数据。</li> <li>分布式任务调度：提供秒级，精准、高可靠、高可用的定时（基于Cron表达式）任务调度服务，同时提供分布式的任务执行模型，如网格任务，网格任务支持海量子任务均匀分配到所有Worker</li></ul> <h3 id="_13-1-4-引入依赖版本控制"><a href="#_13-1-4-引入依赖版本控制" class="header-anchor">#</a> 13.1.4 引入依赖版本控制</h3> <p>父模块</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-alibaba-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.2.0.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="_13-1-5-怎么玩"><a href="#_13-1-5-怎么玩" class="header-anchor">#</a> 13.1.5 怎么玩</h3> <ul><li>Sentinel：阿里巴巴开源产品，把流量作为切入点，从流量控制，熔断降级，系统负载 保护等多个维度保护系统服务的稳定性</li> <li>Nacos：阿里巴巴开源产品，一个更易于构建云原生应用的动态服务发现、配置管理和服务管理平台</li> <li>RocketMQ：基于Java的高性能，高吞吐量的分布式消息和流计算平台</li> <li>Dubbo：Apache Dubbo是一款高性能Java RPC框架</li> <li>Seata：一个易于使用的高性能微服务分布式事务解决方案</li> <li>Alibaba Cloud OOS：阿里云对象存储（Object Storage Service，简称OOS），是阿里云提供的海量，安全，低成本，高可靠的云存储服务，您可以在任何应用，任何时间，任何地点存储和访问任意类型的数据。</li> <li>Alibaba Cloud SchedulerX：阿里中间件团队开发的一款分布式任务调度产品，支持周期的任务与固定时间点触发</li></ul> <h2 id="_13-2-nacos简介"><a href="#_13-2-nacos简介" class="header-anchor">#</a> 13.2 Nacos简介</h2> <p>Nacos服务注册和配置中心，兼顾两种</p> <h3 id="_13-2-1-为什么叫nacos"><a href="#_13-2-1-为什么叫nacos" class="header-anchor">#</a> 13.2.1 为什么叫Nacos</h3> <p>前四个字母分别为：Naming（服务注册） 和 Configuration（配置中心） 的前两个字母，后面的s 是 Service</p> <h3 id="_13-2-2-是什么"><a href="#_13-2-2-是什么" class="header-anchor">#</a> 13.2.2 是什么</h3> <p>一个更易于构建云原生应用的动态服务发现，配置管理和服务</p> <p>Nacos：Dynamic Naming and Configuration Server</p> <p>Nacos就是注册中心 + 配置中心的组合</p> <p>等价于：Nacos = Eureka + Config</p> <h3 id="_13-2-3-能干嘛"><a href="#_13-2-3-能干嘛" class="header-anchor">#</a> 13.2.3 能干嘛</h3> <p>替代Eureka做服务注册中心</p> <p>替代Config做服务配置中心</p> <p>官网：https://github.com/alibaba/nacos</p> <p>nacos文档：https://nacos.io/zh-cn/docs/what-is-nacos.html</p> <h3 id="_13-2-4-比较"><a href="#_13-2-4-比较" class="header-anchor">#</a> 13.2.4 比较</h3> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/96.png" style="zoom:50%;"> <p>Nacos在阿里巴巴内部有超过10万的实例运行，已经过了类似双十一等各种大型流量的考验</p> <h3 id="_13-2-5-安装并运行"><a href="#_13-2-5-安装并运行" class="header-anchor">#</a> 13.2.5 安装并运行</h3> <p>本地需要 java8 + Maven环境</p> <p>下载：<a href="https://github.com/alibaba/nacos/releases/tag/1.1.4" target="_blank" rel="noopener noreferrer">地址<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>github经常抽风，可以使用：https://blog.csdn.net/buyaopa/article/details/104582141</p> <p>解压后：运行bin目录下的：startup.cmd</p> <p>打开：<code>http://localhost:8848/nacos</code></p> <p>结果页面</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/97.png" alt=""></p> <h2 id="_13-3-nacos作为服务注册中心"><a href="#_13-3-nacos作为服务注册中心" class="header-anchor">#</a> 13.3 Nacos作为服务注册中心</h2> <h3 id="_13-3-1-服务提供者注册nacos"><a href="#_13-3-1-服务提供者注册nacos" class="header-anchor">#</a> 13.3.1 服务提供者注册Nacos</h3> <h4 id="_13-3-1-1-引入依赖"><a href="#_13-3-1-1-引入依赖" class="header-anchor">#</a> 13.3.1.1 引入依赖</h4> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token comment">&lt;!--SpringCloud alibaba nacos--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h4 id="_13-3-1-2-修改yml"><a href="#_13-3-1-2-修改yml" class="header-anchor">#</a> 13.3.1.2 修改yml</h4> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9002</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>payment<span class="token punctuation">-</span>provider
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span>   <span class="token comment"># 配置nacos地址</span>
        
<span class="token key atrule">management</span><span class="token punctuation">:</span> <span class="token comment"># 暴露端口</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
    <span class="token key atrule">web</span><span class="token punctuation">:</span>
      <span class="token key atrule">exposure</span><span class="token punctuation">:</span>
        <span class="token key atrule">include</span><span class="token punctuation">:</span> <span class="token string">'*'</span>
</code></pre></div><h4 id="_13-3-1-3-主启动类"><a href="#_13-3-1-3-主启动类" class="header-anchor">#</a> 13.3.1.3 主启动类</h4> <p>添加 <code>@EnableDiscoveryClient</code> 注解</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PaymentMain9002</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">PaymentMain9002</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_13-3-1-4-业务类"><a href="#_13-3-1-4-业务类" class="header-anchor">#</a> 13.3.1.4 业务类</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PaymentController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${server.port}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> serverPort<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/payment/nacos/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getPayment</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;nacos registry ,serverPore:&quot;</span><span class="token operator">+</span>serverPort<span class="token operator">+</span><span class="token string">&quot;\t id:&quot;</span><span class="token operator">+</span>id<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_13-3-1-5-启动"><a href="#_13-3-1-5-启动" class="header-anchor">#</a> 13.3.1.5 启动</h4> <p>nacos-payment-provider已经成功注册了</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/98.png" alt=""></p> <p>这个时候 nacos服务注册中心 + 服务提供者 9001 都OK了</p> <p>同理得到8802 最后能够看到两个实例</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/99.png" alt=""></p> <h3 id="_13-3-2-服务消费者注册到nacos"><a href="#_13-3-2-服务消费者注册到nacos" class="header-anchor">#</a> 13.3.2 服务消费者注册到Nacos</h3> <p>Nacos天生集成了Ribbon，因此它就具备负载均衡的能力</p> <h4 id="_13-3-2-1-引入依赖"><a href="#_13-3-2-1-引入依赖" class="header-anchor">#</a> 13.3.2.1 引入依赖</h4> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token comment">&lt;!--SpringCloud alibaba nacos--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h4 id="_13-3-2-2-修改yml"><a href="#_13-3-2-2-修改yml" class="header-anchor">#</a> 13.3.2.2 修改yml</h4> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">83</span>


<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>order<span class="token punctuation">-</span>consumer
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.1.5<span class="token punctuation">:</span><span class="token number">8848</span>

<span class="token comment">#消费者将要去访问的微服务名称(注册成功进nacos的微服务提供者)</span>
<span class="token key atrule">service-url</span><span class="token punctuation">:</span>
  <span class="token key atrule">nacos-user-service</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//nacos<span class="token punctuation">-</span>payment<span class="token punctuation">-</span>provider
</code></pre></div><h4 id="_13-3-2-3-增加配置类"><a href="#_13-3-2-3-增加配置类" class="header-anchor">#</a> 13.3.2.3 增加配置类</h4> <p>因为nacos集成了Ribbon，因此需要配置RestTemplate，同时通过注解 <code>@LoadBalanced</code>实现负载均衡，默认是轮询的方式</p> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/100.png" style="zoom:67%;"> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationContextConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@LoadBalanced</span> <span class="token comment">// 加上负载均衡，轮询，因为有两个服务端</span>
    <span class="token keyword">public</span> <span class="token class-name">RestTemplate</span> <span class="token function">getRestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_13-3-2-4-业务类"><a href="#_13-3-2-4-业务类" class="header-anchor">#</a> 13.3.2.4 业务类</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderNacosController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RestTemplate</span> restTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${service-url.nacos-user-service}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> serverURL<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/consumer/payment/nacos/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">paymentInfo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span>serverURL <span class="token operator">+</span> <span class="token string">&quot;/payment/nacos/&quot;</span> <span class="token operator">+</span> id<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>测试</p> <div class="language- extra-class"><pre class="language-text"><code>http://localhost:83/consumer/payment/nacos/13
</code></pre></div><p>得到的结果</p> <div class="language- extra-class"><pre class="language-text"><code>nacos registry ,serverPore:9001 id:13
nacos registry ,serverPore:9002 id:13
</code></pre></div><p>我们发现只需要配置了nacos，就轻松实现负载均衡</p> <h3 id="_13-3-3-服务中心对比"><a href="#_13-3-3-服务中心对比" class="header-anchor">#</a> 13.3.3 服务中心对比</h3> <p>之前我们提到的注册中心对比图</p> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/101.png" style="zoom:67%;"> <p>但是其实Nacos不仅支持AP，而且还支持CP，它的支持模式是可以切换的，我们首先看看Spring Cloud Alibaba的全景图，</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/102.png" alt=""></p> <h4 id="_13-3-3-1-nacos和cap"><a href="#_13-3-3-1-nacos和cap" class="header-anchor">#</a> 13.3.3.1 Nacos和CAP</h4> <p>CAP：分别是一致性，可用性，分容容忍</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/104.png" alt=""></p> <p>我们从下图能够看到，nacos不仅能够和Dubbo整合，还能和K8s，也就是偏运维的方向</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/105.png" alt=""></p> <h4 id="_13-3-3-2-nacos支持ap和cp切换"><a href="#_13-3-3-2-nacos支持ap和cp切换" class="header-anchor">#</a> 13.3.3.2 Nacos支持AP和CP切换</h4> <p>C是指所有的节点同一时间看到的数据是一致的，而A的定义是所有的请求都会收到响应</p> <p>合适选择何种模式？</p> <p>一般来说，如果不需要存储服务级别的信息且服务实例是通过nacos-client注册，并能够保持心跳上报，那么就可以选择AP模式。当前主流的服务如Spring Cloud 和 Dubbo服务，都是适合AP模式，AP模式为了服务的可用性而减弱了一致性，因此AP模式下只支持注册临时实例。</p> <p>如果需要在服务级别编辑或存储配置信息，那么CP是必须，K8S服务和DNS服务则适用于CP模式。</p> <p>CP模式下则支持注册持久化实例，此时则是以Raft协议为集群运行模式，该模式下注册实例之前必须先注册服务，如果服务不存在，则会返回错误。</p> <h2 id="_13-4-nacos作为服务配置中心演示"><a href="#_13-4-nacos作为服务配置中心演示" class="header-anchor">#</a> 13.4 Nacos作为服务配置中心演示</h2> <p>我们将我们的配置写入Nacos，然后以Spring Cloud Config的方式，用于抓取配置</p> <h3 id="_13-4-1-nacos作为配置中心-基础配置"><a href="#_13-4-1-nacos作为配置中心-基础配置" class="header-anchor">#</a> 13.4.1 Nacos作为配置中心 - 基础配置</h3> <h4 id="_13-4-1-2-引入依赖"><a href="#_13-4-1-2-引入依赖" class="header-anchor">#</a> 13.4.1.2 引入依赖</h4> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token comment">&lt;!--引入nacos config--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-config<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h4 id="_13-4-1-2-修改yml"><a href="#_13-4-1-2-修改yml" class="header-anchor">#</a> 13.4.1.2 修改YML</h4> <p>Nacos同SpringCloud Config一样，在项目初始化时，要保证先从配置中心进行配置拉取，拉取配置之后，才能保证项目的正常运行。</p> <p>SpringBoot中配置文件的加载是存在优先级顺序的：<strong>bootstrap优先级 高于 application</strong></p> <p><strong>application.yml配置</strong></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span>
 <span class="token comment">#   active: dev # 开发环境</span>
 <span class="token comment">#   active: test # 测试环境</span>
    <span class="token key atrule">active</span><span class="token punctuation">:</span> info <span class="token comment"># 开发环境</span>
</code></pre></div><p><strong>bootstrap.yml配置</strong></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token comment"># nacos配置</span>
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3377</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>config<span class="token punctuation">-</span>client
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.1.5<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment">#Nacos服务注册中心地址</span>
      <span class="token key atrule">config</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.1.5<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment">#Nacos作为配置中心地址</span>
        <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yaml <span class="token comment">#指定yaml格式的配置</span>
        <span class="token key atrule">group</span><span class="token punctuation">:</span> TEST_GROUP
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> faa546f2<span class="token punctuation">-</span>1a8a<span class="token punctuation">-</span>4e46<span class="token punctuation">-</span>a04c<span class="token punctuation">-</span>79a0a71a7d13


<span class="token comment"># ${spring.application.name}-${spring.profile.active}.${spring.cloud.nacos.config.file-extension}</span>
<span class="token comment"># nacos-config-client-dev.yaml</span>

<span class="token comment"># nacos-config-client-test.yaml   ----&gt; config.info</span>
</code></pre></div><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/106.png" style="zoom:67%;"> <h4 id="_13-4-1-3-主启动类"><a href="#_13-4-1-3-主启动类" class="header-anchor">#</a> 13.4.1.3 主启动类</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NacosConfigClientMain3377</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">NacosConfigClientMain3377</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_13-4-1-4-业务类"><a href="#_13-4-1-4-业务类" class="header-anchor">#</a> 13.4.1.4 业务类</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RefreshScope</span> <span class="token comment">// 支持 nacos 的动态刷新功能</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConfigClientController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${config.info}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> configInfo<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/config/info&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getConfigInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> configInfo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过SpringCloud原生注解 <code>@RefreshScope</code> 实现配置自动刷新</p> <h4 id="_13-4-1-5-在nacos中添加配置信息"><a href="#_13-4-1-5-在nacos中添加配置信息" class="header-anchor">#</a> 13.4.1.5 在Nacos中添加配置信息</h4> <h5 id="nacos中匹配规则"><a href="#nacos中匹配规则" class="header-anchor">#</a> Nacos中匹配规则</h5> <p>Nacos中的dataid的组成格式及与SpringBoot配置文件中的匹配规则</p> <div class="language- extra-class"><pre class="language-text"><code>${spring.application.name}-${spring.profile.active}.${spring.cloud.nacos.config.file-extension}
</code></pre></div><p>这样，就对应我们Nacos中的这样一个配置</p> <div class="language- extra-class"><pre class="language-text"><code>nacos-config-client-dev.yml
</code></pre></div><p>配置说明</p> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/107.png" style="zoom:67%;"> <p>我们在Nacos中添加配置</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/108.png" alt=""></p> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/109.png" style="zoom:50%;"> <p>这里需要注意的是，在<code>config:</code> 的后面必须加上一个空格</p> <h4 id="_13-4-1-6-测试"><a href="#_13-4-1-6-测试" class="header-anchor">#</a> 13.4.1.6 测试</h4> <p>启动前需要在nacos客户端-配置管理下有对应的yml配置文件，然后运行cloud-config-nacos-client:3377的主启动类，调用接口查看配置信息。</p> <p>启动的时候出现问题</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/112.png" alt=""></p> <p>这是因为无法读取配置所引起的，解决方案就是我们的文件名不能用 .yml 而应该是 .yaml</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/111.png" alt=""></p> <h4 id="_13-4-1-7-自带动态刷新"><a href="#_13-4-1-7-自带动态刷新" class="header-anchor">#</a> 13.4.1.7 自带动态刷新</h4> <p>修改Nacos中的yaml配置文件，再次查看配置的接口，就会发现配置已经刷新了</p> <h3 id="_13-4-2-nacos作为配置中心-分类配置"><a href="#_13-4-2-nacos作为配置中心-分类配置" class="header-anchor">#</a> 13.4.2 Nacos作为配置中心 - 分类配置</h3> <p>从上面的配置中心 + 动态刷新 ， 就相当于 有了 SpringCloud Config + Spring Cloud Bus的功能</p> <p>作为后起之秀的Nacos，还具备分类配置的功能</p> <h4 id="_13-4-2-1-问题"><a href="#_13-4-2-1-问题" class="header-anchor">#</a> 13.4.2.1 问题</h4> <p>用于解决多环境多项目管理</p> <p>在实际开发中，通常一个系统会准备</p> <ul><li>dev开发环境</li> <li>test测试环境</li> <li>prod生产环境</li></ul> <p>如何保证指定环境启动时，服务能正确读取到Nacos上相应环境的配置文件呢？</p> <p>同时，一个大型分布式微服务系统会有很多微服务子项目，每个微服务子项目又都会有相应的开发环境，测试环境，预发环境，正式环境，那怎么对这些微服务配置进行管理呢？</p> <h4 id="_13-4-2-2-nacos图形化界面"><a href="#_13-4-2-2-nacos图形化界面" class="header-anchor">#</a> 13.4.2.2 Nacos图形化界面</h4> <p>配置管理:</p> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/113.png" style="zoom:50%;"> <h4 id="_13-4-2-3-namespace-group-data-id-三者关系"><a href="#_13-4-2-3-namespace-group-data-id-三者关系" class="header-anchor">#</a> 13.4.2.3 Namespace + Group + Data ID 三者关系</h4> <p>这种分类的设计思想，就类似于java里面的package名 和 类名，最外层的namespace是可以用于区分部署环境的，Group 和 DataID逻辑上区分两个目标对象</p> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/114.png" style="zoom:50%;"> <p>默认情况：</p> <p>Namespace=public，Group=DEFAULT_GROUP，默认Cluster是DEFAULT</p> <p>Nacos默认的命名空间是public，Namespace主要用来实现隔离</p> <p>比如说我们现在有三个环境：开发，测试，生产环境，我们就可以建立三个Namespace，不同的Namespace之间是隔离的。</p> <p>Group默认是DEFAULT_GROUP，Group可以把不同微服务划分到同一个分组里面去</p> <p>Service就是微服务，一个Service可以包含多个Cluster（集群），Nacos默认Cluster是DEFAULT，Cluster是对指定微服务的一个虚拟划分。比如说为了容灾，将Service微服务分别部署在了杭州机房，这时就可以给杭州机房的Service微服务起一个集群名称（HZ），给广州机房的Service微服务起一个集群名称，还可以尽量让同一个机房的微服务相互调用，以提升性能，最后Instance，就是微服务的实例。</p> <h4 id="_13-4-2-4-三种方案加载配置"><a href="#_13-4-2-4-三种方案加载配置" class="header-anchor">#</a> 13.4.2.4 三种方案加载配置</h4> <h5 id="_13-4-2-4-1-dataid方案"><a href="#_13-4-2-4-1-dataid方案" class="header-anchor">#</a> 13.4.2.4.1 DataID方案</h5> <ul><li>指定spring.profile.active 和 配置文件的DataID来使不同环境下读取不同的配置</li> <li>默认空间 + 默认分组 + 新建dev 和 test两个DataID</li></ul> <h5 id="_13-4-2-4-2-group方案"><a href="#_13-4-2-4-2-group方案" class="header-anchor">#</a> 13.4.2.4.2 Group方案</h5> <p>在创建的时候，添加分组信息</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/115.png" alt=""></p> <p>然后就可以添加分组</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token comment"># nacos配置</span>
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3377</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>config<span class="token punctuation">-</span>client
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.1.5<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment">#Nacos服务注册中心地址</span>
      <span class="token key atrule">config</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.1.5<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment">#Nacos作为配置中心地址</span>
        <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yaml <span class="token comment">#指定yaml格式的配置</span>
        <span class="token key atrule">group</span><span class="token punctuation">:</span> TEST_GROUP
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> faa546f2<span class="token punctuation">-</span>1a8a<span class="token punctuation">-</span>4e46<span class="token punctuation">-</span>a04c<span class="token punctuation">-</span>79a0a71a7d13
</code></pre></div><h5 id="_13-4-2-4-3-namspace方案"><a href="#_13-4-2-4-3-namspace方案" class="header-anchor">#</a> 13.4.2.4.3 Namspace方案</h5> <p>新建完成后，能够看到有命名空间id</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/117.png" alt=""></p> <p>创建完成后，我们会发现，多出了几个命名空间切换</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/116.png" alt=""></p> <p>下面我们就可以通过引入namespace，来创建到指定的命名空间下</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token comment"># nacos配置</span>
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3377</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>config<span class="token punctuation">-</span>client
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.1.5<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment">#Nacos服务注册中心地址</span>
      <span class="token key atrule">config</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.1.5<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment">#Nacos作为配置中心地址</span>
        <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yaml <span class="token comment">#指定yaml格式的配置</span>
        <span class="token key atrule">group</span><span class="token punctuation">:</span> TEST_GROUP
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> faa546f2<span class="token punctuation">-</span>1a8a<span class="token punctuation">-</span>4e46<span class="token punctuation">-</span>a04c<span class="token punctuation">-</span>79a0a71a7d13
</code></pre></div><p>最后通过 namespace + group + DataID 形成三级分类</p> <h2 id="_13-5-nacos集群和持久化配置"><a href="#_13-5-nacos集群和持久化配置" class="header-anchor">#</a> 13.5 Nacos集群和持久化配置</h2> <p>https://nacos.io/zh-cn/docs/deployment.html</p> <h3 id="_13-5-1-官网说明"><a href="#_13-5-1-官网说明" class="header-anchor">#</a> 13.5.1 官网说明</h3> <p>用于部署生产中的集群模式</p> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/118.png" style="zoom:50%;"> <p>默认Nacos使用嵌入数据库实现数据的存储，所以，如果启动多个默认配置下的Nacos节点，数据存储是存在一致性问题的。为了解决这个问题，Nacos采用了集中式存储的方式来支持集群化部署，目前只支持MySQL的存储。</p> <p>Nacos支持三种部署模式</p> <ul><li>单机模式：用于测试和单机使用</li> <li>集群模式：用于生产环境，确保高可用</li> <li>多集群模式：用于多数据中心场景</li></ul> <h3 id="_13-5-2-单机模式支持mysql"><a href="#_13-5-2-单机模式支持mysql" class="header-anchor">#</a> 13.5.2 单机模式支持mysql</h3> <p>在0.7版本之前，在单机模式下nacos使用嵌入式数据库实现数据的存储，不方便观察数据存储的基本情况。0.7版本增加了支持mysql数据源能力，具体的操作流程：</p> <ul><li>安装数据库，版本要求：5.6.5 +</li> <li>初始化数据库，数据库初始化文件：nacos-mysql.sql</li> <li>修改conf/application.properties文件，增加mysql数据源配置，目前仅支持mysql，添加mysql数据源的url，用户名和密码</li></ul> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/119.png" alt=""></p> <p>再次以单机模式启动nacos，nacos所有写嵌入式数据库的数据都写到了mysql中。</p> <h3 id="_13-5-3-nacos持久化配置解释"><a href="#_13-5-3-nacos持久化配置解释" class="header-anchor">#</a> 13.5.3 Nacos持久化配置解释</h3> <p>Nacos默认自带的是嵌入式数据库derby</p> <p>因此我们需要完成derby到mysql切换配置步骤</p> <ul><li>在nacos\conf目录下，找到SQL脚本</li></ul> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/120.png" style="zoom:50%;"> <p>然后执行SQL脚本，同时修改application.properties目录</p> <p><a href="https://nacos.io/zh-cn/docs/deployment.html" target="_blank" rel="noopener noreferrer">官网地址<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language- extra-class"><pre class="language-text"><code>spring.datasource.platform=mysql

db.num=1
db.url.0=jdbc:mysql://127.0.0.1:3306/nacos_devtest?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true
db.user=root
db.password=root
</code></pre></div><p>修改完成后，启动nacos，可以看到是一个全新的空记录页面，以前是记录进derby</p> <h3 id="_13-5-4-linux版nacos-mysql生产环境配置"><a href="#_13-5-4-linux版nacos-mysql生产环境配置" class="header-anchor">#</a> 13.5.4 Linux版Nacos + Mysql生产环境配置</h3> <h4 id="_13-5-4-1-配置"><a href="#_13-5-4-1-配置" class="header-anchor">#</a> 13.5.4.1 配置</h4> <p>预计需要：1个Nginx + 3个nacos注册中心 + 1个mysql</p> <p>所有的请求过来，首先先打到nginx上</p> <h4 id="_13-5-4-2-nacos下载linux版本"><a href="#_13-5-4-2-nacos下载linux版本" class="header-anchor">#</a> 13.5.4.2 Nacos下载Linux版本</h4> <p>在nacos github下载：<code>https://github.com/alibaba/nacos/releases</code></p> <p>选择Linux版本下载</p> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/121.png" style="zoom:50%;"> <h4 id="_13-5-4-3-集群配置"><a href="#_13-5-4-3-集群配置" class="header-anchor">#</a> 13.5.4.3 集群配置</h4> <p>如果是一个nacos：启动 8848即可</p> <p>如果是多个nacos：3333,4444,5555</p> <p>那么就需要修改startup.sh里面的，传入端口号</p> <p>步骤：</p> <ul><li>Linux服务器上mysql数据库配置</li> <li>application.properties配置</li> <li>Linux服务器上nacos的集群配置cluster.conf
<ul><li>梳理出3台nacos集群的不同服务端口号</li> <li>复制出cluster.conf（备份）</li> <li>修改</li></ul></li></ul> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/122.png" alt=""></p> <ul><li><p>编辑Nacos的启动脚本startup.sh，使它能够接受不同的启动端口</p> <ul><li>/nacos/bin 目录下有startup.sh</li> <li>平时单机版的启动，直接./startup.sh</li> <li>但是集群启动时，我们希望可以类似其它软件的shell命令，传递不同的端口号启动不同的nacos实例，命令：./startup.sh -p 3333表示启动端口号为3333的nacos服务器实例，和上一步的cluster.conf配置一样。</li></ul> <p>修改启动脚本，添加P，这样能够明确nacos启动的什么脚本</p></li></ul> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/123.png" alt=""></p> <p>修改完成后，就能够使用下列命令启动集群了</p> <div class="language- extra-class"><pre class="language-text"><code>./startup.sh -p 3333
./startup.sh -p 4444
./startup.sh -p 5555
</code></pre></div><ul><li>Nginx的配置，由它作为负载均衡器
<ul><li>修改nginx的配置文件</li></ul></li></ul> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/124.png" style="zoom:50%;"> <p>作为负载均衡分流，同时upstream 支持weight</p> <p>通过nginx访问nacos节点：<code>http://192.168.111.144:1111/nacos/#/login</code></p> <p>微服务注册进集群中</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9002</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>payment<span class="token punctuation">-</span>provider
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.111.144<span class="token punctuation">:</span><span class="token number">1111</span> <span class="token comment"># 换成nginx的1111端口，做负债均衡</span>
<span class="token key atrule">management</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
    <span class="token key atrule">web</span><span class="token punctuation">:</span>
      <span class="token key atrule">exposure</span><span class="token punctuation">:</span>
        <span class="token key atrule">include</span><span class="token punctuation">:</span> <span class="token string">'*'</span>
</code></pre></div><h4 id="_13-5-4-4-总结"><a href="#_13-5-4-4-总结" class="header-anchor">#</a> 13.5.4.4 总结</h4> <p>Nginx + 3个Nacos + mysql的集群化配置</p> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/125.png" style="zoom:50%;"> <h1 id="_14-springcloudalibabasentinel实现熔断和限流"><a href="#_14-springcloudalibabasentinel实现熔断和限流" class="header-anchor">#</a> 14 SpringCloudAlibabaSentinel实现熔断和限流</h1> <h2 id="_14-1-sentinel"><a href="#_14-1-sentinel" class="header-anchor">#</a> 14.1 Sentinel</h2> <h3 id="_14-1-1-官网"><a href="#_14-1-1-官网" class="header-anchor">#</a> 14.1.1 官网</h3> <p>Github文档：https://github.com/alibaba/Sentinel/wiki/%E4%BB%8B%E7%BB%8D</p> <p>Sentinel：分布式系统的流量防卫兵，相当于Hystrix</p> <p>Hystrix存在的问题</p> <ul><li>需要我们程序员自己手工搭建监控平台</li> <li>没有一套web界面可以给我们进行更加细粒度化的配置，流量控制，速率控制，服务熔断，服务降级。。</li></ul> <p>这个时候Sentinel运营而生</p> <ul><li>单独一个组件，可以独立出来</li> <li>直接界面化的细粒度统一配置</li></ul> <p>约定 &gt; 配置 &gt;编码，都可以写在代码里，但是尽量使用注解和配置代替编码</p> <h3 id="_14-1-2-是什么"><a href="#_14-1-2-是什么" class="header-anchor">#</a> 14.1.2 是什么</h3> <p>随着微服务的流行，服务和服务之间的稳定性变得越来越重要。Sentinel 以流量为切入点，从流量控制、熔断降级、系统负载保护等多个维度保护服务的稳定性。</p> <p>Sentinel 具有以下特征:</p> <ul><li><strong>丰富的应用场景</strong>：Sentinel 承接了阿里巴巴近 10 年的双十一大促流量的核心场景，例如秒杀（即突发流量控制在系统容量可以承受的范围）、消息削峰填谷、集群流量控制、实时熔断下游不可用应用等。</li> <li><strong>完备的实时监控</strong>：Sentinel 同时提供实时的监控功能。您可以在控制台中看到接入应用的单台机器秒级数据，甚至 500 台以下规模的集群的汇总运行情况。</li> <li><strong>广泛的开源生态</strong>：Sentinel 提供开箱即用的与其它开源框架/库的整合模块，例如与 Spring Cloud、Dubbo、gRPC 的整合。您只需要引入相应的依赖并进行简单的配置即可快速地接入 Sentinel。</li> <li><strong>完善的 SPI 扩展点</strong>：Sentinel 提供简单易用、完善的 SPI 扩展接口。您可以通过实现扩展接口来快速地定制逻辑。例如定制规则管理、适配动态数据源等。</li></ul> <h3 id="_14-1-3-主要特征"><a href="#_14-1-3-主要特征" class="header-anchor">#</a> 14.1.3 主要特征</h3> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/126.png" alt=""></p> <h3 id="_14-1-4-生态圈"><a href="#_14-1-4-生态圈" class="header-anchor">#</a> 14.1.4 生态圈</h3> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/127.png" alt=""></p> <h2 id="_14-2-安装sentinel控制台"><a href="#_14-2-安装sentinel控制台" class="header-anchor">#</a> 14.2 安装Sentinel控制台</h2> <p>sentinel组件由两部分组成，后台和前台8080</p> <p>Sentinel分为两部分</p> <ul><li>核心库（Java客户端）不依赖任何框架/库，能够运行在所有Java运行时环境，同时对Dubbo、SpringCloud等框架也有较好的支持。</li> <li>控制台（Dashboard）基于SpringBoot开发，打包后可以直接运行，不需要额外的Tomcat等应用容器</li></ul> <p>使用 <code>java -jar</code> 启动，同时Sentinel默认的端口号是8080，因此不能被占用</p> <p>然后执行<code>mvn package</code> 进行构建，本博客同级目录下了，已经有个已经下载好的，欢迎自取</p> <h2 id="_14-3-初始化演示工程"><a href="#_14-3-初始化演示工程" class="header-anchor">#</a> 14.3 初始化演示工程</h2> <p>启动Nacos8848成功</p> <h3 id="_14-3-1-引入依赖"><a href="#_14-3-1-引入依赖" class="header-anchor">#</a> 14.3.1 引入依赖</h3> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token comment">&lt;!--SpringCloud ailibaba sentinel-datasource-nacos 后续做持久化用到--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.csp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>sentinel-datasource-nacos<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!--SpringCloud ailibaba sentinel --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-sentinel<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
&lt;/dependency
</code></pre></div><h3 id="_14-3-2-修改yml"><a href="#_14-3-2-修改yml" class="header-anchor">#</a> 14.3.2 修改YML</h3> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8401</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> cloudalibaba<span class="token punctuation">-</span>sentinel<span class="token punctuation">-</span>service
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment">#Nacos服务注册中心地址</span>
    <span class="token key atrule">sentinel</span><span class="token punctuation">:</span>
      <span class="token key atrule">transport</span><span class="token punctuation">:</span>
        <span class="token key atrule">dashboard</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8080</span> <span class="token comment">#配置Sentinel dashboard地址</span>
        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8719</span>
</code></pre></div><p>如果是在阿里云上进行配置，则需要额外配置一个 client-ip指定本机的ip</p> <h3 id="_14-3-3-增加业务类"><a href="#_14-3-3-增加业务类" class="header-anchor">#</a> 14.3.3 增加业务类</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FlowLimitController</span>
<span class="token punctuation">{</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/testA&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testA</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;------testA&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/testB&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testB</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&quot;\t&quot;</span><span class="token operator">+</span><span class="token string">&quot;...testB&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;------testB&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>启动8401微服务，查看Sentinel控制台</p> <p>我们会发现Sentinel里面空空如也，什么也没有，这是因为<strong>Sentinel采用的懒加载</strong></p> <p>执行一下访问即可：<code>http://localhost:8401/testA</code> <code>http://localhost:8401/testB</code></p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/128.png" alt=""></p> <h2 id="_14-4-流控规则"><a href="#_14-4-流控规则" class="header-anchor">#</a> 14.4 流控规则</h2> <h3 id="_14-4-1-基本介绍"><a href="#_14-4-1-基本介绍" class="header-anchor">#</a> 14.4.1 基本介绍</h3> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/130.png" alt=""></p> <p><strong>字段说明</strong></p> <ul><li>资源名：唯一名称，默认请求路径</li> <li>针对来源：Sentinel可以针对调用者进行限流，填写微服务名，默认default（不区分来源）</li> <li>阈值类型 / 单机阈值
<ul><li>QPS：（每秒钟的请求数量）：但调用该API的QPS达到阈值的时候，进行限流</li> <li>线程数：当调用该API的线程数达到阈值的时候，进行限流</li></ul></li> <li>是否集群：不需要集群</li> <li>流控模式
<ul><li>直接：api都达到限流条件时，直接限流</li> <li>关联：<strong>当关联的资源达到阈值，就限流自己</strong></li> <li>链路：只记录指定链路上的流量（指定资源从入口资源进来的流量，如果达到阈值，就进行限流）【API级别的针对来源】</li></ul></li> <li>流控效果
<ul><li>快速失败：直接失败，抛异常</li> <li>Warm UP：根据codeFactory（冷加载因子，默认3），从阈值/CodeFactor，经过预热时长，才达到设置的QPS阈值</li> <li>排队等待：匀速排队，让请求以匀速的速度通过，阈值类型必须设置QPS，否则无效</li></ul></li></ul> <h3 id="_14-4-2-流控模式"><a href="#_14-4-2-流控模式" class="header-anchor">#</a> 14.4.2 流控模式</h3> <h4 id="_14-4-2-1-直接-默认"><a href="#_14-4-2-1-直接-默认" class="header-anchor">#</a> 14.4.2.1 直接（默认）</h4> <p>我们给testA增加流控</p> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/131.png" style="zoom:67%;"> <p>即若1s以内，请求过了一次，就会抛出默认的失败。</p> <p>然后我们请求 <code>http://localhost:8401/testA</code>，就会出现失败，被限流，快速失败</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/132.png" alt=""></p> <p>思考：</p> <p>直接调用的是默认报错信息，能否有我们的后续处理，比如更加友好的提示，类似有hystrix的fallback方法</p> <p>线程数</p> <p>这里的线程数表示一次只有一个线程进行业务请求，当前出现请求无法响应的时候，会直接报错，例如，在方法的内部增加一个睡眠，那么后面来的就会失败</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/testD&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testD</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token string">&quot;------testD&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><h4 id="_14-4-2-2-关联"><a href="#_14-4-2-2-关联" class="header-anchor">#</a> 14.4.2.2 关联</h4> <p><strong>当关联的资源达到阈值时，就限流自己</strong></p> <p>当与A关联的资源B达到阈值后，就限流A自己，B惹事，A挂了</p> <p>场景：支付接口达到阈值后，就限流下订单的接口</p> <p>设置：</p> <p>当关联资源 /testB的QPS（每秒超过1个请求）达到阈值超过1时，就限流/testA的Rest访问地址，当关联资源达到阈值后，限制配置好的资源名</p> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/133.png" style="zoom:50%;"> <p>这个使用我们利用postman模拟并发密集访问<code>testB</code></p> <p>首先我们需要使用postman，创建一个请求</p> <p>同时将请求保存在 Collection中</p> <p>然后点击箭头，选中接口，选择run</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/134.png" alt=""></p> <p>点击运行，大批量线程高并发访问B，导致A失效了，同时我们点击访问 <code>http://localhost:8401/testA</code>，结果发现，我们的A已经挂了</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/135.png" alt=""></p> <p>在测试A接口</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/132.png" alt=""></p> <p>这就是我们的关联限流</p> <h4 id="_14-4-2-3-链路"><a href="#_14-4-2-3-链路" class="header-anchor">#</a> 14.4.2.3 链路</h4> <p>多个请求调用了同一个微服务</p> <h3 id="_14-4-3-流控效果"><a href="#_14-4-3-流控效果" class="header-anchor">#</a> 14.4.3 流控效果</h3> <h4 id="_14-4-3-1-直接"><a href="#_14-4-3-1-直接" class="header-anchor">#</a> 14.4.3.1 直接</h4> <p>快速失败，默认的流控处理</p> <ul><li>直接失败，抛出异常：Blocked by Sentinel（Flow limiting）</li></ul> <h4 id="_14-4-3-2-预热"><a href="#_14-4-3-2-预热" class="header-anchor">#</a> 14.4.3.2 预热</h4> <p>系统最怕的就是出现，平时访问是0，然后突然一瞬间来了10W的QPS（每秒10w次请求）</p> <p>公式：阈值 除以 clodFactor（默认值为3），经过预热时长后，才会达到阈值</p> <p>Warm Up方式，即预热/冷启动方式，当系统长期处于低水位的情况下，当流量突然增加时，直接把系统拉升到高水位可能会瞬间把系统压垮。通过冷启动，让通过的流量缓慢增加，在一定时间内逐渐增加到阈值，给冷系统一个预热的时间，避免冷系统被压垮。通常冷启动的过程系统允许的QPS曲线如下图所示</p> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/136.png" style="zoom:50%;"> <p>默认clodFactor为3，即请求QPS从threshold / 3开始，经预热时长逐渐提升至设定的QPS阈值</p> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/137.png" style="zoom:50%;"> <p>假设这个系统的QPS是10，那么最开始系统能够接受的 QPS = 10 / 3 = 3，然后从3的阈值逐渐在5秒内提升到10次请求阈值</p> <p>应用场景：</p> <p>秒杀系统在开启的瞬间，会有很多流量上来，很可能把系统打死，预热的方式就是为了保护系统，可能慢慢的把流量放进来，慢慢的把阈值增长到设置的阈值。</p> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/138.png" style="zoom:67%;"> <h4 id="_14-4-3-3-排队等待"><a href="#_14-4-3-3-排队等待" class="header-anchor">#</a> 14.4.3.3 排队等待</h4> <p>大家均速排队，让请求以均匀的速度通过，<strong>阈值类型必须设置成QPS</strong>，否则无效</p> <p>均速排队方式必须严格控制请求通过的间隔时间，也即让请求以匀速的速度通过，对应的是漏桶算法。</p> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/139.png" style="zoom:50%;"> <p>这种方式主要用于处理间隔性突发的流量，例如消息队列，想象一下这样的场景，在某一秒有大量的请求到来，而接下来的几秒处于空闲状态，我们系统系统能够接下来的空闲期间逐渐处理这些请求，而不是在第一秒直接拒绝多余的请求。</p> <p>设置含义：/testA 每秒1次请求，超过的话，就排队等待，等待时间超过20000毫秒，超过20s后会执行默认的失败</p> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/140.png" style="zoom:50%;"> <h2 id="_14-5-降级规则"><a href="#_14-5-降级规则" class="header-anchor">#</a> 14.5 降级规则</h2> <p><strong>流控只是对流量大小进行控制，并不会对响应超时、异常的情况进行处理</strong></p> <h3 id="_14-5-1-名词介绍"><a href="#_14-5-1-名词介绍" class="header-anchor">#</a> 14.5.1 名词介绍</h3> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/141.png" alt=""></p> <ul><li>RT（慢调用比例，平均响应时间，秒级）
<ul><li>平均响应时间，超过阈值 且 时间窗口内通过的请求 &gt;= 5，两个条件同时满足后出发降级</li> <li>窗口期过后，关闭断路器</li> <li>RT最大4900ms（更大的需要通过 -Dcsp.sentinel.staticstic.max.rt=XXXXX才能生效）</li></ul></li> <li>异常比例（秒级）
<ul><li><strong>QPA &gt;= 5 且异常比例（秒级）超过阈值时</strong>，触发降级；时间窗口结束后，关闭降级</li></ul></li> <li>异常数（分钟级）
<ul><li>异常数（分钟统计）超过阈值时，触发降级，时间窗口结束后，关闭降级</li></ul></li></ul> <h3 id="_14-5-2-概念"><a href="#_14-5-2-概念" class="header-anchor">#</a> 14.5.2 概念</h3> <p>Sentinel熔断降级会在调用链路中某个资源出现不稳定状态时（例如调用超时或异常异常比例升高），对这个资源的调用进行限制，让请求快速失败，避免影响到其它的资源而导致级联错误。</p> <p>当资源被降级后，在接下来的降级时间窗口之内，对该资源的调用都进行自动熔断（默认行为是抛出DegradeException）</p> <p>Sentinel的断路器是没有半开状态</p> <p>半开的状态，系统自动去检测是否请求有异常，没有异常就关闭断路器恢复使用，有异常则继续打开断路器不可用，具体可以参考hystrix</p> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/142.png" style="zoom:50%;"> <h3 id="_14-5-2-降级策略实战"><a href="#_14-5-2-降级策略实战" class="header-anchor">#</a> 14.5.2 降级策略实战</h3> <h4 id="_14-5-2-1-rt"><a href="#_14-5-2-1-rt" class="header-anchor">#</a> 14.5.2.1 RT</h4> <p>平均响应时间 (<code>DEGRADE_GRADE_RT</code>)：当 1s 内持续进入 N 个请求，对应时刻的平均响应时间（秒级）均超过阈值（<code>count</code>，以 ms 为单位），那么在接下的时间窗口（<code>DegradeRule</code> 中的 <code>timeWindow</code>，以 s 为单位）之内，对这个方法的调用都会自动地熔断（抛出 <code>DegradeException</code>）。注意 Sentinel 默认统计的 RT 上限是 4900 ms，<strong>超出此阈值的都会算作 4900 ms</strong>，若需要变更此上限可以通过启动配置项 <code>-Dcsp.sentinel.statistic.max.rt=xxx</code> 来配置。</p> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/143.png" style="zoom:50%;"> <p>代码测试</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/testD&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testD</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;testD 异常比例&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;------testD&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>然后使用Jmeter压力测试工具进行测试</p> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/144.png" alt=""></p> <p>按照上述操作，永远1秒种打进来10个线程，大于5个了，调用tesetD，我们希望200毫秒内处理完本次任务，如果200毫秒没有处理完，在未来的1秒的时间窗口内，断路器打开（保险丝跳闸）微服务不可用，保险丝跳闸断电</p> <div class="language- extra-class"><pre class="language-text"><code>Blocked by Sentinel (flow limiting)
</code></pre></div><p><img src="http://moxi159753.gitee.io/learningnotes/SpringCloud/SpringCloud2020/14_SpringCloudAlibabaSentinel%E5%AE%9E%E7%8E%B0%E7%86%94%E6%96%AD%E5%92%8C%E9%99%90%E6%B5%81/images/image-20200416103959047.png" alt="image-20200416103959047"></p> <p>后续我们停止使用jmeter，没有那么大的访问量了，断路器关闭（保险丝恢复），微服务恢复OK</p> <h4 id="_14-5-2-2-异常比例"><a href="#_14-5-2-2-异常比例" class="header-anchor">#</a> 14.5.2.2 异常比例</h4> <p>异常比例 (<code>DEGRADE_GRADE_EXCEPTION_RATIO</code>)：当资源的每秒请求量 &gt;= N（可配置），并且每秒异常总数占通过量的比值超过阈值（<code>DegradeRule</code> 中的 <code>count</code>）之后，资源进入降级状态，即在接下的时间窗口（<code>DegradeRule</code> 中的 <code>timeWindow</code>，以 s 为单位）之内，对这个方法的调用都会自动地返回。异常比率的阈值范围是 <code>[0.0, 1.0]</code>，代表 0% - 100%。</p> <p><img src="http://moxi159753.gitee.io/learningnotes/SpringCloud/SpringCloud2020/14_SpringCloudAlibabaSentinel%E5%AE%9E%E7%8E%B0%E7%86%94%E6%96%AD%E5%92%8C%E9%99%90%E6%B5%81/images/image-20200416104157714.png" alt="image-20200416104157714"></p> <p>单独访问一次，必然来一次报错一次，开启jmeter后，直接高并发发送请求，多次调用达到我们的配置条件了，断路器开启（保险丝跳闸），微服务不可用，不在报错，而是服务降级了</p> <p><img src="http://moxi159753.gitee.io/learningnotes/SpringCloud/SpringCloud2020/14_SpringCloudAlibabaSentinel%E5%AE%9E%E7%8E%B0%E7%86%94%E6%96%AD%E5%92%8C%E9%99%90%E6%B5%81/images/image-20200416104919798.png" alt="image-20200416104919798"></p> <p>设置3秒内，如果请求百分50出错，那么就会熔断</p> <p><img src="http://moxi159753.gitee.io/learningnotes/SpringCloud/SpringCloud2020/14_SpringCloudAlibabaSentinel%E5%AE%9E%E7%8E%B0%E7%86%94%E6%96%AD%E5%92%8C%E9%99%90%E6%B5%81/images/image-20200416104908479.png" alt="image-20200416104908479"></p> <p>我们用jmeter每秒发送10次请求，3秒后，再次调用 <code>localhost:8401/testD</code> 出现服务降级</p> <p><img src="http://moxi159753.gitee.io/learningnotes/SpringCloud/SpringCloud2020/14_SpringCloudAlibabaSentinel%E5%AE%9E%E7%8E%B0%E7%86%94%E6%96%AD%E5%92%8C%E9%99%90%E6%B5%81/images/image-20200416104858019.png" alt="image-20200416104858019"></p> <h4 id="_14-5-2-3-异常数"><a href="#_14-5-2-3-异常数" class="header-anchor">#</a> 14.5.2.3 异常数</h4> <p>异常数 (<code>DEGRADE_GRADE_EXCEPTION_COUNT</code>)：当资源近 1 分钟的异常数目超过阈值之后会进行熔断。注意由于统计时间窗口是分钟级别的，若 <code>timeWindow</code> 小于 60s，则结束熔断状态后仍可能再进入熔断状态</p> <p>==时间窗口一定要大于等于60秒==</p> <p>异常数是按分钟来统计的</p> <p><img src="http://moxi159753.gitee.io/learningnotes/SpringCloud/SpringCloud2020/14_SpringCloudAlibabaSentinel%E5%AE%9E%E7%8E%B0%E7%86%94%E6%96%AD%E5%92%8C%E9%99%90%E6%B5%81/images/image-20200416105132256.png" alt="image-20200416105132256"></p> <p>下面设置是，一分钟内出现5次，则熔断</p> <p><img src="http://moxi159753.gitee.io/learningnotes/SpringCloud/SpringCloud2020/14_SpringCloudAlibabaSentinel%E5%AE%9E%E7%8E%B0%E7%86%94%E6%96%AD%E5%92%8C%E9%99%90%E6%B5%81/images/image-20200416105535535.png" alt="image-20200416105535535"></p> <p>首先我们再次访问 <code>http://localhost:8401/testE</code>，第一次访问绝对报错，因为除数不能为0，我们看到error窗口，但是达到5次报错后，进入熔断后的降级</p> <p>降级产生的原因：大部分是熔断或者异常或者超时引发的</p> <p>熔断就是不让访问，降级就是返回结果不是正常我们想要的结果，而是出现异常</p> <h2 id="_14-6-sentinel热点规则"><a href="#_14-6-sentinel热点规则" class="header-anchor">#</a> 14.6 Sentinel热点规则</h2> <h3 id="_14-6-1-什么是热点数据"><a href="#_14-6-1-什么是热点数据" class="header-anchor">#</a> 14.6.1 什么是热点数据</h3> <p><a href="https://github.com/alibaba/Sentinel/wiki/%E7%83%AD%E7%82%B9%E5%8F%82%E6%95%B0%E9%99%90%E6%B5%81" target="_blank" rel="noopener noreferrer">Github文档传送门<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>何为热点？热点即经常访问的数据。很多时候我们希望统计某个热点数据中访问频次最高的 Top K 数据，并对其访问进行限制。比如：</p> <ul><li>商品 ID 为参数，统计一段时间内最常购买的商品 ID 并进行限制</li> <li>用户 ID 为参数，针对一段时间内频繁访问的用户 ID 进行限制</li></ul> <p>热点参数限流会统计传入参数中的热点参数，并根据配置的限流阈值与模式，对包含热点参数的资源调用进行限流。热点参数限流可以看做是一种特殊的流量控制，仅对包含热点参数的资源调用生效。</p> <p><img src="http://moxi159753.gitee.io/learningnotes/SpringCloud/SpringCloud2020/14_SpringCloudAlibabaSentinel%E5%AE%9E%E7%8E%B0%E7%86%94%E6%96%AD%E5%92%8C%E9%99%90%E6%B5%81/images/image-20200416121306501.png" alt="image-20200416121306501"></p> <p>Sentinel 利用 LRU 策略统计最近最常访问的热点参数，结合令牌桶算法来进行参数级别的流控。热点参数限流支持集群模式。</p> <h3 id="_14-6-2-兜底的方法"><a href="#_14-6-2-兜底的方法" class="header-anchor">#</a> 14.6.2 兜底的方法</h3> <p>分为系统默认的和客户自定义的，两种，之前的case中，限流出现问题了，都用sentinel系统默认的提示：Blocked By Sentinel，我们能不能自定义，类似于hystrix，某个方法出现问题了，就找到对应的兜底降级方法。</p> <p>从 <code>@HystrixCommand</code> 到 <code>@SentinelResource</code></p> <p>之前的case，限流出问题后，都是用 sentinel 系统默认的提示 : Blocked by Sentinel(flow limiting)</p> <h3 id="_14-6-3-配置"><a href="#_14-6-3-配置" class="header-anchor">#</a> 14.6.3 配置</h3> <p>@SentinelResource的value，就是我们的资源名，也就是对哪个方法配置热点规则</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/testHotKey&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;testHotKey&quot;</span><span class="token punctuation">,</span>blockHandler <span class="token operator">=</span> <span class="token string">&quot;deal_testHotKey&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testHotKey</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;p1&quot;</span><span class="token punctuation">,</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> p1<span class="token punctuation">,</span>
                             <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;p2&quot;</span><span class="token punctuation">,</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> p2<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">//int age = 10/0;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;------testHotKey&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 和上面的参数一样，不错需要加入 BlockException</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> deal_testHotKey <span class="token punctuation">(</span><span class="token class-name">String</span> p1<span class="token punctuation">,</span> <span class="token class-name">String</span> p2<span class="token punctuation">,</span> <span class="token class-name">BlockException</span> exception<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;------deal_testHotKey,o(╥﹏╥)o&quot;</span><span class="token punctuation">;</span>  <span class="token comment">//  兜底的方法</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>兜底降级方法对应为 <code>deal_testHotKey</code>，资源名为 <code>testHotKey</code></p> <p>我们对参数0，设置热点key进行限流</p> <p><img src="http://moxi159753.gitee.io/learningnotes/SpringCloud/SpringCloud2020/14_SpringCloudAlibabaSentinel%E5%AE%9E%E7%8E%B0%E7%86%94%E6%96%AD%E5%92%8C%E9%99%90%E6%B5%81/images/image-20200416122406091.png" alt="image-20200416122406091"></p> <p>参数索引：0，对应 <code>p1</code>，资源名 <code>testHotKey</code></p> <p>配置完成后</p> <p><img src="http://moxi159753.gitee.io/learningnotes/SpringCloud/SpringCloud2020/14_SpringCloudAlibabaSentinel%E5%AE%9E%E7%8E%B0%E7%86%94%E6%96%AD%E5%92%8C%E9%99%90%E6%B5%81/images/image-20200416122450886.png" alt="image-20200416122450886"></p> <p>当我们不断的请求时候，也就是以第一个参数为目标，请求接口，我们会发现多次请求后</p> <div class="language- extra-class"><pre class="language-text"><code>http://localhost:8401/testHotKey?p1=a
</code></pre></div><p>就会出现以下的兜底错误</p> <div class="language- extra-class"><pre class="language-text"><code>------deal_testHotKey,o(╥﹏╥)
</code></pre></div><p>这是因为我们针对第一个参数进行了限制，当我们QPS超过1的时候，就会触发兜底的错误</p> <p>假设我们请求的接口是：<code>http://localhost:8401/testHotKey?p2=a</code> ，我们会发现他就没有进行限流</p> <p><img src="http://moxi159753.gitee.io/learningnotes/SpringCloud/SpringCloud2020/14_SpringCloudAlibabaSentinel%E5%AE%9E%E7%8E%B0%E7%86%94%E6%96%AD%E5%92%8C%E9%99%90%E6%B5%81/images/image-20200416123605410.png" alt="image-20200416123605410"></p> <ul><li><code>@SentinelResource(value=&quot;testHotKey&quot;)</code>：异常打到了前台用户界面看到，不友好</li> <li><code>@SentinelResource(value=&quot;testHotKey&quot;, blockHandler=&quot;deal_testHotKey&quot;)</code>,方法 testHostKey里面第一个参数 <code>p1</code> 只要 QPS（阈值）超过每秒一次，马上降级处理，用了我们自定义的</li></ul> <h3 id="_14-6-4-参数例外项"><a href="#_14-6-4-参数例外项" class="header-anchor">#</a> 14.6.4 参数例外项</h3> <p>上述案例演示了第一个参数p1，当QPS超过1秒1次点击后，马上被限流</p> <ul><li>普通：超过一秒1个后，达到阈值1后马上被限流</li> <li>我们期望p1参数当它达到某个特殊值时，它的限流值和平时不一样</li> <li>特例：假设当p1的值等于5时，它的阈值可以达到200</li> <li>一句话说：当key为特殊值的时候，不被限制</li></ul> <p><img src="http://moxi159753.gitee.io/learningnotes/SpringCloud/SpringCloud2020/14_SpringCloudAlibabaSentinel%E5%AE%9E%E7%8E%B0%E7%86%94%E6%96%AD%E5%92%8C%E9%99%90%E6%B5%81/images/image-20200416123922325.png" alt="image-20200416123922325"></p> <p>平时的时候，参数1的QPS是1，超过的时候被限流，但是有特殊值，比如5，那么它的阈值就是200</p> <p>我们通过 <code>http://localhost:8401/testHotKey?p1=5</code> 一直刷新，发现不会触发兜底的方法，这就是参数例外项</p> <p>热点参数的注意点，参数必须是基本类型或者String</p> <h3 id="_14-6-5-结语"><a href="#_14-6-5-结语" class="header-anchor">#</a> 14.6.5 结语</h3> <p><strong><code>@SentinelResource</code> 处理的是Sentinel控制台配置的违规情况，有blockHandler方法配置的兜底处理</strong></p> <p>RuntimeException，如 int a = 10/0 ; 这个是java运行时抛出的异常，RuntimeException，@RentinelResource不管</p> <p>也就是说：<strong><code>@SentinelResource</code> 主管配置出错，运行出错不管。</strong></p> <p>如果想要有配置出错，和运行出错的话，那么可以设置 fallback</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/testHotKey&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;testHotKey&quot;</span><span class="token punctuation">,</span>blockHandler <span class="token operator">=</span> <span class="token string">&quot;deal_testHotKey&quot;</span><span class="token punctuation">,</span> fallback <span class="token operator">=</span> <span class="token string">&quot;fallBack&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testHotKey</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;p1&quot;</span><span class="token punctuation">,</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> p1<span class="token punctuation">,</span>
                             <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;p2&quot;</span><span class="token punctuation">,</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> p2<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">//int age = 10/0;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;------testHotKey&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><h2 id="_14-7-sentinel系统配置"><a href="#_14-7-sentinel系统配置" class="header-anchor">#</a> 14.7 Sentinel系统配置</h2> <p>Sentinel 系统自适应限流从整体维度对应用入口流量进行控制，结合应用的 Load、CPU 使用率、总体平均 RT、入口 QPS 和并发线程数等几个维度的监控指标，通过自适应的流控策略，让系统的入口流量和系统的负载达到一个平衡，让系统尽可能跑在最大吞吐量的同时保证系统整体的稳定性。</p> <p>系统保护规则是<strong>从应用级别的入口流量进行控制，从单台机器的 load、CPU 使用率、平均 RT、入口 QPS 和并发线程数等几个维度监控应用指标</strong>，让系统尽可能跑在最大吞吐量的同时保证系统整体的稳定性。</p> <p>系统保护规则是应用整体维度的，而不是资源维度的，并且<strong>仅对入口流量生效</strong>。入口流量指的是进入应用的流量（<code>EntryType.IN</code>），比如 Web 服务或 Dubbo 服务端接收的请求，都属于入口流量。</p> <p>系统规则支持以下的模式：</p> <ul><li><strong>Load 自适应</strong>（仅对 Linux/Unix-like 机器生效）：系统的 load1 作为启发指标，进行自适应系统保护。当系统 load1 超过设定的启发值，且系统当前的并发线程数超过估算的系统容量时才会触发系统保护（BBR 阶段）。系统容量由系统的 <code>maxQps * minRt</code> 估算得出。设定参考值一般是 <code>CPU cores * 2.5</code>。</li> <li><strong>CPU usage</strong>（1.5.0+ 版本）：当系统 CPU 使用率超过阈值即触发系统保护（取值范围 0.0-1.0），比较灵敏。</li> <li><strong>平均 RT</strong>：当单台机器上所有入口流量的平均 RT 达到阈值即触发系统保护，单位是毫秒。</li> <li><strong>并发线程数</strong>：当单台机器上所有入口流量的并发线程数达到阈值即触发系统保护。</li> <li><strong>入口 QPS</strong>：当单台机器上所有入口流量的 QPS 达到阈值即触发系统保护。</li></ul> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/145.png" alt=""></p> <p>这样相当于设置了全局的QPS过滤，1秒点击1下，OK，超过上述，疯狂点击，返回了自己定义的限流处理信息，限流发生</p> <h2 id="_14-8-sentinelresource注解"><a href="#_14-8-sentinelresource注解" class="header-anchor">#</a> 14.8 @SentinelResource注解</h2> <ul><li>按资源名称限流 + 后续处理</li> <li>按URL地址限流 + 后续处理</li></ul> <h3 id="_14-8-1-问题"><a href="#_14-8-1-问题" class="header-anchor">#</a> 14.8.1 问题</h3> <ul><li>系统默认的，没有体现我们自己的业务要求</li> <li>依照现有条件，我们自定义的处理方法又和业务代码耦合在一块，不直观</li> <li>每个业务方法都添加一个兜底方法，那代码膨胀加剧</li> <li>全局统一的处理方法没有体现</li> <li>关闭8401，发现流控规则已经消失，说明这个是<strong>没有持久化</strong></li></ul> <h3 id="_14-8-2-客户自定义限流处理逻辑"><a href="#_14-8-2-客户自定义限流处理逻辑" class="header-anchor">#</a> 14.8.2 客户自定义限流处理逻辑</h3> <p>创建CustomerBlockHandler类用于自定义限流处理逻辑</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomerBlockHandler</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">CommonResult</span> <span class="token function">handlerException</span><span class="token punctuation">(</span><span class="token class-name">BlockException</span> exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CommonResult</span><span class="token punctuation">(</span><span class="token number">444</span><span class="token punctuation">,</span> <span class="token string">&quot;按客户自定义  global exception-----------------1号&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">CommonResult</span> <span class="token function">handlerException2</span><span class="token punctuation">(</span><span class="token class-name">BlockException</span> exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CommonResult</span><span class="token punctuation">(</span><span class="token number">444</span><span class="token punctuation">,</span> <span class="token string">&quot;按客户自定义  global exception-----------------2号&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>==注意：这里不需要注入 spring容器中，发现函数是通过反射获取的==</p> <p>那么我们在使用的时候，就可以首先指定是哪个类，哪个方法</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/rateLimit/customerBlockHandler&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;customerBlockHandler&quot;</span><span class="token punctuation">,</span>
            blockHandlerClass <span class="token operator">=</span> <span class="token class-name">CustomerBlockHandler</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
            blockHandler <span class="token operator">=</span> <span class="token string">&quot;handlerException2&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">CommonResult</span> <span class="token function">customerBlockHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CommonResult</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token string">&quot;按客戶自定义&quot;</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Payment</span><span class="token punctuation">(</span><span class="token number">2020L</span><span class="token punctuation">,</span><span class="token string">&quot;serial003&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/146.png" alt=""></p> <p>只有给资源名加流控才可以，对url加流控会使用默认的兜底方法</p> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/147.png" style="zoom:67%;"> <h3 id="_14-8-3-更多注解属性说明"><a href="#_14-8-3-更多注解属性说明" class="header-anchor">#</a> 14.8.3 更多注解属性说明</h3> <p>所有的代码都要用try - catch - finally 进行处理</p> <p>sentinel主要有三个核心API</p> <ul><li>Sphu定义资源</li> <li>Tracer定义统计</li> <li>ContextUtil定义了上下文</li></ul> <h2 id="_14-9-服务熔断"><a href="#_14-9-服务熔断" class="header-anchor">#</a> 14.9 服务熔断</h2> <p>sentinel整合Ribbon + openFeign + fallback</p> <p>搭建 9003 和 9004 服务提供者</p> <h3 id="_14-9-1-不设置任何参数"><a href="#_14-9-1-不设置任何参数" class="header-anchor">#</a> 14.9.1 不设置任何参数</h3> <p>然后在使用 84作为服务消费者，当我们值使用 <code>@SentinelResource</code>注解时，不添加任何参数，那么如果出错的话，是直接返回一个error页面，对前端用户非常不友好，因此我们需要配置一个兜底的方法</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/consumer/fallback/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;fallback&quot;</span><span class="token punctuation">)</span> <span class="token comment">//没有配置</span>
    <span class="token keyword">public</span> <span class="token class-name">CommonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Payment</span><span class="token punctuation">&gt;</span></span> <span class="token function">fallback</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">CommonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Payment</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span>SERVICE_URL <span class="token operator">+</span> <span class="token string">&quot;/paymentSQL/&quot;</span><span class="token operator">+</span>id<span class="token punctuation">,</span><span class="token class-name">CommonResult</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span> <span class="token punctuation">(</span><span class="token string">&quot;IllegalArgumentException,非法参数异常....&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span> <span class="token punctuation">(</span><span class="token string">&quot;NullPointerException,该ID没有对应记录,空指针异常&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><h3 id="_14-9-2-设置fallback"><a href="#_14-9-2-设置fallback" class="header-anchor">#</a> 14.9.2 设置fallback</h3> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/consumer/fallback/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;fallback&quot;</span><span class="token punctuation">,</span>fallback <span class="token operator">=</span> <span class="token string">&quot;handlerFallback&quot;</span><span class="token punctuation">)</span> <span class="token comment">//fallback只负责业务异常</span>
    <span class="token keyword">public</span> <span class="token class-name">CommonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Payment</span><span class="token punctuation">&gt;</span></span> <span class="token function">fallback</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">CommonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Payment</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span>SERVICE_URL <span class="token operator">+</span> <span class="token string">&quot;/paymentSQL/&quot;</span><span class="token operator">+</span>id<span class="token punctuation">,</span><span class="token class-name">CommonResult</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span> <span class="token punctuation">(</span><span class="token string">&quot;IllegalArgumentException,非法参数异常....&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span> <span class="token punctuation">(</span><span class="token string">&quot;NullPointerException,该ID没有对应记录,空指针异常&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//本例是fallback</span>
    <span class="token keyword">public</span> <span class="token class-name">CommonResult</span> <span class="token function">handlerFallback</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span>  <span class="token class-name">Long</span> id<span class="token punctuation">,</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Payment</span> payment <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Payment</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span><span class="token string">&quot;null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CommonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">444</span><span class="token punctuation">,</span><span class="token string">&quot;兜底异常handlerFallback,exception内容  &quot;</span><span class="token operator">+</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>**加入fallback后，当我们程序运行出错时，我们会有一个兜底的异常执行，**但是服务限流和熔断的异常还是出现默认的</p> <h3 id="_14-9-3-设置blockhandler"><a href="#_14-9-3-设置blockhandler" class="header-anchor">#</a> 14.9.3 设置blockHandler</h3> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/consumer/fallback/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;fallback&quot;</span><span class="token punctuation">,</span>blockHandler <span class="token operator">=</span> <span class="token string">&quot;blockHandler&quot;</span> <span class="token punctuation">,</span>fallback <span class="token operator">=</span> <span class="token string">&quot;handlerFallback&quot;</span><span class="token punctuation">)</span> <span class="token comment">//blockHandler只负责sentinel控制台配置违规</span>
    <span class="token keyword">public</span> <span class="token class-name">CommonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Payment</span><span class="token punctuation">&gt;</span></span> <span class="token function">fallback</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">CommonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Payment</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span>SERVICE_URL <span class="token operator">+</span> <span class="token string">&quot;/paymentSQL/&quot;</span><span class="token operator">+</span>id<span class="token punctuation">,</span><span class="token class-name">CommonResult</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span> <span class="token punctuation">(</span><span class="token string">&quot;IllegalArgumentException,非法参数异常....&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span> <span class="token punctuation">(</span><span class="token string">&quot;NullPointerException,该ID没有对应记录,空指针异常&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//本例是blockHandler</span>
    <span class="token keyword">public</span> <span class="token class-name">CommonResult</span> <span class="token function">blockHandler</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span>  <span class="token class-name">Long</span> id<span class="token punctuation">,</span><span class="token class-name">BlockException</span> blockException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Payment</span> payment <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Payment</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span><span class="token string">&quot;null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CommonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">445</span><span class="token punctuation">,</span><span class="token string">&quot;blockHandler-sentinel限流,无此流水: blockException  &quot;</span><span class="token operator">+</span>blockException<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>payment<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>进行逻辑处理</p> <h3 id="_14-9-4-blockhandler和fallback一起配置"><a href="#_14-9-4-blockhandler和fallback一起配置" class="header-anchor">#</a> 14.9.4 blockHandler和fallback一起配置</h3> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/consumer/fallback/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;fallback&quot;</span><span class="token punctuation">,</span>blockHandler <span class="token operator">=</span> <span class="token string">&quot;blockHandler&quot;</span><span class="token punctuation">)</span> <span class="token comment">//blockHandler只负责sentinel控制台配置违规</span>
    <span class="token keyword">public</span> <span class="token class-name">CommonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Payment</span><span class="token punctuation">&gt;</span></span> <span class="token function">fallback</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">CommonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Payment</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span>SERVICE_URL <span class="token operator">+</span> <span class="token string">&quot;/paymentSQL/&quot;</span><span class="token operator">+</span>id<span class="token punctuation">,</span><span class="token class-name">CommonResult</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span> <span class="token punctuation">(</span><span class="token string">&quot;IllegalArgumentException,非法参数异常....&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span> <span class="token punctuation">(</span><span class="token string">&quot;NullPointerException,该ID没有对应记录,空指针异常&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>==若blockHandler 和 fallback都进行了配置，则被限流降级而抛出 BlockException时，只会进入blockHandler处理逻辑==。当然一起配，性能更好。然后如果走了 fallback 就不会走 流控规则</p> <h3 id="_14-9-5-异常忽略"><a href="#_14-9-5-异常忽略" class="header-anchor">#</a> 14.9.5 异常忽略</h3> <p><img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/148.png" alt=""></p> <h2 id="_14-10-feign系列"><a href="#_14-10-feign系列" class="header-anchor">#</a> 14.10 Feign系列</h2> <h4 id="_14-10-1-引入依赖"><a href="#_14-10-1-引入依赖" class="header-anchor">#</a> 14.10.1 引入依赖</h4> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token comment">&lt;!--SpringCloud openfeign --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h4 id="_14-10-2-修改yml"><a href="#_14-10-2-修改yml" class="header-anchor">#</a> 14.10.2 修改YML</h4> <p>消费端</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">84</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>order<span class="token punctuation">-</span>consumer
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span>
    <span class="token key atrule">sentinel</span><span class="token punctuation">:</span>
      <span class="token key atrule">transport</span><span class="token punctuation">:</span>
        <span class="token comment">#配置Sentinel dashboard地址</span>
        <span class="token key atrule">dashboard</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8080</span>
        <span class="token comment">#默认8719端口，假如被占用会自动从8719开始依次+1扫描,直至找到未被占用的端口</span>
        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8719</span>

<span class="token comment">#消费者将要去访问的微服务名称(注册成功进nacos的微服务提供者)</span>
<span class="token key atrule">service-url</span><span class="token punctuation">:</span>
  <span class="token key atrule">nacos-user-service</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//nacos<span class="token punctuation">-</span>payment<span class="token punctuation">-</span>provider

<span class="token comment"># 激活Sentinel对Feign的支持</span>
<span class="token key atrule">feign</span><span class="token punctuation">:</span>
  <span class="token key atrule">sentinel</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre></div><p>服务端</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9003</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>payment<span class="token punctuation">-</span>provider
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment">#配置Nacos地址</span>

<span class="token key atrule">management</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
    <span class="token key atrule">web</span><span class="token punctuation">:</span>
      <span class="token key atrule">exposure</span><span class="token punctuation">:</span>
        <span class="token key atrule">include</span><span class="token punctuation">:</span> <span class="token string">'*'</span>
</code></pre></div><p>9004 同理</p> <h4 id="_14-10-3-启动类激活feign"><a href="#_14-10-3-启动类激活feign" class="header-anchor">#</a> 14.10.3 启动类激活Feign</h4> <p>消费端</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableFeignClients</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderNacosMain84</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">OrderNacosMain84</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>服务端</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PaymentMain9003</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">PaymentMain9003</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>都需要注入进 nacos，才能进行服务调用</p> <h4 id="_14-10-4-引入feign接口"><a href="#_14-10-4-引入feign接口" class="header-anchor">#</a> 14.10.4 引入Feign接口</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;nacos-payment-provider&quot;</span><span class="token punctuation">,</span>fallback <span class="token operator">=</span> <span class="token class-name">PaymentFallbackService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">PaymentService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/paymentSQL/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">CommonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Payment</span><span class="token punctuation">&gt;</span></span> <span class="token function">paymentSQL</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>进行调用服务端的接口，并设置兜底方法</p> <h4 id="_14-10-5-加入fallback兜底方法实现"><a href="#_14-10-5-加入fallback兜底方法实现" class="header-anchor">#</a> 14.10.5 加入fallback兜底方法实现</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PaymentFallbackService</span> <span class="token keyword">implements</span> <span class="token class-name">PaymentService</span>
<span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">CommonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Payment</span><span class="token punctuation">&gt;</span></span> <span class="token function">paymentSQL</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CommonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">44444</span><span class="token punctuation">,</span><span class="token string">&quot;服务降级返回,---PaymentFallbackService&quot;</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Payment</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span><span class="token string">&quot;errorSerial&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_14-10-6-测试"><a href="#_14-10-6-测试" class="header-anchor">#</a> 14.10.6 测试</h4> <p>请求接口：<code>http://localhost:84/consumer/paymentSQL/1</code></p> <p>测试84调用9003，此时故意关闭9003微服务提供者，看84消费侧自动降级</p> <p>我们发现过了一段时间后，会触发服务降级，返回失败的方法</p> <h2 id="_14-11-熔断框架对比"><a href="#_14-11-熔断框架对比" class="header-anchor">#</a> 14.11 熔断框架对比</h2> <p><img src="http://moxi159753.gitee.io/learningnotes/SpringCloud/SpringCloud2020/14_SpringCloudAlibabaSentinel%E5%AE%9E%E7%8E%B0%E7%86%94%E6%96%AD%E5%92%8C%E9%99%90%E6%B5%81/images/image-20200416215711875.png" alt="image-20200416215711875"></p> <h2 id="_14-12-sentinel规则持久化"><a href="#_14-12-sentinel规则持久化" class="header-anchor">#</a> 14.12 Sentinel规则持久化</h2> <h3 id="_14-12-1-是什么"><a href="#_14-12-1-是什么" class="header-anchor">#</a> 14.12.1 是什么</h3> <p>一旦我们重启应用，sentinel规则将会消失，生产环境需要将规则进行持久化</p> <h3 id="_14-12-2-怎么玩"><a href="#_14-12-2-怎么玩" class="header-anchor">#</a> 14.12.2 怎么玩</h3> <p>将限流配置规则持久化进Nacos保存，只要刷新8401某个rest地址，sentinel控制台的流控规则就能看到，只要Nacos里面的配置不删除，针对8401上的流控规则持续有效</p> <h3 id="_14-12-3-解决方法"><a href="#_14-12-3-解决方法" class="header-anchor">#</a> 14.12.3 解决方法</h3> <p>使用nacos持久化保存</p> <h4 id="_14-12-3-1-引入依赖"><a href="#_14-12-3-1-引入依赖" class="header-anchor">#</a> 14.12.3.1 引入依赖</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span><span class="token class-name">SpringCloud</span> ailibaba sentinel<span class="token operator">-</span>datasource<span class="token operator">-</span>nacos 后续做持久化用到<span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>sentinel<span class="token operator">-</span>datasource<span class="token operator">-</span>nacos<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
</code></pre></div><h4 id="_14-12-3-2-修改yml"><a href="#_14-12-3-2-修改yml" class="header-anchor">#</a> 14.12.3.2 修改yml</h4> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8401</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> cloudalibaba<span class="token punctuation">-</span>sentinel<span class="token punctuation">-</span>service
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span> <span class="token comment">#Nacos服务注册中心地址</span>
    <span class="token key atrule">sentinel</span><span class="token punctuation">:</span>
      <span class="token key atrule">transport</span><span class="token punctuation">:</span>
        <span class="token key atrule">dashboard</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8080</span> <span class="token comment">#配置Sentinel dashboard地址</span>
        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8719</span>
      <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
        <span class="token key atrule">ds1</span><span class="token punctuation">:</span>
          <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
            <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span>
            <span class="token key atrule">dataId</span><span class="token punctuation">:</span> cloudalibaba<span class="token punctuation">-</span>sentinel<span class="token punctuation">-</span>service
            <span class="token key atrule">groupId</span><span class="token punctuation">:</span> DEFAULT_GROUP
            <span class="token key atrule">data-type</span><span class="token punctuation">:</span> json
            <span class="token key atrule">rule-type</span><span class="token punctuation">:</span> flow

<span class="token key atrule">management</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
    <span class="token key atrule">web</span><span class="token punctuation">:</span>
      <span class="token key atrule">exposure</span><span class="token punctuation">:</span>
        <span class="token key atrule">include</span><span class="token punctuation">:</span> <span class="token string">'*'</span>

<span class="token key atrule">feign</span><span class="token punctuation">:</span>
  <span class="token key atrule">sentinel</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 激活Sentinel对Feign的支持</span>
</code></pre></div><p><code>type=flow</code> 以 JSON 格式返回现有的限流规则，degrade 返回现有生效的降级规则列表，system 则返回系统保护规则。</p> <h4 id="_14-12-3-3-添加nacos配置"><a href="#_14-12-3-3-添加nacos配置" class="header-anchor">#</a> 14.12.3.3 添加nacos配置</h4> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/149.png" style="zoom:67%;"> <p>内容解析</p> <img src="https://cdn.jsdelivr.net/gh/winden96/jsdelivr@1.0/SpringCloud/asserts/150.png" style="zoom:50%;"> <ul><li>resource：资源名称</li> <li>limitApp：来源应用</li> <li>grade：阈值类型，0表示线程数，1表示QPS</li> <li>count：单机阈值</li> <li>strategy：流控模式，0表示直接，1表示关联，2表示链路</li> <li>controlBehavior：流控效果，0表示快速失败，1表示Warm，2表示排队等待</li> <li>clusterMode：是否集群</li></ul> <p>这样启动的时候，调用一下接口，我们的限流规则就会重新出现</p> <h1 id="_15-seata"><a href="#_15-seata" class="header-anchor">#</a> 15 seata</h1> <h2 id="_15-1-分布式事务的业务说明"><a href="#_15-1-分布式事务的业务说明" class="header-anchor">#</a> 15.1 分布式事务的业务说明</h2> <p>这里我们会创建三个微服务，一个订单服务，一个库存服务，一个账户服务。</p> <p>当用户下单时，会在订单服务中创建一个订单，然后通过远程调用库存服务来扣减下单商品的库存，在通过远程调用账户服务来扣减用户账户里面的金额，最后在订单服务修改订单状态为已完成</p> <p>该操作跨越了三个数据库，有两次远程调用，很明显会有分布式事务的问题。</p> <p>一句话：下订单 -&gt; 扣库存 -&gt; 减余额</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/SpringBoot/SpringBoot.html" class="prev">
        SpringBoot的基本使用
      </a></span> <span class="next"><a href="/分布式/分布式锁.html">
        分布式锁 应用
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.e7c2969b.js" defer></script><script src="/assets/js/2.94d3dfac.js" defer></script><script src="/assets/js/20.2c5f040e.js" defer></script>
  </body>
</html>
