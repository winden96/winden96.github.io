<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>JVM参数设置 | winden96</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="winden96 的学习记录">
    
    <link rel="preload" href="/assets/css/0.styles.4fd6cf0c.css" as="style"><link rel="preload" href="/assets/js/app.e7c2969b.js" as="script"><link rel="preload" href="/assets/js/2.94d3dfac.js" as="script"><link rel="preload" href="/assets/js/28.269bc50f.js" as="script"><link rel="prefetch" href="/assets/js/10.27cdeca9.js"><link rel="prefetch" href="/assets/js/11.07a9d483.js"><link rel="prefetch" href="/assets/js/12.2505f188.js"><link rel="prefetch" href="/assets/js/13.0d8bcb67.js"><link rel="prefetch" href="/assets/js/14.a1698ea2.js"><link rel="prefetch" href="/assets/js/15.dce506f4.js"><link rel="prefetch" href="/assets/js/16.82ab8250.js"><link rel="prefetch" href="/assets/js/17.1fa3722a.js"><link rel="prefetch" href="/assets/js/18.129b810d.js"><link rel="prefetch" href="/assets/js/19.7531d5a3.js"><link rel="prefetch" href="/assets/js/20.2c5f040e.js"><link rel="prefetch" href="/assets/js/21.635435c4.js"><link rel="prefetch" href="/assets/js/22.a44576c7.js"><link rel="prefetch" href="/assets/js/23.32ee5f65.js"><link rel="prefetch" href="/assets/js/24.109d908c.js"><link rel="prefetch" href="/assets/js/25.9ebc3e07.js"><link rel="prefetch" href="/assets/js/26.643e2283.js"><link rel="prefetch" href="/assets/js/27.44aebb00.js"><link rel="prefetch" href="/assets/js/29.5ba9d11a.js"><link rel="prefetch" href="/assets/js/3.dc23a8fe.js"><link rel="prefetch" href="/assets/js/30.be0b3d6d.js"><link rel="prefetch" href="/assets/js/31.5c853594.js"><link rel="prefetch" href="/assets/js/32.06dd5c8a.js"><link rel="prefetch" href="/assets/js/33.66017b72.js"><link rel="prefetch" href="/assets/js/4.76c25a36.js"><link rel="prefetch" href="/assets/js/5.313f4ba0.js"><link rel="prefetch" href="/assets/js/6.3db81792.js"><link rel="prefetch" href="/assets/js/7.2b7d8442.js"><link rel="prefetch" href="/assets/js/8.19d8ddaf.js"><link rel="prefetch" href="/assets/js/9.4cbab228.js">
    <link rel="stylesheet" href="/assets/css/0.styles.4fd6cf0c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">winden96</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JUC</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JVM</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>My SQL</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Mybatis Plus</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Redis</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Spring Boot</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Spring Cloud</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>分布式</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>操作系统</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>杂记</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>消息中间件</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/消息中间件/RabbitMQ.html" class="sidebar-link">RabbitMQ</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>Kafka</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/消息中间件/kafka/Kafka-介绍与使用.html" class="sidebar-link">/消息中间件/kafka/Kafka-介绍与使用.html</a></li><li><a href="/消息中间件/kafka/Kafka-原理分析.html" class="sidebar-link">生产者ACK应答机制</a></li><li><a href="/消息中间件/kafka/kafka-实践与调优.html" aria-current="page" class="active sidebar-link">JVM参数设置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/消息中间件/kafka/kafka-实践与调优.html#消息丢失" class="sidebar-link">消息丢失</a></li><li class="sidebar-sub-header"><a href="/消息中间件/kafka/kafka-实践与调优.html#消息重复生产或消费" class="sidebar-link">消息重复生产或消费</a></li><li class="sidebar-sub-header"><a href="/消息中间件/kafka/kafka-实践与调优.html#顺序消费" class="sidebar-link">顺序消费</a></li><li class="sidebar-sub-header"><a href="/消息中间件/kafka/kafka-实践与调优.html#消息乱序" class="sidebar-link">消息乱序</a></li><li class="sidebar-sub-header"><a href="/消息中间件/kafka/kafka-实践与调优.html#消息积压" class="sidebar-link">消息积压</a></li><li class="sidebar-sub-header"><a href="/消息中间件/kafka/kafka-实践与调优.html#延时队列" class="sidebar-link">延时队列</a></li><li class="sidebar-sub-header"><a href="/消息中间件/kafka/kafka-实践与调优.html#消息回溯" class="sidebar-link">消息回溯</a></li><li class="sidebar-sub-header"><a href="/消息中间件/kafka/kafka-实践与调优.html#分区数越多吞吐量越高吗" class="sidebar-link">分区数越多吞吐量越高吗</a></li></ul></li></ul></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>计算机网络</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>设计模式</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="jvm参数设置"><a href="#jvm参数设置" class="header-anchor">#</a> JVM参数设置</h1> <p>修改 bin/kafka-start-server.sh 中的 jvm 设置</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">export</span> <span class="token assign-left variable">KAFKA_HEAP_OPTS</span><span class="token operator">=</span><span class="token string">&quot;‐Xmx16G ‐Xms16G ‐Xmn12G ‐XX:MetaspaceSize=256M ‐XX:+UseG1GC ‐XX:MaxGCPauseMillis=50&quot;</span>
</code></pre></div><p>这种大内存的情况一般都要用G1垃圾收集器，因为年轻代内存比较大，用G1可以设置GC最大停顿时间，不至于一次minor gc就花费太长时间。</p> <h1 id="线上问题及优化"><a href="#线上问题及优化" class="header-anchor">#</a> 线上问题及优化</h1> <h2 id="消息丢失"><a href="#消息丢失" class="header-anchor">#</a> 消息丢失</h2> <p><strong>发送端导致</strong></p> <p>查看《Kafka-原理分析.md》中的 <strong>生产者ACK应答机制</strong> 一章</p> <p><strong>消费端导致</strong></p> <p>如果消费这边配置的是自动提交，万一消费到数据还没处理完，就自动提交offset了，但是此时你consumer直接宕机了，未处理完的数据 丢失了，下次也消费不到了。</p> <h2 id="消息重复生产或消费"><a href="#消息重复生产或消费" class="header-anchor">#</a> 消息重复生产或消费</h2> <p><strong>发送端导致</strong></p> <p><strong>发送消息如果配置了重试机制，比如网络抖动时间过长导致发送端发送超时，实际broker可能已经接收到消息只是还未来得及发送ack，但发送方会重新发送消息。</strong></p> <p><strong>消费端导致</strong></p> <p>如果消费这边配置的是自动提交，刚拉取了一批数据处理了一部分，但还没来得及提交，服务挂了，下次重启又会拉取相同的一批数据重复处理。</p> <p><strong>一般消费端都是要做消费幂等处理的。</strong></p> <p>消息重复可弄一个消息表，建立唯一索引。或者放在 redis 中。</p> <h2 id="顺序消费"><a href="#顺序消费" class="header-anchor">#</a> 顺序消费</h2> <p>kafka为了保证顺序消费，一个 partition 在一个 consumer group 中只有一个 consumer 能消费。</p> <p>Kafka只在partition的范围内保证消息消费的局部顺序性，不能在同一个topic中的多个partition中保证总的消费顺序 性。</p> <p><strong>如果有在总体上保证消费顺序的需求，那么可以通过将topic的partition数量设置为1，将consumer group中的 consumer instance数量也设置为1。</strong></p> <h2 id="消息乱序"><a href="#消息乱序" class="header-anchor">#</a> 消息乱序</h2> <p>如果<strong>发送端</strong>配置了重试机制，kafka不会等之前那条消息完全发送成功才去发送下一条消息，这样可能会出现，发送了1，2，3条消息，第一条超时了，后面两条发送成功，再重试发送第1条消息，这时消息在broker端的顺序就是2，3，1了，所以，是否一定要配置重试要根据业务情况而定。也可以用<strong>同步发送的模式</strong>去发消息，当然acks不能设置为0，这样也能有助于保证消息从发送端到消费端全链路有序。</p> <h2 id="消息积压"><a href="#消息积压" class="header-anchor">#</a> 消息积压</h2> <p>1）线上有时因为发送方发送消息速度过快，或者消费方处理消息过慢，可能会导致broker积压大量未消费消息。此种情况如果积压了上百万未消费消息需要紧急处理，处理方式：可以修改消费端程序，让其将收到的消息快速转发到其他topic，然后再启动多个消费者同时消费新主题的不同分区。</p> <p>可以进行扩容，慢慢释放消息</p> <p>2）由于消息数据格式变动或消费者程序有bug，导致消费者一直消费不成功，也可能导致broker积压大量未消费消息。此种情况可以将这些消费不成功的消息转发到其它队列里去(类似死信队列)，后面再慢慢分析死信队列里的消息处理问题。</p> <h2 id="延时队列"><a href="#延时队列" class="header-anchor">#</a> 延时队列</h2> <p>延时队列存储的对象是延时消息。所谓的“延时消息”是指消息被发送以后，并不想让消费者立刻获取，而是等待特定的时间后，消费者才能获取这个消息进行消费，延时队列的使用场景有很多， 比如 ：</p> <p>1）在订单系统中， 一个用户下单之后通常有 30 分钟的时间进行支付，如果 30 分钟之内没有支付成功，那么这个订单将进行异常处理，这时就可以使用延时队列来处理这些订单了。</p> <p>2）订单完成1小时后通知用户进行评价。</p> <p><strong>实现思路</strong>：先把消息按照不同的延迟时间段发送到指定的队列中（topic_1s，topic_5s，topic_10s，...topic_2h，这个一般不能支持任意时间段的延时），然后通过定时器进行轮训消费这些topic，查看消息中存储的发送时间戳与当前时间相比是否到期，如果到期就提交offset并把这个消息发送到具体业务处理的topic中，队列中消息越靠前的到期时间越早，具体来说就是定时器在一次消费过程中，对消息的发送时间做判断，看下是否延迟到对应时间了，如果到了就转发，如果还没到这一次定时任务就可以提前结束了。</p> <h2 id="消息回溯"><a href="#消息回溯" class="header-anchor">#</a> 消息回溯</h2> <p>如果某段时间对已消费消息计算的结果觉得有问题，可能是由于程序bug导致的计算错误，当程序bug修复后，这时可能需要对之前已消 费的消息重新消费，可以指定从多久之前的消息回溯消费，这种可以用consumer的offsetsForTimes、seek等方法指定从某个offset偏移的消息开始消费。</p> <h2 id="分区数越多吞吐量越高吗"><a href="#分区数越多吞吐量越高吗" class="header-anchor">#</a> 分区数越多吞吐量越高吗</h2> <p>从压测结果来看，分区数到达某个值吞吐量反而开始下降，实际上很多事情都会有一个临界值，当超过这个临界值之后，很多原本符合既定逻辑的走向又会变得不同。一般情况分区数跟集群机器数量相当就差不多了。</p> <p>当然吞吐量的数值和走势还会和磁盘、文件系统、 I/O调度策略等因素相关。</p> <p>注意：如果分区数设置过大，比如设置10000，可能会设置不成功，后台会报错&quot;java.io.IOException : Too many open files&quot;。异常中最关键的信息是“ Too many open flies”，这是一种常见的 Linux 系统错误，通常意味着文件描述符不足，它一般发生在创建线程、创建 Socket、打开文件这些场景下 。在 Linux系统的默认设置下，这个文件描述符的个数不是很多 ，通过 ulimit -n 命令可以查看：一般默认是1024，可以将该值增大，比如：ulimit -n 65535。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/消息中间件/kafka/Kafka-原理分析.html" class="prev">
        生产者ACK应答机制
      </a></span> <span class="next"><a href="/计算机网络/GET和POST的区别.html">
        GET和POST的区别
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.e7c2969b.js" defer></script><script src="/assets/js/2.94d3dfac.js" defer></script><script src="/assets/js/28.269bc50f.js" defer></script>
  </body>
</html>
